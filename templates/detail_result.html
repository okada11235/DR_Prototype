<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èµ°è¡Œãƒ¬ãƒãƒ¼ãƒˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{font-family:"Hiragino Sans","Meiryo",sans-serif;background:#cdeae0;margin:0;color:#333;padding:15px;padding-bottom:55px}
    .container{max-width:950px;margin:0 auto}
    .date-info{font-size:.95em;margin-bottom:15px;line-height:1.6}
    h2{color:#007e99;font-size:1.2em;margin:15px 0 10px 0}
    .score-section{margin-bottom:14px}
    .score-item{display:flex;align-items:center;margin:6px 0}
    .bar{height:10px;background:#d0d9ff;border-radius:5px;margin-left:10px;flex-grow:1;position:relative}
    .bar::after{content:"";position:absolute;top:0;left:0;height:100%;background:#5579ff;border-radius:5px}
    .score{color:red;font-weight:bold;margin-left:10px}
    .comment-box{background:#fff;border-radius:10px;padding:14px;margin:14px 0;display:flex;align-items:flex-start;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .comment-box img{width:46px;height:46px;margin-right:10px}
    .map-section{margin-top:16px;margin-bottom:10px;background:#f8fdf9;border-radius:10px;padding:10px;box-shadow:0 0 4px rgba(0,0,0,.1)}
    .map-section h3{margin:0 0 10px 5px;font-size:1.1em}
    #map{width:100%;height:380px;border-radius:10px}
    /* === ã‚°ãƒ©ãƒ•ã®é«˜ã•å®‰å®šåŒ–ï¼‹ã‚¹ãƒãƒ›å¯¾å¿œ === */
    .chart-wrap {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .chart-wrap canvas {
      width: 100% !important;
      height: 380px !important;
      max-width: 100%;
      display: block;
    }

    .chart-toolbar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 14px auto 8px;
      max-width: 360px;
    }

    /* å„æ®µ */
    .chart-toolbar .toolbar-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }

    /* Resetã ã‘ç‰¹åˆ¥ã«åºƒãä¸­å¤®ã« */
    .chart-toolbar .toolbar-row.reset button {
      flex: 1;
      min-width: 220px;
      max-width: 260px;
    }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .chart-toolbar button {
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f6f8fa;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 0.95em;
      color: #333;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 120px;
      /* âœ… é•·æŠ¼ã—å¯¾ç­– */
      user-select: none;       /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç¦æ­¢ */
      -webkit-user-select: none;
      -moz-user-select: none;
      outline: none;           /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ ã‚’å‰Šé™¤ */
      -webkit-tap-highlight-color: transparent; /* ãƒ¢ãƒã‚¤ãƒ«é’ãƒã‚¤ãƒ©ã‚¤ãƒˆé™¤å» */
    }

    .chart-toolbar button:hover {
      background: #e9ecef;
    }
    .chart-toolbar button:active {
      transform: scale(0.97);
      background: #dfe6eb;
      box-shadow: inset 0 2px 3px rgba(0,0,0,0.15);
    }

    /* ã‚¹ãƒãƒ›ç”¨ */
    @media (max-width: 600px) {
      .chart-toolbar {
        gap: 8px;
        max-width: 320px;
      }
      .chart-toolbar .toolbar-row {
        gap: 8px;
      }
      .chart-toolbar .toolbar-row.reset button {
        min-width: 200px;
      }
    }

    .legend{display:flex;flex-wrap:wrap;gap:6px;padding:8px 10px;background:#ffffffcc;border-radius:8px;margin-top:8px;font-size:.85rem;backdrop-filter:blur(4px);justify-content:flex-start}
    .legend-item{display:flex;align-items:center;margin-right:10px;margin-bottom:4px}
    .legend-color{width:20px;height:20px;border-radius:50%;margin-right:6px;border:1px solid #333}
    .warn{background:#fff3cd;color:#856404;border-radius:8px;padding:10px;text-align:center}
    .custom-nav-bar{background:#378da0;border-top:2px solid #5a7d8d;box-shadow:inset 0 0 5px rgba(0,0,0,.2);height:45px}
    .custom-nav-link{color:#fff;font-weight:bold;font-size:1rem;padding:0 1rem;line-height:41px;height:100%;display:block}
    .custom-nav-item:not(:last-child){border-right:1px solid #5a7d8d}
    .active-glow .custom-nav-link.active{color:#ccf;text-shadow:0 0 5px #7a8cff,0 0 10px #7a8cff;background:rgba(255,255,255,.05)}
    .audio-section {
      background: #f8fdf9;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .audio-section h2 {
      font-size: 1.2em;
      color: #007e99;
      margin-bottom: 10px;
    }
    .audio-item {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .top-header {
      display: flex;
      justify-content: space-between;  /* å·¦å³ã«é…ç½® */
      align-items: center;              /* â† é«˜ã•ã‚’æƒãˆã‚‹ */
      margin-bottom: 20px;
      padding: 0 5px;
    }

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆæ—¢å­˜ãƒ‡ã‚¶ã‚¤ãƒ³ã«å°‘ã—èª¿æ•´ï¼‰ */
    .back-button {
      display: inline-block;
      background-color: #00bcd4;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-size: 0.95em;               /* â† æ—¥ä»˜ã¨é«˜ã•ã‚’åˆã‚ã›ã‚‹ */
    }

    .back-button:hover {
      background-color: #0097a7;
      transform: translateY(-1px);
    }

    .back-button:active {
      background-color: #00838f;
      transform: translateY(0);
    }

    /* æ—¥ä»˜æƒ…å ±ã‚’å³å¯„ã›ã« */
    .date-info {
      text-align: right;
      font-size: 0.95em;
      line-height: 1.4;
      color: #333;
    }

    .robot {
      width: 70px;
      height: auto;
      border-radius: 50%;
      object-fit: cover;
      background-color: #fff;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="top-header">
    <a id="back-button" href="{{ url_for('sessions.results_page') }}" class="back-button">
      â† æˆ»ã‚‹
    </a>
    {% if display_error %}
      <div class="warn">{{ display_error }}</div>
    {% else %}
      <div class="date-info">
        <strong>{{ session.start_time.strftime('%Y/%m/%d') if session.start_time else '' }}</strong><br>
        {{ session.start_time.strftime('%H:%M') if session.start_time else '??:??' }}
        ã€œ
        {{ session.end_time.strftime('%H:%M') if session.end_time else 'è¨˜éŒ²ä¸­' }}<br>
        èµ°è¡Œè·é›¢ï¼š{{ "%.2f"|format(session.distance) if session.distance is not none else "N/A" }} km
      </div>
  </div>

  <!-- === ç·åˆã‚¹ã‚³ã‚¢è¡¨ç¤º === -->
  <div class="section" style="margin-top: 10px; margin-bottom: 10px;">
    <h2>ğŸ“Š ç·åˆã‚¹ã‚³ã‚¢</h2>
    <div style="font-size: 1.2em; font-weight: bold; color: #2a7;">
      {{ session.overall_score if session.overall_score is not none else "N/A" }} ç‚¹
    </div>

    {% if session.score_comment %}
      <div style="margin-top: 6px; color: #444; font-size: 0.95em;">
        {{ session.score_comment }}
      </div>
    {% endif %}
  </div>

  <!-- === é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ === -->
  <div class="section" id="feedback-section">
    <h2><img src="{{ url_for('static', filename='img/robot_side.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot"> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
    <div id="focus-feedback-list">
      <p>AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- âœ… Firebase SDKã®èª­ã¿è¾¼ã¿ã¯å¿…ãšã“ã“ã§ script ã‚¿ã‚°ã§è¡Œã†ï¼ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getRatingBadge(rating) {
      switch (rating) {
        case "ã¨ã¦ã‚‚ã„ã„": return `<span class="rating-badge rating-verygood">ğŸ˜ ã¨ã¦ã‚‚ã„ã„</span>`;
        case "ã„ã„": return `<span class="rating-badge rating-good">ğŸ˜Š ã„ã„</span>`;
        case "ãµã¤ã†": return `<span class="rating-badge rating-normal">ğŸ˜ ãµã¤ã†</span>`;
        case "ã‚ã‚‹ã„": return `<span class="rating-badge rating-bad">ğŸ˜¢ ã‚ã‚‹ã„</span>`;
        default: return `<span class="rating-badge rating-none">æœªè©•ä¾¡</span>`;
      }
    }

    function loadFocusFeedbacks(sessionId) {
      const listDiv = document.getElementById("focus-feedback-list");

      db.collection("sessions").doc(sessionId)
        .collection("focus_feedbacks")
        .orderBy("created_at", "desc")
        .onSnapshot(snapshot => {
          listDiv.innerHTML = "";

          if (snapshot.empty) {
            listDiv.innerHTML = "<p style='color:#777;'>ğŸš§ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
            return;
          }

          snapshot.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;  // âœ… â† ã“ã‚Œã‚’è¿½åŠ ï¼é‡è¦ï¼ï¼

            const badge = getRatingBadge(d.rating);
            const div = document.createElement("div");
            div.className = "pin-feedback";

            div.innerHTML = `
              <div class="pin-label">ğŸ“ ${d.pin_label || "(ãƒ©ãƒ™ãƒ«ãªã—)"} ${badge}</div>
              <div style="margin-left:1.2em;color:#00796b;font-size:0.95em;">
                ğŸ¯ ${d.focus_label || "æ„è­˜ãƒã‚¤ãƒ³ãƒˆæœªè¨­å®š"}
                <span style="margin-left:10px;color:#2090c2;font-weight:bold;">
                  ${d.score !== undefined ? `ğŸŸ¢ ${d.score}ç‚¹` : ""}
                </span>
              </div>
              <div class="pin-comment">
                ğŸ’¬ ${(d.short_comment || "ã‚³ãƒ¡ãƒ³ãƒˆãªã—").replace(/\n/g, "<br>")}
                <div style="text-align:right;margin-top:4px;">
                  <a href="/feedback_detail_result/${sessionId}/${d.id}"
                    style="color:#007bff;font-size:0.9em;text-decoration:none;">
                    â¡ è©³ç´°ã‚’è¦‹ã‚‹
                  </a>
                </div>
              </div>
            `;

            listDiv.appendChild(div);

            // ğŸ” ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆç¢ºèªç”¨ï¼‰
            console.log("ğŸ¯ session:", sessionId, "pin_id:", d.id);
          });
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sessionId = "{{ session.id }}";
      if (sessionId) loadFocusFeedbacks(sessionId);
    });
  </script>

  <style>
    .section {
      background-color: #fff;
      border-radius: 8px;
      margin: 15px auto;
      padding: 15px 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      width: 100%;
      text-align: left;
    }
    .section h2 {
      font-size: 1.3em;
      color: #2090c2;
      margin-bottom: 8px;
      border-bottom: 2px solid #a5dbe0;
      padding-bottom: 4px;
    }
    .pin-feedback {
      background: #f5fbfd;
      border-left: 5px solid #4db6ac;
      padding: 10px 12px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .pin-label {
      font-weight: bold;
      color: #007c91;
      font-size: 1.05em;
    }
    .pin-comment {
      margin-top: 4px;
      color: #333;
    }
    .rating-badge {
      display: inline-block;
      font-weight: bold;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.85em;
      margin-left: 6px;
    }
    .rating-good { background: #b3e5fc; color: #0277bd; }
    .rating-verygood { background: #c8e6c9; color: #2e7d32; }
    .rating-normal { background: #fff9c4; color: #795548; }
    .rating-bad { background: #ffcdd2; color: #c62828; }
    .rating-none { background: #e0e0e0; color: #555; }
  </style>

    <!-- ====== ã‚°ãƒ©ãƒ• ====== -->
    <div class="chart-wrap">
      <h2>GåŠ é€Ÿåº¦ï¼†é€Ÿåº¦ã‚°ãƒ©ãƒ•</h2>
      <canvas id="gForceChart-{{ session.id }}" style="width:100%;height:380px"></canvas>
      <div class="chart-toolbar">
        <div class="toolbar-row">
          <button onmousedown="startZoom('gForceChart-{{ session.id }}','in')" 
                  onmouseup="stopZoom()" onmouseleave="stopZoom()" 
                  ontouchstart="startZoom('gForceChart-{{ session.id }}','in')" 
                  ontouchend="stopZoom()">ï¼‹ Zoom In</button>

          <button onmousedown="startZoom('gForceChart-{{ session.id }}','out')" 
                  onmouseup="stopZoom()" onmouseleave="stopZoom()" 
                  ontouchstart="startZoom('gForceChart-{{ session.id }}','out')" 
                  ontouchend="stopZoom()">ï¼ Zoom Out</button>
        </div>

        <div class="row reset">
          <button onclick="resetChartZoom('gForceChart-{{ session.id }}')">Reset</button>
        </div>

        <div class="row">
          <button onmousedown="startPan('gForceChart-{{ session.id }}','right')" 
                  onmouseup="stopPan()" onmouseleave="stopPan()" 
                  ontouchstart="startPan('gForceChart-{{ session.id }}','right')" 
                  ontouchend="stopPan()">â—€ å·¦ã¸</button>

          <button onmousedown="startPan('gForceChart-{{ session.id }}','left')" 
                  onmouseup="stopPan()" onmouseleave="stopPan()" 
                  ontouchstart="startPan('gForceChart-{{ session.id }}','left')" 
                  ontouchend="stopPan()">å³ã¸ â–¶</button>
        </div>
      </div>
    </div>

    <!-- ====== åœ°å›³ ====== -->
    <div class="map-section">
      <h2>èµ°è¡Œãƒ«ãƒ¼ãƒˆã¨ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
      <h3>ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã®åœ°ç‚¹ã®Gã®å¤‰å‹•ã‚’è¦‹ãŸã‚Šã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ãƒ»é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¨­ç½®ã—ãŸã‚Šã—ã‚ˆã†ï¼<img src="{{ url_for('static', filename='img/robot_turnleft.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot"></h3>
      <div id="map"></div>
      <div class="legend" id="legend"></div>
    </div>
  {% endif %}

  <div class="text-center mt-3">
    <a class="btn btn-primary btn-lg"
      href="{{ url_for('views.detail_result_play', session_id=session.id) }}">
      ğŸš— ã“ã®èµ°è¡Œã‚’â€œã‚¤ãƒ™ãƒ³ãƒˆéŸ³å£°ã¤ãâ€ã§å†ç”Ÿ
    </a>
  </div>

    <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
        <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item">
            <a href="{{ url_for('views.home') }}" class="nav-link custom-nav-link">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
            <a href="{{ url_for('views.recording_start') }}" class="nav-link custom-nav-link">é‹è»¢</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
            <a class="nav-link custom-nav-link active" href="{{ url_for('sessions.results_page') }}">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item border-end-0">
      <a class="nav-link custom-nav-link" href="{{ url_for('views.explain') }}">èª¬æ˜</a>
        </li>
        </ul>
    </div>
    </nav>

    <!-- ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div class="modal fade" id="markerOptionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">ã“ã®åœ°ç‚¹ã§ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <button class="btn btn-primary w-100 mb-2" id="manual-pin-btn">
              ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’è¨­ç½®
            </button>
            <button class="btn btn-success w-100 mb-2" id="priority-pin-btn">
              â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
            </button>
            <button class="btn btn-secondary w-100" id="zoom-graph-btn">
              ğŸ“ˆ ã‚°ãƒ©ãƒ•ã‚’æ‹¡å¤§
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- ãƒ”ãƒ³è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="pinModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³è¨­å®š</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body" style="font-size:14px;">
            
            <!-- ãƒ¡ãƒ¢ -->
            <div class="mb-3">
              <label class="form-label">ãƒ¡ãƒ¢</label>
              <input type="text" id="pin-label" class="form-control">
            </div>

            <!-- èª­ã¿ä¸Šã’ -->
            <div class="mb-3">
              <label class="form-label">èª­ã¿ä¸Šã’</label>
              <input type="checkbox" id="pin-speak">
            </div>

            <!-- ãƒ¬ãƒ™ãƒ« -->
            <div class="mb-3">
              <label class="form-label">ãƒ¬ãƒ™ãƒ«</label>
              <select id="pin-level" class="form-select">
                <option value="1">1 (ã‚ªãƒ¬ãƒ³ã‚¸)</option>
                <option value="2">2 (ç´«)</option>
                <option value="3">3 (èµ¤)</option>
              </select>
            </div>

            <!-- æ™‚é–“å¸¯ -->
            <div class="mb-3">
              <label class="form-label">æ™‚é–“å¸¯</label>
              <div class="d-flex">
                <input type="time" id="pin-start-time" class="form-control" style="width:120px;">
                <span class="mx-2">ã€œ</span>
                <input type="time" id="pin-end-time" class="form-control" style="width:120px;">
              </div>
            </div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="pin-save-btn" class="btn btn-primary">ä¿å­˜</button>
          </div>

        </div>
      </div>
    </div>

<!-- ===== ãƒ©ã‚¤ãƒ–ãƒ©ãƒª ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


<script>
/** ========= ãƒ‡ãƒ¼ã‚¿ ========= */
const gpsLogs = {{ gps_logs|tojson }};
const gLogs   = {{ avg_g_logs|tojson }};

<!-- ğŸŸ¥ã€è¿½åŠ â‘ ï¼šæ—¢å­˜ãƒ”ãƒ³ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ã‚³ãƒ¼ãƒ‰ã€‘ -->
let existingPins = [];

// Firestore ã‹ã‚‰æ—¢å­˜ãƒ”ãƒ³ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰
async function loadExistingPins() {
  try {
    const manualRes = await fetch("/api/get_pins");
    const manualData = await manualRes.json();

    const priorityRes = await fetch("/api/get_priority_pins");
    const priorityData = await priorityRes.json();

    existingPins = [
      ...(manualData.pins || []),
      ...(priorityData.pins || [])
    ];

    console.log("ğŸ“æ—¢å­˜ãƒ”ãƒ³èª­ã¿è¾¼ã¿ï¼ˆmanual + priorityï¼‰", existingPins);

  } catch (e) {
    console.error("âŒ ãƒ”ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
  }
}

// Google Maps ã®è·é›¢è¨ˆç®—
function distanceM(lat1, lng1, lat2, lng2) {
  return google.maps.geometry.spherical.computeDistanceBetween(
    new google.maps.LatLng(lat1, lng1),
    new google.maps.LatLng(lat2, lng2)
  );
}

// (0,0) ã®ç„¡åŠ¹åº§æ¨™ã‚’æç”»ã‹ã‚‰é™¤å¤–
const displayGpsLogs = (gpsLogs || []).filter(l => !(Number(l.latitude) === 0 && Number(l.longitude) === 0));

/** ========= ã‚«ãƒ©ãƒ¼ï¼†ã‚¤ãƒ™ãƒ³ãƒˆè»¸ ========= */
const colorMap = {
  sudden_brake:'#ff3b30',  // èµ¤
  sudden_accel:'#189900',  // ç·‘
  sharp_turn  :'#ff9500',  // ã‚ªãƒ¬ãƒ³ã‚¸
  //unstable_drive:'#ffcc00',// é»„
  excellent_turn :'#007aff',  // é’
  smooth_turn :'#007aff',
  normal_turn :'#007aff',
  excellent_accel:'#8e44ad',  // æ¿ƒã„ç´«
  smooth_accel:'#9b59b6',     // ç´«
  normal_accel:'#b07cc6',     // è–„ã„ç´«
  excellent_brake:'#a0efa5',  // æ˜ã‚‹ã„ç·‘
  smooth_brake:'#a0efa5',
  normal_brake:'#a0efa5',
  //stable_drive:'#a88ee5',  // ç´«
};

const borderLevelMap = {
  normal:   "#000000",
  smooth:   "#f7f700",
  excellent:"#f70000",
};

const eventAxisMap = { sudden_brake:'gz', sudden_accel:'gz', sharp_turn:'gx', speed_violation:'speed' };

/** ========= Chart.js åˆæœŸåŒ– ========= */
let isChartReady = false;
const chartInstances = {};          // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«1å›ã ã‘å®šç¾©
const chartOriginalRanges = {};     // â† åˆæœŸç¯„å›²ã‚’ä¿å­˜
let zoomInterval = null;
let panInterval = null;

function initializeChart(){
  if(typeof Chart!=='undefined' && !isChartReady){
    try{
      if(Chart.registerables){
        if(Array.isArray(Chart.registerables)) Chart.register(...Chart.registerables);
        else if (typeof Chart.registerables[Symbol.iterator] === 'function') Chart.register(...Chart.registerables);
      }
      if(typeof zoomPlugin!=='undefined') Chart.register(zoomPlugin);
      else if (window.ChartZoom) Chart.register(window.ChartZoom.default||window.ChartZoom);
      isChartReady=true;
    }catch(e){ console.error('Chart.js init error:',e); }
  }
}
document.addEventListener('DOMContentLoaded', initializeChart);

/** ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function findLogByTimestamp(logs, ts, maxDiffMs=500){
  let closest=null, min=Infinity;
  for(const log of logs){
    const t=Number(log.timestamp_ms ?? log.timestamp);
    if(Number.isNaN(t)) continue;
    const diff=Math.abs(t-ts);
    if(diff<min){ min=diff; closest=log; }
  }
  return (min<=maxDiffMs)? closest : null;
}
function makeEventPoints(allTs, gpsLogs, axisKey) {
  return {
    radius: allTs.map(ts => {
      const log = findLogByTimestamp(gpsLogs, ts, 500);
      if (!log || !log.event || log.event === 'normal') return 0;

      if (axisKey === 'speed') return 8;
      if (eventAxisMap[log.event] === axisKey) return 8;
      return 0;
    }),

    background: allTs.map(ts => {
      const log = findLogByTimestamp(gpsLogs, ts, 500);
      if (!log || !log.event || log.event === 'normal') return 'transparent';

      const color = colorMap[log.event] || 'gray';
      return color;
    }),

    border: allTs.map(ts => {
      const log = findLogByTimestamp(gpsLogs, ts, 500);
      if (!log || !log.event || log.event === 'normal') return 'transparent';

      const level = getEventLevel(log.event);
      return borderLevelMap[level];   // â† â˜…æ ç·šè‰²ã‚’åæ˜ 
    })
  };
}


/** ========= ã‚°ãƒ©ãƒ•æç”» ========= */
function renderGForceChart(canvasId, gpsLogs, gLogs){
  if(!gLogs || gLogs.length===0){
    const wrap=document.getElementById(canvasId)?.closest('.chart-wrap');
    if(wrap){ wrap.insertAdjacentHTML('beforeend', `<div class="warn mt-2">Gã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`); }
    return;
  }

  const allTimestamps=[...new Set([
    ...gLogs.map(l=>Number(l.timestamp_ms ?? l.timestamp)).filter(n=>!Number.isNaN(n)),
    ...gpsLogs.map(l=>Number(l.timestamp_ms ?? l.timestamp)).filter(n=>!Number.isNaN(n)),
  ])].sort((a,b)=>a-b);
  const labels = allTimestamps.map(ts => new Date(ts));

  function align(logs,key){
    const map=new Map(logs.map(l=>[Number(l.timestamp_ms ?? l.timestamp), l[key]]));
    return allTimestamps.map(ts=>{
      const v=map.get(ts);
      return (v!==undefined && v!==null) ? Number(v) : null;
    });
  }

  const gxData=align(gLogs,"g_x");
  const gyData=align(gLogs,"g_y");
  const gzData=align(gLogs,"g_z");
  const speedData=align(displayGpsLogs,"speed");

  const gxPts=makeEventPoints(allTimestamps,displayGpsLogs,'gx');
  const gyPts=makeEventPoints(allTimestamps,displayGpsLogs,'gy');
  const gzPts=makeEventPoints(allTimestamps,displayGpsLogs,'gz');
  const spPts=makeEventPoints(allTimestamps,displayGpsLogs,'speed');

  const ctx=document.getElementById(canvasId).getContext('2d');
  const chart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'å‰å¾ŒG', data:gzData, borderColor:'#00bcd4', backgroundColor:'rgba(0,188,212,0.2)', borderWidth:2, yAxisID:'y', tension:0.4, spanGaps:true, pointRadius:gzPts.radius, pointBackgroundColor:gzPts.background, pointBorderColor:gzPts.border, pointRadius:0 },
        { label:'ä¸Šä¸‹G', data:gyData, borderColor:'#666', backgroundColor:'rgba(102,102,102,0.2)', borderWidth:2, yAxisID:'y', tension:0.4, spanGaps:true, pointRadius:gyPts.radius, pointBackgroundColor:gyPts.background, pointBorderColor:gyPts.border, pointRadius:0 },
        { label:'å·¦å³G', data:gxData, borderColor:'#9c27b0', backgroundColor:'rgba(156,39,176,0.2)', borderWidth:2, yAxisID:'y', tension:0.4, spanGaps:true, pointRadius:gxPts.radius, pointBackgroundColor:gxPts.background, pointBorderColor:gxPts.border, pointRadius:0 },
        { label:'é€Ÿåº¦ (km/h)', data:speedData, borderColor:'rgba(255,99,132,0.7)', backgroundColor:'rgba(255,99,132,0.1)', borderWidth:1, yAxisID:'y1', tension:0, spanGaps:true,
          pointStyle: ctx => (spPts.radius[ctx.dataIndex] > 0 ? 'circle' : false),
          pointRadius: ctx => spPts.radius[ctx.dataIndex],
          pointBackgroundColor: ctx => spPts.background[ctx.dataIndex],
          pointBorderColor: ctx => spPts.border[ctx.dataIndex],
          pointBorderWidth: 3, }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      elements:{ line:{ cubicInterpolationMode:'monotone' } },
      scales:{
        x: {
          type: 'time',
          time: { unit: false },
          title: { display: true, text: 'æ™‚é–“' },
          min: labels[0],
          max: labels[labels.length - 1], // â† âœ… åˆæœŸç¯„å›²ã‚’ç¢ºå®š
        },
        y:{ position:'left', title:{display:true,text:'G (é‡åŠ›åŠ é€Ÿåº¦)'} },
        y1:{ position:'right', title:{display:true,text:'é€Ÿåº¦ (km/h)'}, grid:{drawOnChartArea:false}, min:0, max:120 }
      },
      plugins:{
        decimation:{ enabled:true, algorithm:'lttb', samples:1000 },
        zoom:{
          pan:{enabled:true,mode:'x'},
          zoom:{
            wheel:{enabled:true},
            pinch:{enabled:true},
            mode:'x',
            limits:{  // â† âœ… ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆåˆ¶é™ã‚’è¿½åŠ 
              x:{min: labels[0].getTime(), max: labels[labels.length - 1].getTime()}
            }
          }
        },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const idx=ctx.dataIndex;
              const raw=Number(ctx.raw);
              const val=Number.isFinite(raw)? raw.toFixed(2) : 'â€”';
              let unit= ctx.dataset.label.includes('é€Ÿåº¦') ? ' km/h' : ' G';
              let label=`${ctx.dataset.label}: ${val}${unit}`;
              const ts=allTimestamps[idx];
              const log=displayGpsLogs.find(l => Number(l.timestamp_ms ?? l.timestamp)===ts);
              if(log && log.event && log.event!=='normal'){
                label += `  (ã‚¤ãƒ™ãƒ³ãƒˆ: ${String(log.event).replace(/_/g,' ')})`;
              }
              return label;
            }
          }
        }
      }
    }
  });

  chartInstances[canvasId] = chart;

  // âœ… åˆæœŸç¯„å›²ã‚’ä¿å­˜ï¼ˆDateå‹ã®ã¾ã¾ï¼‰
  chartOriginalRanges[canvasId] = {
    min: labels[0],
    max: labels[labels.length - 1]
  };
}

/** ========= ã‚°ãƒ©ãƒ•â†â†’åœ°å›³ é€£å‹• ========= */
function highlightOnChart(canvasId, log) {
  const chart = chartInstances[canvasId];
  if (!chart) return;

  const ts = Number(log.timestamp_ms ?? log.timestamp);
  if (isNaN(ts)) return;

  const focusStart = ts - 3000;
  const focusEnd   = ts + 3000;

  chart.options.scales.x.min = new Date(focusStart);
  chart.options.scales.x.max = new Date(focusEnd);
  chart.update('none');

  // ãƒ©ãƒ™ãƒ«ãŒDateå‹ã§ã‚ã‚Œã°ã“ã‚Œã§OK
  const idx = chart.data.labels.findIndex(
    label => Math.abs(label.getTime() - ts) < 500
  );
  if (idx >= 0) {
    chart.setActiveElements([{ datasetIndex: 0, index: idx }]);
    chart.tooltip.setActiveElements([{ datasetIndex: 0, index: idx }]);
    chart.update();
  }
}

/** ========= ã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³ ãƒœã‚¿ãƒ³ ========= */
// æ—¢å­˜ã® startZoom é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£:
function startZoom(canvasId, dir) {
  const chart = chartInstances[canvasId];
  if (!chart) return;
  const factor = 1.05;
  const original = chartOriginalRanges[canvasId];

  zoomInterval = setInterval(() => {
    chart.zoom({ x: dir === 'in' ? factor : 1 / factor, y: 1 });

    // ğŸ‘‡ ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆåˆ¶é™ï¼ˆãƒ‡ãƒ¼ã‚¿å…¨ä½“ã®ç¯„å›²å¤–ã«è¡Œã‹ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    if (original) {
      // **ä¿®æ­£: æ¯”è¼ƒã‚’æ•°å€¤ã«çµ±ä¸€**
      if (chart.scales.x.min < original.min.getTime()) chart.options.scales.x.min = original.min;
      if (chart.scales.x.max > original.max.getTime()) chart.options.scales.x.max = original.max;
    }

    chart.update('none');
  }, 150);
}
function stopZoom() {
  if (zoomInterval) {
    clearInterval(zoomInterval);
    zoomInterval = null;
  }
}
function startPan(canvasId, dir) {
  const chart = chartInstances[canvasId];
  if (!chart) return;
  const distance = dir === 'left' ? -50 : 50;
  panInterval = setInterval(() => {
    chart.pan({ x: distance, y: 0 });
  }, 100);
}
function stopPan() {
  if (panInterval) {
    clearInterval(panInterval);
    panInterval = null;
  }
}

/** âœ… ä¿®æ­£ç‰ˆï¼šResetãƒœã‚¿ãƒ³ã§ã‚ºãƒ¼ãƒ å‰ç¯„å›²ã«æˆ»ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢ */
function resetChartZoom(canvasId) {
  const chart = chartInstances[canvasId];
  if (!chart) return;
  const original = chartOriginalRanges[canvasId];

  // 1. Zoomãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  chart.resetZoom(); 
  
  if (original) {
    // 2. ã‚¤ãƒ™ãƒ³ãƒˆæŒ‡å®šã§ä¸Šæ›¸ãã•ã‚ŒãŸ min/max ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆæœŸå€¤ã«æˆ»ã™
    chart.options.scales.x.min = original.min; 
    chart.options.scales.x.max = original.max;
  }
  
  // 3. ã€**æ–°è¦è¿½åŠ **ã€‘ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆï¼‰ã¨ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
  // ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠå¾Œã®ã€Œé‡ãªã‚Šã€è¡¨ç¤ºã‚’è§£æ¶ˆã—ã¾ã™ã€‚
  chart.setActiveElements([]);
  if (chart.tooltip) {
    chart.tooltip.setActiveElements([]);
  }

  // 4. ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
  chart.update('none'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§å³æ™‚æ›´æ–°
}

function getEventLevel(eventName) {
  if (eventName.startsWith("excellent")) return "excellent";
  if (eventName.startsWith("smooth")) return "smooth";
  return "normal";
}

// ğŸŸ¥ã€è¿½åŠ â‘¡ï¼šãƒ”ãƒ³è¨­ç½®/ç·¨é›†/ã‚°ãƒ©ãƒ•æ‹¡å¤§ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã€‘
// æ—¢å­˜ãƒ”ãƒ³ç·¨é›†
async function openPinEditModal(pin) {
  const newLabel = prompt("ãƒ”ãƒ³ã®ãƒ¡ãƒ¢ã‚’ç·¨é›†:", pin.label || "");
  if (newLabel === null) return;

  const res = await fetch("/api/update_pin", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      id: pin.id,
      label: newLabel,
      speak_enabled: pin.speak_enabled ?? true
    })
  });

  const result = await res.json();
  if (result.status === "success") {
    alert("ãƒ”ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    await loadExistingPins();
  }
}

const CURRENT_ROUTE_ID = "{{ route_id }}";

async function openPriorityPinModal(pin) {

  const focusList = [
    { key: "brake_soft",        label: "ç©ã‚„ã‹ãªæ¸›é€Ÿ" },
    { key: "accel_smooth",      label: "æ»‘ã‚‰ã‹ãªç™ºé€²" },
    { key: "turn_stability",    label: "ã‚«ãƒ¼ãƒ–ã®å®‰å®šæ€§" },
    { key: "smooth_overall",    label: "ç›´é€²ã®å®‰å®šæ€§" },
    { key: "stop_smooth",       label: "åœæ­¢ç›´å‰ã®æ»‘ã‚‰ã‹ã•" },
    { key: "speed_consistency", label: "ä¸€å®šé€Ÿåº¦ã®ç¶­æŒ" }
  ];

  // --- ãƒ©ãƒ™ãƒ«å…¥åŠ› ---
  const newLabel = prompt(
    "é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã®ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š",
    pin.label || ""
  );
  if (newLabel === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

  // --- ç•ªå·é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ§‹ç¯‰ ---
  let menu = "æ„è­˜ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ï¼š\n";
  focusList.forEach((f, i) => {
    menu += `${i + 1}. ${f.label}\n`;
  });

  const num = prompt(menu, "1");
  if (num === null) return;

  const index = Number(num) - 1;
  if (index < 0 || index >= focusList.length) {
    alert("ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const selected = focusList[index];

  // --- æ–°è¦ or æ›´æ–° ã®åˆ†å² ---
  if (!pin.id) {
    // ======================
    //   ğŸ†• æ–°è¦è¿½åŠ 
    // ======================
    const payload = {
      lat: pin.lat,
      lng: pin.lng,
      label: newLabel,
      focus_type: selected.key,
      focus_label: selected.label,
      route_id: CURRENT_ROUTE_ID,   // â† â˜…é‡è¦ï¼
      created_at: new Date(),
    };

    const res = await fetch("/api/add_priority_pin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.status === "success") {
      alert("é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
      loadExistingPins(); 
    } else {
      alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + data.error);
    }

  } else {
    // ======================
    //   âœ ç·¨é›†
    // ======================
    firebase.firestore().collection("priority_pins").doc(pin.id).update({
      label: newLabel,
      focus_type: selected.key,
      focus_label: selected.label
    }).then(() => {
      alert("é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
      loadExistingPins();
    }).catch(err => {
      console.error(err);
      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });
  }
}

// æ–°è¦ãƒ”ãƒ³è¨­ç½®
async function createPinAt(lat, lng) {
  const label = prompt("ãƒ”ãƒ³ã®ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰:");
  if (label === null) return;

  const res = await fetch("/api/save_pin", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ lat, lng, label })
  });

  const result = await res.json();
  if (result.status === "success") {
    alert("ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    await loadExistingPins();
  }
}

let editingPriorityPin = null;
let editingManualPin = null;

let editingPin = null;
let editingPos = null;

function openPinModal(pin, lat, lng) {
  editingPin = pin || null;
  editingPos = { lat, lng };

  document.getElementById("pin-label").value = pin?.label ?? "";
  document.getElementById("pin-speak").checked = pin?.speak_enabled ?? true;
  document.getElementById("pin-level").value = pin?.priority_level ?? 1;

  document.getElementById("pin-start-time").value = pin?.start_time ?? "";
  document.getElementById("pin-end-time").value = pin?.end_time ?? "";

  new bootstrap.Modal(document.getElementById("pinModal")).show();
}

document.getElementById("pin-save-btn").onclick = async () => {

  const payload = {
    lat: editingPos.lat,
    lng: editingPos.lng,
    label: document.getElementById("pin-label").value,
    speak_enabled: document.getElementById("pin-speak").checked,
    priority_level: Number(document.getElementById("pin-level").value),
    speak_time_windows: [
      {
        start: document.getElementById("pin-start-time").value,
        end: document.getElementById("pin-end-time").value,
      }
    ]
  };

  let url = "/api/add_manual_pin";

  if (editingPin?.id) {
    url = "/api/update_pin";
    payload.id = editingPin.id;
  }

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  if (data.status === "success") {
    location.reload();
  } else {
    alert("ä¿å­˜å¤±æ•—: " + data.error);
  }
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ¯ã‚Šåˆ†ã‘
async function handleEventMarkerClick(log, marker) {
  const lat = log.latitude;
  const lng = log.longitude;

  // ğŸ” 10mä»¥å†…ã«æ—¢å­˜ãƒ”ãƒ³ãŒã‚ã‚‹ã‹
  const existed = existingPins.find(
    p => distanceM(lat, lng, p.lat, p.lng) < 10
  );

  if (existed) {
    if (existed.route_id) {
      // â˜… priority pin
      document.getElementById("priority-pin-btn").innerText = "â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’ç·¨é›†";
      document.getElementById("manual-pin-btn").innerText = "ğŸ“ æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’è¨­ç½®";
      editingPriorityPin = existed;
      editingManualPin = null;
    } else {
      // â˜… manual pin
      document.getElementById("manual-pin-btn").innerText = "ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’ç·¨é›†";
      document.getElementById("priority-pin-btn").innerText = "â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ";
      editingManualPin = existed;
      editingPriorityPin = null;
    }
  } else {
    // ãƒ”ãƒ³ãªã—
    editingManualPin = null;
    editingPriorityPin = null;
  }
}

/** ========= åœ°å›³ ========= */
let mapInstance=null;
function initMap(){
  const mapEl=document.getElementById('map');
  if(!displayGpsLogs || displayGpsLogs.length===0){
    mapEl.insertAdjacentHTML('beforebegin', `<div class="warn">GPSãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`);
    return;
  }
  const path=displayGpsLogs.map(l=>({lat:l.latitude,lng:l.longitude}));
  mapInstance = new google.maps.Map(mapEl,{ zoom:15, center:path[0] });
  const poly=new google.maps.Polyline({ path, geodesic:true, strokeColor:'#007bff', strokeOpacity:1.0, strokeWeight:4 });
  poly.setMap(mapInstance);

  loadExistingPins(); // ğŸŸ¥ã“ã‚Œã‚’è¿½åŠ ï¼

  // æ—¥æœ¬èªãƒ©ãƒ™ãƒ«å¯¾å¿œãƒãƒƒãƒ—
  const labelMap = {
    sudden_brake: 'æ€¥æ¸›é€Ÿ',
    sudden_accel: 'æ€¥ç™ºé€²',
    sharp_turn: 'æ€¥æ—‹å›',
    //unstable_drive: 'ä¸å®‰å®šãªé‹è»¢',
    excellent_turn: 'ã¨ã¦ã‚‚ã„ã„æ—‹å›',
    smooth_turn: 'ã„ã„æ—‹å›',
    normal_turn: 'æ™®é€šã®æ—‹å›',
    excellent_accel: 'ã¨ã¦ã‚‚ã„ã„åŠ é€Ÿ',
    smooth_accel: 'ã„ã„åŠ é€Ÿ',
    normal_accel: 'æ™®é€šã®åŠ é€Ÿ',
    excellent_brake: 'ã¨ã¦ã‚‚ã„ã„æ¸›é€Ÿ',
    smooth_brake: 'ã„ã„æ¸›é€Ÿ',
    normal_brake: 'æ™®é€šã®æ¸›é€Ÿ',
    //stable_drive: 'å®‰å®šã—ãŸé‹è»¢'
  };
  // å‡¡ä¾‹
  const legend=document.getElementById('legend');
  legend.innerHTML = Object.entries(colorMap).map(([k, c]) => {
    const level = getEventLevel(k);              // â† ãƒ¬ãƒ™ãƒ«åˆ¤å®š
    const border = borderLevelMap[level];        // â† æ ã®è‰²ã‚’å–å¾—

    return `
      <div class="legend-item">
        <span class="legend-color"
              style="background:${c}; border: 3px solid ${border}"></span>
        <span>${labelMap[k] || k}</span>
      </div>
    `;
  }).join('');

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼
  console.log('=== ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼æç”»é–‹å§‹ ===');
  console.log('displayGpsLogsä»¶æ•°:', displayGpsLogs.length);
  
  let eventCount = 0;
  displayGpsLogs.forEach(log=>{
    if(log.event && log.event!=='normal'){
      eventCount++;
      console.log(`ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡º #${eventCount}:`, log.event, 'at', log.latitude, log.longitude);
      
      const color=colorMap[log.event]||'gray';
      const level = getEventLevel(log.event);
      const marker=new google.maps.Marker({
        position:{lat:log.latitude,lng:log.longitude},
        map: mapInstance,
        icon:{
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: color, fillOpacity: .9,
          strokeColor: borderLevelMap[level],
          strokeWeight: 3, 
        },
        title: String(log.event).replace(/_/g,' ')
      });
      marker.addListener("click", () => {

        selectedLog = log;
        selectedLat = log.latitude;
        selectedLng = log.longitude;

        // ğŸ” 10mä»¥å†…ã«æ—¢å­˜ãƒ”ãƒ³ãŒã‚ã‚‹ã‹åˆ¤å®š
        const existed = existingPins.find(p =>
          distanceM(selectedLat, selectedLng, p.lat, p.lng) < 10
        );

        if (existed) {
          // ====== æ—¢å­˜ãƒ”ãƒ³ã‚ã‚Š â†’ ç¨®é¡ã‚’åˆ¤å®š ======
          const isPriority = !!existed.route_id;   // â† â˜…priority ã®åˆ¤å®šï¼

          document.getElementById("manual-pin-btn").innerText =
            isPriority ? "ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’è¨­ç½®ï¼ˆåˆ¥ã®ãƒ”ãƒ³ï¼‰" : "ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’ç·¨é›†";

          document.getElementById("priority-pin-btn").innerText =
            isPriority ? "â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’ç·¨é›†" : "â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ";

          editingPin = existed;

        } else {
          // ====== ãƒ”ãƒ³ãªã— â†’ æ–°è¦è¿½åŠ  ======
          document.getElementById("manual-pin-btn").innerText = "ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³ã‚’è¨­ç½®";
          document.getElementById("priority-pin-btn").innerText = "â­ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ";
          editingPin = null;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        const modal = new bootstrap.Modal(
          document.getElementById("markerOptionModal")
        );
        modal.show();
      });
    }
  });
  
  console.log(`=== ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼æç”»å®Œäº†: ${eventCount}å€‹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”» ===`);
}

document.getElementById("priority-pin-btn").onclick = () => {
  if (editingPriorityPin) {
    openPriorityPinModal(editingPriorityPin);
  } else {
    openPriorityPinModal({
      lat: selectedLat, 
      lng: selectedLng,
      focus_type: "turn_stability",          // â˜… åˆæœŸå€¤
      focus_label: "ã‚«ãƒ¼ãƒ–ã®å®‰å®šæ€§"
    });
  }
};

document.getElementById("manual-pin-btn").onclick = () => {
  if (editingManualPin) {
    openPinModal(editingManualPin, selectedLat, selectedLng);
  } else {
    openPinModal(null, selectedLat, selectedLng);
  }
};

document.getElementById("zoom-graph-btn").onclick = () => {
  highlightOnChart('gForceChart-{{ session.id }}', selectedLog);
};


/** ========= èµ·å‹• ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  initializeChart();
  renderGForceChart('gForceChart-{{ session.id }}', displayGpsLogs, gLogs);
});
</script>

<!-- Google Mapsï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ initMap ã‚’å‘¼ã¶ï¼‰ -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDU9txYivjPCIe66l6bPYsPifQKcQxjnrA&callback=initMap&loading=async"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
