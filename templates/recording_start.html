<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - é‹è»¢</title>

  <!-- âœ… Bootstrapã‚’è¿½åŠ  -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #cdeae0;
      color: #333;
      padding-bottom: 55px; /* ãƒŠãƒ“åˆ†ã®ä½™ç™½ */
    }

    .main {
      text-align: center;
      padding-top: 40px;
      min-height: calc(100vh - 70px);
    }

    .start-button {
      background-color: #00bcd4;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 15px 40px;
      font-size: 1.5em;
      font-weight: bold;
      color: #000;
      box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.2s;
    }
    .start-button:hover { transform: translateY(-2px); background-color: #00acc1; }

    .message-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      margin-top: 40px;
    }

    .robot {
      width: 70px;
      height: auto;
      border-radius: 50%;
      object-fit: cover;
      background-color: #fff;
    }

    .message-box {
      background-color: #fff;
      border-radius: 8px;
      padding: 12px;
      width: 60%;
      text-align: left;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 0.95em;
      line-height: 1.5em;
    }

    .focus-section {
      margin-top: 30px;
      text-align: left;
      width: 60%;
      margin-left: auto;
      margin-right: auto;
    }

    .focus-section h3 {
      color: #7a2222;
      font-size: 1em;
      margin-bottom: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1em;
      margin-bottom: 6px;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      accent-color: #4a90e2;
      cursor: pointer;
    }

    .hidden { display: none !important; }

    /* === ãƒŠãƒ“ãƒãƒ¼çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆresult.htmlã¨å®Œå…¨ä¸€è‡´ï¼‰ === */
    .custom-nav-bar {
      background: #378da0;
      border-top: 2px solid #5a7d8d;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
      height: 45px;
    }

    /* å„é …ç›® */
    .custom-nav-item {
      flex: 1;
    }

    .custom-nav-bar{background:#378da0;border-top:2px solid #5a7d8d;box-shadow:inset 0 0 5px rgba(0,0,0,.2);height:45px}
    .custom-nav-link{color:#fff;font-weight:bold;font-size:1rem;padding:0 1rem;line-height:41px;height:100%;display:block}
    .custom-nav-item:not(:last-child){border-right:1px solid #5a7d8d}
    .active-glow .custom-nav-link.active{color:rgb(0, 0, 0);background:rgba(255,255,255,.05)}

    #priority-map {
      width: 100%;
      height: 400px !important;
      background: #ddd;
      border: 2px solid #ffa726;
    }
  </style>
</head>
<body>

  <main class="main">
    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <button id="start-button" class="start-button">é‹è»¢é–‹å§‹</button>
      <button id="route-setup-button" class="start-button" style="background-color:#ffd54f;">ãƒ«ãƒ¼ãƒˆè¨­å®š</button>
    </div>

    <!-- âœ… ä¿å­˜æ¸ˆã¿ãƒ«ãƒ¼ãƒˆä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="saved-routes-section"
        style="width: 85%; margin: 20px auto; background: #fff; border-radius: 8px; 
                box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 15px; border: 2px solid #81c784;">
      <h3 style="font-size: 1.2rem; color: #2e7d32; margin-bottom: 10px; text-align:center;">
        ãƒ«ãƒ¼ãƒˆé¸æŠ
      </h3>


      <div class="d-flex flex-wrap align-items-center justify-content-center" style="gap: 8px;">
        <select id="saved-routes-select"
                class="form-select"
                style="width: 60%; max-width: 320px; display:inline-block;">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>

        <button id="show-route-btn" class="btn btn-success" style="min-width:100px;">é¸æŠ</button>
        <button id="rename-route-btn" class="btn btn-warning" style="min-width:100px;">åå‰å¤‰æ›´</button>
        <button id="delete-route-btn" class="btn btn-danger" style="min-width:100px;">å‰Šé™¤</button>
      </div>
    </div>



    <p id="priority_map_text"
      style="
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        background: #ffffff;
        border-bottom: 3px solid #ffd54f;
        width: 85%;
        margin: 20px auto 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 8px 0;
        letter-spacing: 1px;
      ">
      ğŸ—ºï¸ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆãƒãƒƒãƒ—
    </p>
    <div id="priority-map" 
        style="width: 90%; height: 300px; min-height: 250px; margin: 0 auto;
                border-radius: 10px; border: 2px solid #ffa726; display:block;">
    </div>
  </main>

  <!-- âœ… result.html ã¨åŒã˜ãƒŠãƒ“ -->
  <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a href="{{ url_for('views.home') }}" class="nav-link custom-nav-link">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a class="nav-link custom-nav-link active" href="{{ url_for('views.recording_start') }}">é‹è»¢</a>
        </li>
        <!-- âœ… ã“ã“ã« active-glow ã‚’ä»˜ã‘ã‚‹ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ãŒâ€œãƒªã‚¶ãƒ«ãƒˆâ€ãªã‚‰ï¼‰ -->
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('sessions.results_page') }}" class="nav-link custom-nav-link">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item border-end-0">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.explain') }}">èª¬æ˜</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- âœ… Firebase & éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- âœ… Firebase Authenticationã‚‚è¿½åŠ  -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
      storageBucket: "drive-prototype-32ef0.firebasestorage.app",
      messagingSenderId: "500916744769",
      appId: "1:500916744769:web:d5a529ef05d15bb2934cc0",
      measurementId: "G-9CH5CGYCFM"
    };
  firebase.initializeApp(firebaseConfig);
  // ä»–ãƒšãƒ¼ã‚¸ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ä¿å­˜
  try { localStorage.setItem('FIREBASE_CONFIG_JSON', JSON.stringify(firebaseConfig)); } catch(e) {}
    const db = firebase.firestore();
  </script>
  <!-- âœ… ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ï¼ˆå„ªå…ˆãƒ«ãƒ¼ãƒˆç”¨ã€åŠ©è¨€ãªã—ï¼‰ -->
  <script src="{{ url_for('static', filename='route_recorder.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
  <!-- âœ… priority_map.js ã‚’æ™®é€šã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€ -->
  <script src="{{ url_for('static', filename='priority_map.js') }}"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const setupBtn = document.getElementById('route-setup-button');

    // === ãƒ«ãƒ¼ãƒˆè¨­å®šãƒœã‚¿ãƒ³ï¼ˆä¿®æ­£ç‰ˆï¼‰ ===
    setupBtn.addEventListener("click", async () => {
      // ğŸ”¥ ãƒ«ãƒ¼ãƒˆè¨­å®šã®ç¢ºèª
      const ok = confirm("ãƒ«ãƒ¼ãƒˆè¨­å®šã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆèµ°è¡Œãƒ«ãƒ¼ãƒˆã‚’è¨˜éŒ²ã—ã¾ã™ï¼‰");
      if (!ok) return;
      try {
        // â˜… è‡ªå‹•ã§ãƒ«ãƒ¼ãƒˆåã‚’ç”Ÿæˆï¼ˆå¾Œã‹ã‚‰å¤‰æ›´ã§ãã‚‹ï¼‰
        const autoName = "æ–°ã—ã„ãƒ«ãƒ¼ãƒˆ " + new Date().toLocaleString();

        // ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ ON
        localStorage.setItem("priorityRouteRecordingActive", "true");

        // â˜… åå‰å…¥åŠ›ãªã—ã§é–‹å§‹
        await window.priorityRouteAPI.start(autoName);

        // è¨˜éŒ²ä¸­ãƒšãƒ¼ã‚¸ã¸é·ç§»
        window.location.assign("/recording/active");

      } catch (e) {
        console.error("ãƒ«ãƒ¼ãƒˆè¨­å®šã«å¤±æ•—:", e);
        alert("ãƒ«ãƒ¼ãƒˆè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ");

        // ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿æ™‚ã€ãƒ«ãƒ¼ãƒˆæœªé¸æŠãªã‚‰ãƒ”ãƒ³ã‚’æ¶ˆã™
        if (!localStorage.getItem("CURRENT_ROUTE_ID")) {
            if (window.clearPins) clearPins();
        }

      }
    });
  });
  </script>


  <!-- âœ… Google Maps APIã‚’callbackã§å®Ÿè¡Œ -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDU9txYivjPCIe66l6bPYsPifQKcQxjnrA&callback=initPriorityMap"
    async
    defer
  ></script>
  <!-- iOSç”¨: åˆå›ã‚¿ãƒƒãƒ—ã§ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€è¨±å¯å¾Œã«ã‚»ãƒ³ã‚µãƒ¼èµ·å‹• -->
  <script>
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (!isIOS) return;
      if (typeof DeviceMotionEvent === 'undefined' || typeof DeviceMotionEvent.requestPermission !== 'function') return;
      try { if (localStorage.getItem('perm_motion') === 'granted') return; } catch(_) {}
      const ask = async () => {
        try {
          const r = await DeviceMotionEvent.requestPermission();
          localStorage.setItem('perm_motion', r === 'granted' ? 'granted' : 'denied');
          if (r === 'granted') {
            if (!window.isMotionDetectionActive && typeof window.startMotionDetection === 'function') {
              try { window.startMotionDetection(); } catch(_) {}
            }
          } else {
            alert('åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚è¨­å®šã‹ã‚‰æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
          }
        } catch (e) {
          console.warn('Motion permission request failed:', e);
        }
        window.removeEventListener('touchend', ask);
        window.removeEventListener('click', ask);
      };
      window.addEventListener('touchend', ask, { once: true });
      window.addEventListener('click', ask, { once: true });
    })();
  </script>

 <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const userId = window.FLASK_USER_ID || localStorage.getItem("CURRENT_USER_ID");
      const selectEl = document.getElementById("saved-routes-select");
      const showBtn = document.getElementById("show-route-btn");
      const delBtn = document.getElementById("delete-route-btn");
      const startBtn = document.getElementById("start-button");

      if (!window.firebase || !firebase.firestore) {
        console.error("Firebase ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      const db = firebase.firestore();

      // === æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ ===
      try {
        console.log("ğŸ” Checking active session...");
        console.log("   User ID:", userId);
        console.log("   Cookies:", document.cookie);
        
        const checkResponse = await fetch("/sessions/check_active", {
          credentials: "same-origin"
        });
        
        console.log("âœ… Check active response received");
        console.log("   Status:", checkResponse.status);
        console.log("   Status Text:", checkResponse.statusText);
        console.log("   Content-Type:", checkResponse.headers.get("content-type"));
        
        // èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆ401ã®ã¿ï¼‰
        if (checkResponse.status === 401) {
          console.warn("âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼ (401): ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
          window.location.href = "/login";
          return;
        }
        
        // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
        const contentType = checkResponse.headers.get("content-type") || "";
        if (contentType.includes("text/html")) {
          console.warn("âš ï¸ HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œå‡º - èªè¨¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å¯èƒ½æ€§");
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
          window.location.href = "/login";
          return;
        }
        
        if (checkResponse.ok) {
          const checkData = await checkResponse.json();
          if (checkData.has_active) {
            console.log("æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œå‡º:", checkData.session_id);
            
            const continueSession = confirm(
              "å‰å›ã®é‹è»¢ãŒçµ‚äº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\n" +
              "ã€ŒOKã€= å‰å›ã®ç¶šãã‹ã‚‰è¨˜éŒ²\n" +
              "ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€= å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦æ–°è¦é–‹å§‹"
            );
            
            if (continueSession) {
              // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
              localStorage.setItem("activeSessionId", checkData.session_id);
              localStorage.setItem("sessionStartTime", Date.now().toString());
              if (checkData.route_id) {
                localStorage.setItem("CURRENT_ROUTE_ID", checkData.route_id);
              }
              window.location.assign("/recording/active");
              return;
            } else {
              // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
              await fetch("/sessions/end", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  session_id: checkData.session_id,
                  reflection: "è‡ªå‹•çµ‚äº†",
                  sudden_accels: 0,
                  sudden_brakes: 0,
                  sharp_turns: 0,
                  stability: 0,
                  speed_violations: 0,
                  focus_point: ""
                })
              });
              console.log("æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ");
            }
          }
        }
      } catch (error) {
        console.error("æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:", error);
      }

      // === ãƒ«ãƒ¼ãƒˆä¸€è¦§ãƒ­ãƒ¼ãƒ‰ ===
      async function loadSavedRoutes() {
        selectEl.innerHTML = `<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>`;
        const qs = await db.collection("priority_routes")
          .where("user_id", "==", userId)
          .orderBy("created_at", "desc")
          .get();

        if (qs.empty) {
          selectEl.innerHTML = `<option value="">ä¿å­˜ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</option>`;
          startBtn.disabled = true;
          startBtn.style.opacity = "0.6";
          return;
        }

        selectEl.innerHTML = `<option value="">-- ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>`;
        qs.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement("option");
          opt.value = doc.id;
          opt.textContent = d.name || `ãƒ«ãƒ¼ãƒˆ (${new Date(d.created_at?.toDate?.() || Date.now()).toLocaleString()})`;
          selectEl.appendChild(opt);
        });

            // â˜… å‰å›ä½¿ã£ãŸãƒ«ãƒ¼ãƒˆãŒã‚ã‚Œã°è‡ªå‹•é¸æŠã™ã‚‹
        const lastRouteId = localStorage.getItem("LAST_USED_ROUTE_ID");

        if (lastRouteId && selectEl.querySelector(`option[value="${lastRouteId}"]`)) {

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
            selectEl.value = lastRouteId;

            // STARTãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
            startBtn.disabled = false;
            startBtn.style.opacity = "1";

            // ãƒãƒƒãƒ—æç”»ç”¨ã«ã‚‚ä¿å­˜
            localStorage.setItem("CURRENT_ROUTE_ID", lastRouteId);
        }

      }


      await loadSavedRoutes();


      // === è¡¨ç¤ºãƒœã‚¿ãƒ³ ===
      showBtn.addEventListener("click", async () => {
          const id = selectEl.value;
          if (!id) return alert("ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          if (!window._priorityMapInstance) {
            return alert("ãƒãƒƒãƒ—ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          }

          // ğŸ”¥ ãƒ”ãƒ³ã¨ãƒ«ãƒ¼ãƒˆã‚’ã¾ãšæ¶ˆã™
          if (window.clearPins) clearPins();
          if (window.clearDisplayedRoutes) clearDisplayedRoutes();

          try {
            // ãƒ«ãƒ¼ãƒˆæç”»
            await drawRouteById(window._priorityMapInstance, id);

            // ğŸ”¥ ãƒ”ãƒ³è¡¨ç¤ºï¼ˆè¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«ã ã‘ï¼‰
            await loadPins(window._priorityMapInstance);

            alert("âœ… ãƒ«ãƒ¼ãƒˆã¨ãƒ”ãƒ³ã‚’ãƒãƒƒãƒ—ã«æç”»ã—ã¾ã—ãŸã€‚");
          } catch (e) {
            console.error(e);
            alert("ãƒ«ãƒ¼ãƒˆã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
      });



      // === å‰Šé™¤ãƒœã‚¿ãƒ³ ===
      delBtn.addEventListener("click", async () => {
        const id = selectEl.value;
        if (!id) return alert("å‰Šé™¤ã™ã‚‹ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

        const ok = confirm("ã“ã®ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;

        try {
          // ğŸ”¥ 1. ã“ã®ãƒ«ãƒ¼ãƒˆã«ç´ã¥ããƒ”ãƒ³ã‚’å…¨å‰Šé™¤
          const pinsSnap = await db.collection("priority_pins")
            .where("route_id", "==", id)
            .get();

          const batch = db.batch();
          pinsSnap.forEach(doc => batch.delete(doc.ref));
          await batch.commit();

          console.log(`ğŸ—‘ ãƒ«ãƒ¼ãƒˆå‰Šé™¤ã«ä¼´ã„ ${pinsSnap.size} å€‹ã®ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

          // ğŸ”¥ 2. ãƒ«ãƒ¼ãƒˆæœ¬ä½“ã‚’å‰Šé™¤
          await db.collection("priority_routes").doc(id).delete();

          alert("ğŸ—‘ï¸ ãƒ«ãƒ¼ãƒˆã¨é–¢é€£ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");

          // ğŸ”¥ 3. UI æ›´æ–°
          await loadSavedRoutes();

          // ğŸ”¥ 4. é¸æŠãƒ«ãƒ¼ãƒˆã®è¨˜æ†¶ã‚’è§£é™¤
          localStorage.removeItem("CURRENT_ROUTE_ID");

        } catch (e) {
          console.error(e);
          alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });

      // === åå‰å¤‰æ›´ãƒœã‚¿ãƒ³ ===
      const renameBtn = document.getElementById("rename-route-btn");

      renameBtn.addEventListener("click", async () => {
        const routeId = selectEl.value;
        if (!routeId) return alert("åå‰ã‚’å¤‰æ›´ã™ã‚‹ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

        const newName = prompt("æ–°ã—ã„ãƒ«ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
        if (!newName || newName.trim() === "") return;

        try {
          await db.collection("priority_routes").doc(routeId).update({
            name: newName.trim()
          });

          alert("ãƒ«ãƒ¼ãƒˆåã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
          await loadSavedRoutes(); // â­ ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿

        } catch (e) {
          console.error(e);
          alert("åå‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });


      // === ãƒ«ãƒ¼ãƒˆé¸æŠæ™‚ ===
      selectEl.addEventListener("change", () => {
        const id = selectEl.value;

        if (id) {
          // ãƒ«ãƒ¼ãƒˆé¸æŠä¸­
          localStorage.setItem("CURRENT_ROUTE_ID", id);
          startBtn.disabled = false;
          startBtn.style.opacity = "1";

          // âŒ ãƒ”ãƒ³ã¯ã¾ã è¡¨ç¤ºã—ãªã„
          // ï¼ˆloadPins ã‚’å‘¼ã°ãªã„ï¼‰

          // ãƒ«ãƒ¼ãƒˆç·šã¨ãƒ”ãƒ³ã‚’å…¨ã¦æ¶ˆã™
          if (window.clearDisplayedRoutes) clearDisplayedRoutes();
          if (window.clearPins) clearPins();

      } else {
          // ãƒ«ãƒ¼ãƒˆæœªé¸æŠ
          localStorage.removeItem("CURRENT_ROUTE_ID");
          startBtn.disabled = true;
          startBtn.style.opacity = "0.6";

          // ğŸ”¥ ãƒ”ãƒ³å‰Šé™¤
          if (window.clearPins) clearPins();

          // ğŸ”¥ ãƒ«ãƒ¼ãƒˆç·šå‰Šé™¤
          if (window.clearDisplayedRoutes) clearDisplayedRoutes();
      }
      });



      // é‹è»¢é–‹å§‹ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ï¼‰
      startBtn.addEventListener("click", async () => {
        const routeId = localStorage.getItem("CURRENT_ROUTE_ID");

        // ğŸ”¥ é‹è»¢é–‹å§‹ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const ok = confirm("é‹è»¢ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;

        if (!routeId) return alert("ãƒ«ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");

        localStorage.setItem("LAST_USED_ROUTE_ID", routeId);

        try {
          // 1ï¸âƒ£ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
          const sessionResponse = await fetch("/sessions/start", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            credentials: "same-origin"
          });

          console.log("Session response status:", sessionResponse.status);
          console.log("Session response headers:", sessionResponse.headers.get("content-type"));

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒHTMLã®å ´åˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
          const contentType = sessionResponse.headers.get("content-type") || "";
          if (!sessionResponse.ok) {
            console.error("Session API ã‚¨ãƒ©ãƒ¼:", sessionResponse.status, sessionResponse.statusText);
            
            if (sessionResponse.status === 401 || contentType.includes("text/html")) {
              // èªè¨¼ã‚¨ãƒ©ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
              alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
              window.location.href = "/login";
              return;
            } else {
              alert(`ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ (status: ${sessionResponse.status})`);
              return;
            }
          }
          
          if (contentType.includes("text/html")) {
            console.error("HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ï¼ˆèªè¨¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰");
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
            window.location.href = "/login";
            return;
          }

          const sessionData = await sessionResponse.json();
          console.log("session response:", sessionData);

          // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
          if (sessionData.status === 'warning' && sessionData.session_id) {
            const useExisting = confirm("æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€= ç¶šãã‹ã‚‰è¨˜éŒ²\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€= æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆå‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯è‡ªå‹•çµ‚äº†ï¼‰");
            
            if (useExisting) {
              // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
              localStorage.setItem("activeSessionId", sessionData.session_id);
              localStorage.setItem("sessionStartTime", Date.now().toString());
              
              // 2ï¸âƒ£ ãƒ«ãƒ¼ãƒˆIDã‚’ç´ã¥ã‘ã‚‹
              await fetch(`/sessions/api/set_route_to_session/${sessionData.session_id}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ route_id: routeId })
              });

              // 3ï¸âƒ£ è¨˜éŒ²ç”»é¢ã¸
              window.location.assign("/recording/active");
              return;
            } else {
              // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ã‹ã‚‰æ–°è¦ä½œæˆ
              await fetch("/sessions/end", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                  session_id: sessionData.session_id,
                  reflection: "è‡ªå‹•çµ‚äº†",
                  sudden_accels: 0,
                  sudden_brakes: 0,
                  sharp_turns: 0,
                  stability: 0,
                  speed_violations: 0,
                  focus_point: ""
                })
              });
              
              // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆå†è©¦è¡Œï¼‰
              const newSessionResponse = await fetch("/sessions/start", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
              });
              const newSessionData = await newSessionResponse.json();
              
              if (!newSessionData.session_id) {
                alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
                return;
              }
              
              localStorage.setItem("activeSessionId", newSessionData.session_id);
              localStorage.setItem("sessionStartTime", Date.now().toString());
              
              // 2ï¸âƒ£ ãƒ«ãƒ¼ãƒˆIDã‚’ç´ã¥ã‘ã‚‹
              await fetch(`/sessions/api/set_route_to_session/${newSessionData.session_id}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ route_id: routeId })
              });

              // 3ï¸âƒ£ è¨˜éŒ²ç”»é¢ã¸
              window.location.assign("/recording/active");
              return;
            }
          }

          // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ä½œæˆã•ã‚ŒãŸå ´åˆ
          if (!sessionData.session_id) {
            alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
            return;
          }

          localStorage.setItem("activeSessionId", sessionData.session_id);
          localStorage.setItem("sessionStartTime", Date.now().toString());
          console.log("âœ… session started:", sessionData.session_id);

          // 2ï¸âƒ£ ãƒ«ãƒ¼ãƒˆIDã‚’ç´ã¥ã‘ã‚‹
          console.log("ğŸ“Œ Setting route_id:", routeId, "to session:", sessionData.session_id);
          const r = await fetch(`/sessions/api/set_route_to_session/${sessionData.session_id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ route_id: routeId })
          });
          
          console.log("ğŸ“Œ set_route response status:", r.status);
          
          if (!r.ok) {
            const errorData = await r.json();
            console.error("âŒ set_route failed:", errorData);
            alert(`ãƒ«ãƒ¼ãƒˆè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.message || 'Unknown error'}`);
            return;
          }
          
          const routeResult = await r.json();
          console.log("âœ… set_route result:", routeResult);

          // 3ï¸âƒ£ è¨˜éŒ²ç”»é¢ã¸
          console.log("ğŸš— Navigating to /recording/active");
          window.recordingStartTime = Date.now();
          window.location.assign("/recording/active");
          
        } catch (error) {
          console.error("é‹è»¢é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
          alert("é‹è»¢é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
      }); 
    });

  </script>
  <script>
    window.FLASK_USER_ID = "{{ current_user.id }}";
    localStorage.setItem("CURRENT_USER_ID", "{{ current_user.id }}");
  </script>

</body>
</html>