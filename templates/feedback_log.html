<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é›†è¨ˆ - ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f5f7fa; padding:20px; }
    .summary-card { background:#fff; border-radius:10px; padding:20px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .stat-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; }
    .stat-item { background:#f8f9fa; padding:12px; border-radius:8px; text-align:center; }
    .stat-label { font-size:0.85rem; color:#666; margin-bottom:5px; }
    .stat-value { font-size:1.5rem; font-weight:bold; color:#2090c2; }
    .feedback-item { background:#fff; border-left:4px solid #2090c2; padding:15px; margin-bottom:12px; border-radius:6px; }
    .badge-device { background:#28a745; color:#fff; padding:4px 8px; border-radius:4px; font-size:0.8rem; }
    .badge-browser { background:#17a2b8; color:#fff; padding:4px 8px; border-radius:4px; font-size:0.8rem; }
    .eval-bar { background:#e9ecef; height:30px; border-radius:4px; position:relative; margin:8px 0; overflow:hidden; }
    .eval-fill { background:#2090c2; height:100%; border-radius:4px; display:flex; align-items:center; padding-left:10px; color:#fff; font-size:0.85rem; font-weight:500; transition:width 0.3s ease; }
    .chart-container { display:flex; align-items:flex-end; gap:8px; height:200px; margin:20px 0; max-width:600px; }
    .chart-bar { flex:1; max-width:60px; background:#e9ecef; border-radius:4px 4px 0 0; position:relative; display:flex; flex-direction:column; justify-content:flex-end; transition:all 0.3s ease; }
    .chart-bar:hover { opacity:0.8; }
    .chart-fill { background:#2090c2; width:100%; border-radius:4px 4px 0 0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.75rem; font-weight:bold; min-height:25px; }
    .chart-label { text-align:center; font-size:0.75rem; color:#666; margin-top:5px; word-break:break-word; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0">ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é›†è¨ˆ</h3>
      <a href="{{ url_for('views.home') }}" class="btn btn-outline-secondary btn-sm">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    </div>

    <!-- æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="summary-card mb-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h6 class="mb-2">æ—¥ä»˜ã§çµã‚Šè¾¼ã¿</h6>
          <select id="dateFilter" class="form-select" onchange="filterByDate(this.value)">
            <option value="">å…¨æœŸé–“</option>
            {% for date, count in date_counts.most_common() %}
              <option value="{{ date }}" {% if filter_date == date %}selected{% endif %}>
                {{ date }} ({{ count }}ä»¶)
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6 text-end">
          {% if filter_date %}
            <a href="{{ url_for('views.feedback_log') }}" class="btn btn-sm btn-outline-secondary mt-3">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</a>
          {% endif %}
        </div>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: {{ error }}</div>
    {% endif %}

    <!-- åŸºæœ¬çµ±è¨ˆ -->
    <div class="summary-card">
      <h5 class="mb-3">åŸºæœ¬çµ±è¨ˆ</h5>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">ç·å›ç­”æ•°</div>
          <div class="stat-value">{{ total_count }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å¹³å‡æº€è¶³åº¦</div>
          <div class="stat-value">
            {% if satisfaction_counts %}
              {% set total_sat = satisfaction_counts.values()|sum %}
              {% set weighted = namespace(sum=0) %}
              {% for val, count in satisfaction_counts.items() %}
                {% if val|string|length > 0 %}
                  {% set weighted.sum = weighted.sum + (val|int * count) %}
                {% endif %}
              {% endfor %}
              {{ "%.1f"|format(weighted.sum / total_sat if total_sat > 0 else 0) }}
            {% else %}
              N/A
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨ç’°å¢ƒ -->
    <div class="summary-card">
      <h5 class="mb-3">ä½¿ç”¨ç’°å¢ƒ</h5>
      <div class="row">
        <div class="col-md-6">
          <h6>ä½¿ç”¨æ©Ÿç¨®</h6>
          {% for device, count in device_counts.most_common() %}
            <div class="eval-bar">
              <div class="eval-fill" style="width:{{ (count / total_count * 100)|int }}%">
                {{ device }}: {{ count }}ä»¶
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <h6>ä½¿ç”¨ãƒ–ãƒ©ã‚¦ã‚¶</h6>
          {% for browser, count in browser_counts.most_common() %}
            <div class="eval-bar">
              <div class="eval-fill" style="width:{{ (count / total_count * 100)|int }}%">
                {{ browser }}: {{ count }}ä»¶
              </div>
            </div>
          {% endfor %}
          {% if browser_other_list %}
            <div class="mt-2 small text-muted">
              <strong>ãã®ä»–ã®è©³ç´°:</strong>
              {% for other in browser_other_list %}
                <span class="badge bg-secondary me-1">{{ other }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹è©•ä¾¡ -->
    <div class="summary-card">
      <h5 class="mb-3">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹åˆ¤å®šè©•ä¾¡</h5>
      {% set eval_options = ['é©åˆ‡ã ã£ãŸ', 'ç”˜ã™ããŸ', 'å³ã—ã™ããŸ', 'åˆ¤å®šã•ã‚Œãªã‹ã£ãŸ'] %}
      
      <!-- æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ã€æ€¥ã‚«ãƒ¼ãƒ–ã€æ€¥åŠ é€Ÿ -->
      <h6 class="mt-3">æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ»æ€¥ã‚«ãƒ¼ãƒ–ãƒ»æ€¥åŠ é€Ÿ</h6>
      <div style="display:flex; gap:30px;">
        {% for key in ['hard_brake', 'hard_curve', 'hard_accel'] %}
          {% set label = {'hard_brake': 'æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­', 'hard_curve': 'æ€¥ã‚«ãƒ¼ãƒ–', 'hard_accel': 'æ€¥åŠ é€Ÿ'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.9rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in eval_options %}
                {% set count = eval_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in eval_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.7rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- è‰¯æ¸›é€Ÿã€è‰¯ã‚«ãƒ¼ãƒ–ã€è‰¯åŠ é€Ÿ -->
      <h6 class="mt-4">è‰¯æ¸›é€Ÿãƒ»è‰¯ã‚«ãƒ¼ãƒ–ãƒ»è‰¯åŠ é€Ÿ</h6>
      <div style="display:flex; gap:30px;">
        {% for key in ['good_decel', 'good_curve', 'good_accel'] %}
          {% set label = {'good_decel': 'è‰¯æ¸›é€Ÿ', 'good_curve': 'è‰¯ã‚«ãƒ¼ãƒ–', 'good_accel': 'è‰¯åŠ é€Ÿ'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.9rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in eval_options %}
                {% set count = eval_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in eval_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.7rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- é‹è»¢å¾Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è©•ä¾¡ -->
    <div class="summary-card">
      <h5 class="mb-3">é‹è»¢å¾Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è©•ä¾¡</h5>
      {% set post_options = ['ã¨ã¦ã‚‚è‰¯ã„', 'è‰¯ã„', 'æ™®é€š', 'æ”¹å–„ãŒå¿…è¦', 'è¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸ'] %}
      <div style="display:flex; gap:30px;">
        {% for key in ['overall', 'clarity', 'accuracy', 'helpfulness'] %}
          {% set label = {'overall': 'ç·åˆè©•ä¾¡', 'clarity': 'åˆ†ã‹ã‚Šã‚„ã™ã•', 'accuracy': 'æ­£ç¢ºã•', 'helpfulness': 'æ”¹å–„ã«å½¹ç«‹ã¤åº¦'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.9rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in post_options %}
                {% set count = post_fb_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in post_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.65rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆè©•ä¾¡ -->
    <div class="summary-card">
      <h5 class="mb-3">é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆè¨­ç½®è©•ä¾¡</h5>
      {% set focus_options = ['ã¨ã¦ã‚‚è‰¯ã„', 'è‰¯ã„', 'æ™®é€š', 'æ”¹å–„ãŒå¿…è¦', 'åˆ©ç”¨ã—ã¦ã„ãªã„'] %}
      <div style="display:flex; gap:30px;">
        {% for key in ['ease_view', 'ease_edit', 'ease_check'] %}
          {% set label = {'ease_view': 'é–²è¦§ã®ã—ã‚„ã™ã•', 'ease_edit': 'ç·¨é›†ã®ã—ã‚„ã™ã•', 'ease_check': 'å†…å®¹ã®ç¢ºèªã—ã‚„ã™ã•'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.9rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in focus_options %}
                {% set count = focus_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in focus_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.65rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ãƒãƒƒãƒ—ãƒ”ãƒ³è©•ä¾¡ -->
    <div class="summary-card">
      <h5 class="mb-3">ãƒãƒƒãƒ—ãƒ”ãƒ³æ©Ÿèƒ½è©•ä¾¡</h5>
      {% set pin_options = ['ã¨ã¦ã‚‚è‰¯ã„', 'è‰¯ã„', 'æ™®é€š', 'æ”¹å–„ãŒå¿…è¦', 'åˆ©ç”¨ã—ã¦ã„ãªã„'] %}
      <div style="display:flex; gap:30px;">
        {% for key in ['ease_add', 'ease_edit', 'speak_useful', 'advanced_settings'] %}
          {% set label = {'ease_add': 'ãƒ”ãƒ³è¿½åŠ ã®ã—ã‚„ã™ã•', 'ease_edit': 'ãƒ”ãƒ³ç·¨é›†ã®ã—ã‚„ã™ã•', 'speak_useful': 'èª­ã¿ä¸Šã’æ©Ÿèƒ½ã®æœ‰ç”¨æ€§', 'advanced_settings': 'å„ªå…ˆåº¦/æ™‚é–“å¸¯è¨­å®šã®ä½¿ã„ã‚„ã™ã•'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.85rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in pin_options %}
                {% set count = pin_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in pin_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.65rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- èª²é¡Œè§£æ±ºè©•ä¾¡ -->
    <div class="summary-card">
      <h5 class="mb-3">èª²é¡Œè§£æ±ºè©•ä¾¡</h5>
      {% set solution_options = ['ã¨ã¦ã‚‚å½“ã¦ã¯ã¾ã‚‹', 'å½“ã¦ã¯ã¾ã‚‹', 'ã‚ã¾ã‚Šå½“ã¦ã¯ã¾ã‚‰ãªã„', 'å…¨ãå½“ã¦ã¯ã¾ã‚‰ãªã„'] %}
      <div style="display:flex; gap:30px;">
        {% for key in ['focus_awareness', 'realtime_improvement', 'pin_reference'] %}
          {% set label = {'focus_awareness': 'é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆFBã§è‡ªåˆ†ã®èª²é¡Œã‚’æŠŠæ¡ã§ããŸã‹', 'realtime_improvement': 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§å¿«é©ã«è‡ªåˆ†ã®é‹è»¢ã‚’æ”¹å–„ã§ããŸã‹', 'pin_reference': 'ä»–ã®äººãŒåˆºã—ãŸãƒ”ãƒ³ãŒé‹è»¢ã®å‚è€ƒã«ãªã£ã¦ã„ã‚‹ã‹'}[key] %}
          <div style="flex:1;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.85rem;">{{ label }}</div>
            <div class="chart-container" style="margin:0;">
              {% for option in solution_options %}
                {% set count = solution_summary.get(key, {}).get(option, 0) %}
                {% set percentage = (count / total_count * 100)|int if total_count > 0 else 0 %}
                <div class="chart-bar">
                  <div class="chart-fill" style="height:{{ percentage * 2 }}px;">{{ count }}</div>
                </div>
              {% endfor %}
            </div>
            <div style="display:flex; gap:8px; max-width:600px;">
              {% for option in solution_options %}
                <div style="flex:1; max-width:60px; text-align:center; font-size:0.7rem; color:#666; word-wrap:break-word;">{{ option }}</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- æº€è¶³åº¦åˆ†å¸ƒ -->
    <div class="summary-card">
      <h5 class="mb-3">æº€è¶³åº¦åˆ†å¸ƒ</h5>
      {% for rating in range(5, 0, -1) %}
        {% set count = satisfaction_counts.get(rating|string, 0) %}
        <div class="eval-bar">
          <div class="eval-fill" style="width:{{ (count / total_count * 100)|int if total_count > 0 else 0 }}%">
            â˜…{{ rating }}: {{ count }}ä»¶
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- è‡ªç”±è¨˜è¿°ä¸€è¦§ -->
    <div class="summary-card">
      <h5 class="mb-3">è‡ªç”±è¨˜è¿°ã‚³ãƒ¡ãƒ³ãƒˆ</h5>
      {% for fb in feedbacks %}
        {% if fb.get('good_points') or fb.get('improvement_points') or fb.get('desired_features') or fb.get('other_comments') %}
        <div class="feedback-item">
          <div class="mb-2">
            <a href="{{ url_for('views.feedback_detail', feedback_id=fb.get('id')) }}" class="text-decoration-none">
              <strong class="text-primary">{{ fb.get('real_name', 'åŒ¿å') }}</strong>
            </a>
            <span class="badge-device ms-2">{{ fb.get('device_type', 'N/A') }}</span>
            <span class="badge-browser">{{ fb.get('browser', 'N/A') }}</span>
            {% if fb.get('browser') == 'ãã®ä»–' and fb.get('browser_other') %}
              <span class="badge bg-info text-white ms-1">{{ fb.get('browser_other') }}</span>
            {% endif %}
            <span class="text-muted ms-2" style="font-size:0.85rem;">
              é‹è»¢å›æ•°: {{ fb.get('drive_times')|length if fb.get('drive_times') else 1 }}å›
            </span>
            <span class="text-muted ms-2" style="font-size:0.85rem;">
              æº€è¶³åº¦: {{ fb.get('satisfaction', 'N/A') }}
            </span>
          </div>
          {% if fb.get('good_points') %}
            <div class="mb-1"><strong>è‰¯ã‹ã£ãŸç‚¹:</strong> {{ fb.get('good_points') }}</div>
          {% endif %}
          {% if fb.get('improvement_points') %}
            <div class="mb-1"><strong>æ”¹å–„ç‚¹:</strong> {{ fb.get('improvement_points') }}</div>
          {% endif %}
          {% if fb.get('desired_features') %}
            <div class="mb-1"><strong>è¿½åŠ å¸Œæœ›æ©Ÿèƒ½:</strong> {{ fb.get('desired_features') }}</div>
          {% endif %}
          {% if fb.get('other_comments') %}
            <div class="mb-1"><strong>ãã®ä»–:</strong> {{ fb.get('other_comments') }}</div>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    </div>

  </div>

  <script>
    function filterByDate(date) {
      if (date) {
        window.location.href = "{{ url_for('views.feedback_log') }}?date=" + date;
      } else {
        window.location.href = "{{ url_for('views.feedback_log') }}";
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
