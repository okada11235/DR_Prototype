<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ - DriveLogger</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='sessions.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container">
        <a href="{{ url_for('auth.logout') }}" class="logout-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        <div style="text-align: center; margin-top: 30px;">
            <a href="{{ url_for('views.index') }}" class="btn btn-custom">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
        <br>
        <h1>ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</h1>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info">
            {{ messages[0] }}
        </div>
        {% endif %}
        {% endwith %}

        {% if not sessions %}
        <div class="no-sessions">
            <p>ã¾ã è¨˜éŒ²ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <p>ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦è¨˜éŒ²ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
            <a href="{{ url_for('views.index') }}" class="btn btn-custom">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
        {% else %}
        {% for session in sessions %}
        <div class="session-card">
            <h3>
                ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: {{ session.id }}
                <span>é–‹å§‹æ™‚åˆ»: {{ session.start_time.strftime('%Y/%m/%d %H:%M:%S') if session.start_time else 'N/A'
                    }}</span>
            </h3>
            <div class="session-details">
                <p><strong>çµ‚äº†æ™‚åˆ»ï¼š</strong> {{ session.end_time.strftime('%Y/%m/%d %H:%M:%S') if session.end_time else
                    'N/A' }}</p>
                <p><strong>èµ°è¡Œè·é›¢ï¼š</strong> {{ "%.2f"|format(session.distance) }} km</p>
                <p><strong>æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ğŸ”´å›æ•°ï¼š</strong> {{ session.sudden_brakes if session.sudden_brakes is not none else 'N/A'
                    }} å›</p>
                <p><strong>æ€¥ç™ºé€²ğŸŸ¢å›æ•°ï¼š</strong> {{ session.sudden_accels if session.sudden_accels is not none else 'N/A' }}
                    å›</p>
                <p><strong>æ€¥ã‚«ãƒ¼ãƒ–ğŸŸ¡å›æ•°ï¼š</strong> {{ session.sharp_turns if session.sharp_turns is not none else 'N/A' }} å›
                </p>
                <h4>GåŠ é€Ÿåº¦ï¼†é€Ÿåº¦ã‚°ãƒ©ãƒ•</h4>
                <div class="chart-container">
                    <canvas id="gForceChart-{{ session.id }}"></canvas>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button 
                        onmousedown="startZoom('gForceChart-{{ session.id }}', 'in')" 
                        onmouseup="stopZoom()" 
                        onmouseleave="stopZoom()" 
                        ontouchstart="startZoom('gForceChart-{{ session.id }}', 'in')" 
                        ontouchend="stopZoom()">
                        ï¼‹ Zoom In
                    </button>

                    <button 
                        onmousedown="startZoom('gForceChart-{{ session.id }}', 'out')" 
                        onmouseup="stopZoom()" 
                        onmouseleave="stopZoom()" 
                        ontouchstart="startZoom('gForceChart-{{ session.id }}', 'out')" 
                        ontouchend="stopZoom()">
                        ï¼ Zoom Out
                    </button>
                    <button onclick="resetChartZoom('gForceChart-{{ session.id }}')">
                        Reset
                    </button>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button id="panRight" 
                        onmousedown="startPan('gForceChart-{{ session.id }}','right')" 
                        onmouseup="stopPan()" 
                        onmouseleave="stopPan()"
                        ontouchstart="startPan('gForceChart-{{ session.id }}','right')" 
                        ontouchend="stopPan()">
                        â—€ å·¦ã¸
                    </button>

                    <button id="panLeft" 
                        onmousedown="startPan('gForceChart-{{ session.id }}','left')" 
                        onmouseup="stopPan()" 
                        onmouseleave="stopPan()"
                        ontouchstart="startPan('gForceChart-{{ session.id }}','left')" 
                        ontouchend="stopPan()">
                        å³ã¸ â–¶
                    </button>
                </div>

                <h4>èµ°è¡Œãƒ«ãƒ¼ãƒˆã¨ã‚¤ãƒ™ãƒ³ãƒˆ</h4>
                <div class="map-container">
                    <div id="map-{{ session.id }}" style="height: 100%; width: 100%;"></div>
                </div>

                <div class="reflection-section">
                    <h4>åçœæ–‡:</h4>
                    <textarea id="reflection-{{ session.id }}" class="reflection-textarea" rows="4"
                        placeholder="ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦åçœç‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">{{ session.reflection }}</textarea>
                    <button class="save-reflection-btn" data-session-id="{{ session.id }}">åçœæ–‡ã‚’ä¿å­˜</button>
                    <p id="save-status-{{ session.id }}" class="save-status"></p>
                </div>
                <form action="{{ url_for('views.delete_session', sid=session.id) }}" method="post"
                    onsubmit="return confirm('æœ¬å½“ã«ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                    <button type="submit" class="btn btn-danger-custom">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤</button>
                </form>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script>
        if (Chart.registerables) Chart.register(...Chart.registerables);
        Chart.register(window['chartjs-plugin-zoom']);
    </script>
    <script>
        const SAVE_REFLECTION_URL = "{{ url_for('sessions.save_reflection') }}";
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const allButtons = document.querySelectorAll('.session-details button');
            
            allButtons.forEach(button => {
                button.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã®è‰²å®šç¾© (ãƒãƒƒãƒ—ã¨ã‚°ãƒ©ãƒ•ã§å…±é€šåˆ©ç”¨)
        const colorMap = {
            normal: 'transparent', // 'normal'ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚°ãƒ©ãƒ•ä¸Šã§éè¡¨ç¤ºã«
            sudden_brake: 'red',
            sudden_accel: 'green',
            sharp_turn: 'orange',
            speed_violation: 'purple'
        };

        // Google Maps APIãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
        function initAllSessionMaps() {
            console.log("Google Maps API loaded and initAllSessionMaps callback initiated.");

            // å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†ã—ã€åœ°å›³ã¨ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
            {% for session in sessions %}
            {% if session.gps_logs %}
            const gpsLogs_{{ session.id }} = {{ session.gps_logs | tojson }};
            const gLogs_{{ session.id }} = {{ session.g_logs | tojson }};

            // GåŠ é€Ÿåº¦ã‚°ãƒ©ãƒ•ã®æç”»
            renderGForceChart('gForceChart-{{ session.id }}', gpsLogs_{{ session.id }}, gLogs_{{ session.id }});

            // åœ°å›³ã®æç”»
            initSessionMap('map-{{ session.id }}', gpsLogs_{{ session.id }});
            {% else %}
            console.log("GPSãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“: Session ID {{ session.id }}");
            // GPSãƒ­ã‚°ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ªè¦ç´ ã«è¡¨ç¤º
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç®‡æ‰€ã‚’ä¿®æ­£ï¼šmap-containerã¨chart-containerã®ç›´ä¸‹ã«è¿½åŠ 
            const chartContainer = document.getElementById('gForceChart-{{ session.id }}').closest('.chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¯GPSãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            const mapContainer = document.getElementById('map-{{ session.id }}').closest('.map-container');
            if (mapContainer) {
                mapContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¯GPSãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            {% endif %}
            {% endfor %}
        }

        const chartInstances = {};

        function renderGForceChart(canvasId, gpsLogs, gLogs) {
            // ä¸¡æ–¹ã® timestamp ã‚’çµ±åˆã—ã¦ã‚½ãƒ¼ãƒˆ
            const allTimestamps = Array.from(new Set([
                ...gLogs.map(log => log.timestamp),
                ...gpsLogs.map(log => log.timestamp)
            ])).sort((a, b) => a - b);

            // ã‚°ãƒ©ãƒ•ã®ãƒ©ãƒ™ãƒ«ï¼ˆæ—¥æœ¬æ™‚é–“ã«å¤‰æ›ï¼‰
            const timestamps = allTimestamps.map(ts => new Date(ts).toLocaleTimeString('ja-JP'));

            // ãƒ‡ãƒ¼ã‚¿ã‚’ allTimestamps ã«åˆã‚ã›ã¦æƒãˆã‚‹
            function alignData(logs, key) {
                const map = new Map(logs.map(log => [log.timestamp, log[key]]));
                return allTimestamps.map(ts => map.get(ts) ?? null);
            }

            const gxData = alignData(gLogs, "g_x");
            const gyData = alignData(gLogs, "g_y");
            const gzData = alignData(gLogs, "g_z");
            const speedData = alignData(gpsLogs, "speed");

            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'å‰å¾ŒG',
                            data: gzData,
                            borderColor: '#00bcd4',
                            backgroundColor: 'rgba(0,188,212,0.2)',
                            borderWidth: 2,
                            yAxisID: 'y',
                            fill: false,
                            tension: 0,
                            spanGaps: true
                        },
                        {
                            label: 'ä¸Šä¸‹G',
                            data: gyData,
                            borderColor: '#666',
                            backgroundColor: 'rgba(102,102,102,0.2)',
                            borderWidth: 2,
                            yAxisID: 'y',
                            fill: false,
                            tension: 0,
                            spanGaps: true
                        },
                        {
                            label: 'å·¦å³G',
                            data: gxData,
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156,39,176,0.2)',
                            borderWidth: 2,
                            yAxisID: 'y',
                            fill: false,
                            tension: 0,
                            spanGaps: true
                        },
                        {
                            label: 'é€Ÿåº¦ (km/h)',
                            data: speedData,
                            borderColor: 'rgba(255,99,132,0.7)',
                            backgroundColor: 'rgba(255,99,132,0.1)',
                            borderWidth: 1,
                            yAxisID: 'y1',
                            fill: false,
                            tension: 0,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: 'G (é‡åŠ›åŠ é€Ÿåº¦)' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'é€Ÿåº¦ (km/h)' },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: 120
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    }
                }
            });
            chartInstances[canvasId] = chart;
        }

        function initSessionMap(mapId, gpsLogs) {
            if (gpsLogs.length === 0) {
                return;
            }

            const path = gpsLogs.map(log => ({ lat: log.latitude, lng: log.longitude }));
            const firstPoint = path[0];

            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API is not loaded yet when initSessionMap is called for mapId:", mapId);
                document.getElementById(mapId).innerHTML = '<p style="text-align: center; margin-top: 20px; color: red;">åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            const map = new google.maps.Map(document.getElementById(mapId), {
                zoom: 15,
                center: firstPoint
            });

            const polyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#007bff',
                strokeOpacity: 1.0,
                strokeWeight: 4,
                map: map
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
            gpsLogs.forEach(log => {
                const position = { lat: log.latitude, lng: log.longitude };
                let color = 'gray'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

                switch (log.event) {
                    case 'sudden_brake':
                        color = 'red';
                        break;
                    case 'sudden_accel':
                        color = 'green';
                        break;
                    case 'sharp_turn':
                        color = 'orange';
                        break;
                    case 'speed_violation':
                        color = 'purple';
                        break;
                    default:
                        // normal ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„
                        return;
                }

                new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 6,
                        fillColor: color,
                        fillOpacity: 1,
                        strokeWeight: 1,
                        strokeColor: '#000'
                    },
                    title: log.event.replace('_', ' ') // ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆåã‚’è¡¨ç¤º
                });
            });
        }

        // â˜…jQueryã®ä»£ã‚ã‚Šã«é€šå¸¸ã®JavaScriptã§å®Ÿè£… (æ—¢å­˜ã®jQueryã¯slimç‰ˆã®ãŸã‚ajaxã¯ä½¿ãˆãªã„)
        // jQueryã‚’é€šå¸¸ç‰ˆã«æˆ»ã™ã‹ã€Fetch APIã‚’ä½¿ç”¨
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«Fetch APIã§è¨˜è¿°ã—ã¾ã™ã€‚

        // Fetch APIã§POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        function postData(url, data) {
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // å„ã€Œåçœæ–‡ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.save-reflection-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const sessionId = this.dataset.sessionId;
                    const textarea = document.getElementById(`reflection-${sessionId}`);
                    const reflectionText = textarea.value;
                    const statusElement = document.getElementById(`save-status-${sessionId}`);

                    statusElement.textContent = 'ä¿å­˜ä¸­...';
                    statusElement.style.color = 'gray';

                    postData(SAVE_REFLECTION_URL, {
                        session_id: sessionId,
                        reflection_text: reflectionText
                    })
                        .then(data => {
                            if (data.status === 'ok') {
                                statusElement.textContent = 'ä¿å­˜ã—ã¾ã—ãŸï¼';
                                statusElement.style.color = 'green';
                            } else {
                                statusElement.textContent = `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message}`;
                                statusElement.style.color = 'red';
                            }
                        })
                        .catch(error => {
                            statusElement.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
                            statusElement.style.color = 'red';
                            console.error("Fetch API error:", error);
                        });
                });
            });
        });
    </script>
    <script>
        let zoomInterval;

        function startZoom(canvasId, direction, factor = 1.05, speed = 150) {
            const chart = chartInstances[canvasId];
            if (!chart) return;

            zoomInterval = setInterval(() => {
                if (direction === 'in') {
                    chart.zoom({ x: factor, y: 1 });
                } else if (direction === 'out') {
                    chart.zoom({ x: 1 / factor, y: 1 });
                }
            }, speed);
        }

        function stopZoom() {
            clearInterval(zoomInterval);
        }

        let panInterval; // ç¹°ã‚Šè¿”ã—å‡¦ç†ç”¨

        function startPan(canvasId, direction, distance = 50, speed = 100) {
            const chart = chartInstances[canvasId];
            if (!chart) return;

            const delta = (direction === 'left') ? -distance : distance;

            // 100msã”ã¨ã«ãƒ‘ãƒ³ã‚’ç¹°ã‚Šè¿”ã™
            panInterval = setInterval(() => {
                chart.pan({ x: delta, y: 0 });
            }, speed);
        }

        function stopPan() {
            clearInterval(panInterval);
        }

        function resetChartZoom(canvasId) {
            const chart = chartInstances[canvasId];
            if (chart) chart.resetZoom();
        }
    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUyc6mj-SEOP8lopM2laEywMILL8qknvo&callback=initAllSessionMaps"></script>
</body>

</html>
