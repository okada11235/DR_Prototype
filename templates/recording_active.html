<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²ä¸­</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'primary-green': '#00bcd4',
        'danger-red': '#f44336',
        'bg-light': '#d8f5e3',
        'card-light': '#aafaff'
      },
      fontFamily: {
        sans: ['"Hiragino Maru Gothic ProN"', 'sans-serif']
      }
    }
  }
}
</script>
</head>
<body class="bg-bg-light text-gray-800 font-sans flex flex-col items-center justify-center min-h-screen p-4" data-page="recording_active">

  <h1 class="text-3xl font-bold text-primary-green mb-6">è¨˜éŒ²ä¸­</h1>

  <!-- ã‚­ãƒ£ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div class="w-36 h-36 rounded-full bg-white shadow-md flex items-center justify-center overflow-hidden mb-6">
    <img src="{{ url_for('static', filename='img/robot_active.png') }}" alt="ãƒ­ãƒœãƒƒãƒˆ" class="object-cover w-full h-full">
  </div>

  <!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ -->
  <div class="flex justify-center gap-6 mb-6">
    <div class="bg-card-light rounded-lg px-6 py-3 shadow">
      <p class="text-sm text-gray-700">é€Ÿåº¦</p>
      <p class="text-2xl font-bold"><span id="speed">0</span> km/h</p>
    </div>
    <div class="bg-card-light rounded-lg px-6 py-3 shadow">
      <p class="text-sm text-gray-700">è¨˜éŒ²æ™‚é–“</p>
      <p class="text-2xl font-bold" id="timer">00:00</p>
    </div>
  </div>

  <!-- Gå€¤ -->
  <div id="g-box" class="bg-card-light rounded-lg p-4 text-gray-800 shadow mb-8 w-72 text-center">
    æ¨ªGï¼š<span id="g-x">0.00</span>
    å‰å¾ŒGï¼š<span id="g-z">0.00</span>
    ä¸Šä¸‹Gï¼š<span id="g-y">0.00</span>
  </div>

  <!-- éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’ã€Œçµ‚äº†ãƒœã‚¿ãƒ³ã€ã®ä¸Šã«è¿½åŠ 
  <button id="recordBtn"
          class="bg-danger-red text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg hover:bg-red-500 transition mb-6">
    ğŸ™ éŒ²éŸ³é–‹å§‹ï¼ˆ5ç§’ï¼‰
  </button> -->

  <!-- ğŸ“ ãƒ”ãƒ³è¨­ç½®ãƒœã‚¿ãƒ³ -->
  <button id="addPinBtn" 
          style="position: fixed; bottom: 120px; right: 20px; 
                background-color: #00bcd4; color: white;
                border: none; border-radius: 50%; 
                width: 60px; height: 60px; 
                font-size: 28px; font-weight: bold; 
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
    ğŸ“
  </button>

  <!-- ğŸ¤ éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
  <button id="voiceToggleBtn"
          style="position: fixed; bottom: 120px; left: 20px;
                 background-color: #6b7280; color: white;
                 border: none; border-radius: 9999px;
                 height: 40px; padding: 0 14px; 
                 font-size: 14px; font-weight: 700;
                 box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
    ğŸ¤ éŸ³å£°OFF
  </button>

  <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
  <button id="end-button"
          class="bg-primary-green text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg hover:bg-cyan-400 transition">
    è¨˜éŒ²ã‚’çµ‚äº†ã™ã‚‹
  </button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
      storageBucket: "drive-prototype-32ef0.firebasestorage.app",
      messagingSenderId: "500916744769",
      appId: "1:500916744769:web:d5a529ef05d15bb2934cc0",
      measurementId: "G-9CH5CGYCFM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    const NEAR_THRESHOLD_METERS = 40; // âœ… é€šçŸ¥è·é›¢ï¼ˆ40mä»¥å†…ï¼‰

    let priorityPins = [];
    let notifiedPins = new Set(); // æ—¢ã«é€šçŸ¥æ¸ˆã¿ã®ãƒ”ãƒ³ã‚’è¨˜éŒ²
    let audioCtx, voiceBuffer;

    // === â‘  Firestoreã‹ã‚‰ãƒ”ãƒ³ã‚’èª­ã¿è¾¼ã¿ ===
    async function loadPriorityPinsForUser() {
      try {
        const userId = window.FLASK_USER_ID;
        const snapshot = await firebase.firestore()
          .collection("priority_pins")
          .where("user_id", "==", userId)
          .get();

        priorityPins = snapshot.docs.map(doc => ({
          id: doc.id,
          lat: doc.data().lat,
          lng: doc.data().lng
        }));

        console.log("ğŸ“ ãƒ­ãƒ¼ãƒ‰å®Œäº† priority_pins:", priorityPins);
      } catch (err) {
        console.error("âŒ ãƒ”ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—:", err);
      }
    }

    // === â‘¡ éŸ³å£°ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆ1å›ã®ã¿ï¼‰ ===
    async function loadVoice() {
      if (!window.audioContext) {
        window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      audioCtx = window.audioContext;
      const url = "{{ url_for('static', filename='audio/focus_near.mp3') }}"; // ã‚ãªãŸãŒç”¨æ„ã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
      const res = await fetch(url);
      const arrayBuffer = await res.arrayBuffer();
      voiceBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    }

    function playVoice() {
      if (!audioCtx || !voiceBuffer) return;
      const src = audioCtx.createBufferSource();
      src.buffer = voiceBuffer;
      src.connect(audioCtx.destination);
      src.start(0);
    }

    // === â‘¢ è·é›¢ã‚’è¨ˆç®—ï¼ˆHaversineå…¬å¼ï¼‰ ===
    function getDistanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆmï¼‰
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // === â‘£ ç¾åœ¨åœ°ã‚’ç›£è¦–ã—ã¦è·é›¢åˆ¤å®š ===
    function startProximityWatcher() {
      if (!navigator.geolocation) {
        alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
        return;
      }

      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;

        priorityPins.forEach(pin => {
          const dist = getDistanceMeters(latitude, longitude, pin.lat, pin.lng);

          if (dist < NEAR_THRESHOLD_METERS && !notifiedPins.has(pin.id)) {
            console.log(`ğŸ¯ ${dist.toFixed(1)}mä»¥å†…: é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆ ${pin.id}`);
            notifiedPins.add(pin.id);
            playVoice();
          }
        });
      }, err => {
        console.error("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:", err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }

    // === â‘¤ åˆæœŸåŒ– ===
    document.addEventListener("DOMContentLoaded", async () => {
      // ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯é€šçŸ¥ãƒ»éŸ³å£°ã‚’æŠ‘æ­¢
      const isRouteMode = localStorage.getItem('priorityRouteRecordingActive') === 'true';
      if (isRouteMode) {
        console.log('ğŸ”‡ Route mode active on recording_active: suppressing proximity voice alerts');
        return;
      }
      await loadPriorityPinsForUser();
      await loadVoice();
      startProximityWatcher();
      console.log("ğŸš— é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†");
    });
  </script>

  <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
  <!-- ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ï¼ˆå„ªå…ˆãƒ«ãƒ¼ãƒˆï¼‰ã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã«èª­ã¿è¾¼ã¿ -->
  <script src="{{ url_for('static', filename='route_recorder.js') }}"></script>
  <!--éŒ²éŸ³å†…å®¹-->
  <script>
    // ä¾‹ï¼šFlaskã‹ã‚‰Jinja2çµŒç”±ã§session_idã‚’åŸ‹ã‚è¾¼ã‚€
    window.sessionId = "{{ session_id }}";
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!--<script src="{{ url_for('static', filename='record.js') }}"></script>-->
  <!--<script src="{{ url_for('static', filename='record_voice.js') }}"></script>-->
  <script src="{{ url_for('static', filename='maps.js') }}"></script>
  <script src="{{ url_for('static', filename='session.js') }}"></script>
  <script src="{{ url_for('static', filename='pin_utils.js') }}"></script>
  <script src="{{ url_for('static', filename='record_voice_unified.js') }}"></script>
  <!-- AudioContextã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†ï¼ˆã“ã‚Œã¯æ®‹ã™ï¼‰ -->
  <script type="module">
    import { autoUnlockAudio } from "./audio.js";
    autoUnlockAudio();
  </script>
  <script>
    // ğŸ¤ ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã§éŸ³å£°èªè­˜ã‚’ON/OFF
    (function(){
      const btn = document.getElementById('voiceToggleBtn');
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        btn.style.display = 'none'; // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶
        return;
      }
      const update = () => {
        const active = window.voiceRecognition?.isActive?.() || false;
        btn.textContent = active ? 'ğŸ¤ éŸ³å£°ON' : 'ğŸ¤ éŸ³å£°OFF';
        btn.style.backgroundColor = active ? '#00bcd4' : '#6b7280';
      };
      btn.addEventListener('click', () => {
        const active = window.voiceRecognition?.isActive?.() || false;
        if (active) {
          window.voiceRecognition?.stop?.();
        } else {
          window.voiceRecognition?.start?.();
        }
        setTimeout(update, 300);
      });
      // ãƒšãƒ¼ã‚¸åˆæœŸã‚¿ãƒƒãƒ—ã§ä¸€åº¦ã ã‘ONï¼ˆAndroidå‘ã‘ï¼‰
      const startOnFirstTap = () => {
        try { window.voiceRecognition?.start?.(); } catch (e) {}
        update();
        window.removeEventListener('touchend', startOnFirstTap);
        window.removeEventListener('click', startOnFirstTap);
      };
      window.addEventListener('touchend', startOnFirstTap, { once: true });
      window.addEventListener('click', startOnFirstTap, { once: true });
      // åˆæœŸè¡¨ç¤º
      update();
    })();
  </script>
</body>
</html>
