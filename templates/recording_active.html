<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²ä¸­</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'primary-green': '#00bcd4',
        'danger-red': '#f44336',
        'bg-light': '#d8f5e3',
        'card-light': '#aafaff'
      },
      fontFamily: {
        sans: ['"Hiragino Maru Gothic ProN"', 'sans-serif']
      }
    }
  }
}
</script>
<style>
  /* ç”»é¢å¹…ã„ã£ã±ã„ã®æ­£å††ãƒœã‚¦ãƒ«ï¼ˆæœ€å¤§å¹… 420px ãã‚‰ã„ã«åˆ¶é™ï¼‰ */
  #gBowlArea {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: radial-gradient(circle,
          #303030 0%,
          #222 70%,
          #111 100%);
      border: 2px solid #555;
      z-index: 10;
      margin: 0 auto;
      display: block;      /* â† ã“ã‚Œã‚’è¿½åŠ  */
      transition: opacity 0.2s ease;
  }

  /* ä¸­ã®ãƒ­ãƒœãƒœãƒ¼ãƒ« */
  #gBall {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    overflow: hidden;
    z-index: 5;
    background: orange;
  }

  .gBallImg {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Gãƒªãƒ³ã‚° */
  .gRing {
    position: absolute;
    border: 1.4px solid rgba(255,255,255,0.35);
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
  }

  /* ãƒªãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠ */
  #gRings {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
  }

  /* ãƒ©ãƒ™ãƒ« */
  .gLabel {
    position: absolute;
    color: #8b8b8b;
    font-size: 12px;
    font-weight: 700;
    pointer-events: none;
    z-index: 2;
    padding: 2px 4px;
    border-radius: 4px;
    transform: translate(-50%, -50%); /* ä¸­å¤®åŸºæº–ã«ã™ã‚‹ */
  }

  #gTrailCanvas {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 2;   /* ãƒœã‚¦ãƒ« < è»Œè·¡ < ãƒœãƒ¼ãƒ« */
    pointer-events: none;
  }
</style>
</head>
<body class="bg-bg-light text-gray-800 font-sans flex flex-col items-center justify-center min-h-screen p-4" data-page="recording_active">

  <!-- è¨˜éŒ²ä¸­ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="recordingHeader"
      class="flex items-center gap-4 text-primary-green text-3xl font-bold mt-6 mb-4"
      style="display:none;">
    <span>è¨˜éŒ²ä¸­</span>
    <span id="timerInline" class="text-gray-700 text-2xl font-bold">00:00:00</span>
  </div>

  <!-- å¹ãå‡ºã—ï¼ˆãƒ«ãƒ¼ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã«ã ã‘è¡¨ç¤ºï¼‰ -->
  <div id="routeModeBubble" style="display:none;" class="relative bg-white rounded-2xl shadow-lg px-6 py-4 mb-4 max-w-xs mx-auto">
    <p class="text-center text-gray-800 font-semibold text-lg">ãƒ«ãƒ¼ãƒˆè¨­å®šä¸­ã§ã™</p>
    <div class="absolute left-1/2 transform -translate-x-1/2 -bottom-2 w-0 h-0" 
        style="border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 12px solid white;">
    </div>
  </div>

  <!-- ã‚­ãƒ£ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒ«ãƒ¼ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã«ã ã‘è¡¨ç¤ºï¼‰ -->
  <div id="routeModeRobot" class="w-36 h-36 rounded-full bg-white shadow-md flex items-center justify-center overflow-hidden mb-8"
      style="display:none;">
    <img src="{{ url_for('static', filename='img/robot_active.png') }}" alt="ãƒ­ãƒœãƒƒãƒˆ" class="object-cover w-full h-full">
  </div>

  <!-- G-Bowl ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="gBowlArea" class="mt-2 opacity-0 transition-opacity duration-300">
      <!-- Gãƒœãƒ¼ãƒ«ã®è»Œé“ -->
      <canvas id="gTrailCanvas"></canvas>
      <!-- Gãƒœãƒ¼ãƒ«ï¼ˆãƒ­ãƒœç”»åƒï¼‰ -->
      <div id="gBall">
        <img src="{{ url_for('static', filename='img/robot_orange.png') }}" class="gBallImg">
      </div>

      <!-- Gç›®ç››ãƒªãƒ³ã‚°ï¼ˆJSã§ç”Ÿæˆã™ã‚‹ï¼‰-->
      <div id="gRings"></div>
  </div>

  <!-- ==== Gå€¤ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º ==== -->
  <div id="gValueDisplay"
      class="mt-4 text-center text-xl font-bold text-gray-800"
      style="display:none;">
    <div>æ¨ªG (gx): <span id="g-x">0.00</span></div>
    <div>ä¸Šä¸‹G (gy): <span id="g-y">0.00</span></div>
    <div>å‰å¾ŒG (gz): <span id="g-z">0.00</span></div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆæœ€åˆã®ã‚¿ãƒƒãƒç”¨ï¼‰ -->
  <button id="startBtn"
    class="bg-primary-green text-white text-3xl font-bold rounded-full shadow-lg hover:bg-cyan-400 transition"
    style="width: 220px; height: 220px;">
    ã‚¹ã‚¿ãƒ¼ãƒˆ
  </button>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="controlButtons" style="display:none;" class="flex gap-6 mt-8 mb-4">
    <!-- ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ -->
    <button id="pauseBtn"
      class="bg-yellow-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-yellow-400 transition"
      style="min-width: 150px; min-height: 70px; padding: 16px 24px;">
      ä¸€æ™‚åœæ­¢
    </button>
    
    <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
    <button id="end-button"
            class="bg-danger-red text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-500 transition"
            style="min-width: 150px; min-height: 70px; padding: 16px 24px;">
      çµ‚äº†
    </button>
  </div>
  
  <!-- ä¸€æ™‚åœæ­¢ä¸­ã®è¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å†…ã«å†é–‹ãƒœã‚¿ãƒ³ã‚’é…ç½®ã—ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰ -->
  <div id="pausedOverlay" style="display:none;" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 shadow-lg text-center">
      <div class="text-2xl font-bold text-primary-green mb-6">è¨˜éŒ²ã¯ä¸€æ™‚åœæ­¢ä¸­ã§ã™</div>
      <button id="resumeBtn" class="bg-primary-green text-white text-xl font-bold rounded-xl shadow-lg hover:bg-cyan-400 transition"
              style="min-width: 150px; min-height: 70px; padding: 16px 32px;">
        å†é–‹
      </button>
    </div>
  </div>

  <!-- å¿µã®ãŸã‚æ®‹ã™ã‚¿ã‚¤ãƒãƒ¼ -->
  <span id="timer" style="display:none;"></span>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®å‹•ä½œ -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const endBtn   = document.getElementById("end-button");

    let hasStarted = false;

    startBtn.addEventListener("click", async () => {
      if (hasStarted) return;
      hasStarted = true;

      const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      // ğŸ”Š iOS ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¢ãƒ³ãƒ­ãƒƒã‚¯
      if (isiOS) {
        try {
          if (!window.audioContext) {
            window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (window.audioContext.state === "suspended") {
            await window.audioContext.resume();
          }

          const buffer = window.audioContext.createBuffer(1, 1, 22050);
          const source = window.audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(window.audioContext.destination);
          source.start(0);

          window.audioUnlocked = true;
          localStorage.setItem("audioUnlocked", "true");
        } catch(e) {
          console.warn("iOS audio unlock failed:", e);
        }
      }

      // ğŸ ãƒ«ãƒ¼ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š
      const isRouteMode = localStorage.getItem("priorityRouteRecordingActive") === "true";

      // ğŸ”¥ UI åˆ‡ã‚Šæ›¿ãˆ
      startBtn.style.display = "none";

      const ctrl = document.getElementById("controlButtons");
      if (ctrl) ctrl.style.display = "flex";

      const header = document.getElementById("recordingHeader");
      if (header) header.style.display = "";

      const timer = document.getElementById("timerDisplay");
      if (timer) timer.style.display = "";

      // === ğŸŸ¢ é€šå¸¸é‹è»¢ / ãƒ«ãƒ¼ãƒˆè¨­å®š ãƒ¢ãƒ¼ãƒ‰åˆ¥ã«è¡¨ç¤º ===
      const bowl = document.getElementById("gBowlArea");
      const routeBubble = document.getElementById("routeModeBubble"); // ãƒ«ãƒ¼ãƒˆç”¨ã®å¹ãå‡ºã—
      const routeRobot  = document.getElementById("routeModeRobot");  // ãƒ«ãƒ¼ãƒˆç”¨ãƒ­ãƒœ
      const gVal = document.getElementById("gValueDisplay");

      if (isRouteMode) {
        console.log("ğŸš— Route mode: show robot + bubble on start");

        // ğŸ”µ Gãƒœã‚¦ãƒ«ã¯éè¡¨ç¤º
        if (bowl) bowl.style.display = "none";

        // ğŸŸ¢ ãƒ«ãƒ¼ãƒˆè¨­å®šå°‚ç”¨ UI ã‚’è¡¨ç¤º
        if (routeBubble) routeBubble.style.display = "";
        if (routeRobot)  routeRobot.style.display = "";
      } else {
        console.log("ğŸš— Normal mode: show G-bowl");

        // ğŸ”µ é€šå¸¸é‹è»¢ã§ã¯ Gãƒœã‚¦ãƒ«è¡¨ç¤º
        if (bowl) bowl.classList.remove("opacity-0");

        // ğŸ”µ é€šå¸¸é‹è»¢ã®Gå€¤
        if (gVal) gVal.style.display = "";
      }
    });
  });
  </script>

  <!-- ä¸€æ™‚åœæ­¢ãƒ»å†é–‹æ©Ÿèƒ½ã®JS -->
  <script>
    let isPaused = false;
    function pauseRecording() {
      if (isPaused) return;
      isPaused = true;
      // reflect globally for timer logic
      try { window.isPaused = true; } catch (e) {}
      // pause timer: record pause start
      try {
        const now = Date.now();
        // set pauseStart to same reference time used to compute frozen to avoid timing drift
        window.pauseStart = now;
        try {
          const pausedMsSoFar = window.pauseAccumulatedMs || 0;
          const frozen = Math.max(0, now - (window.startTime || now) - pausedMsSoFar);
          // freeze to integer seconds (floor)
          window._frozenTimerMs = Math.floor(frozen/1000)*1000;
          console.log('â¸ pause at ms:', now, ' frozenMs:', window._frozenTimerMs, ' pausedMsSoFar:', pausedMsSoFar);
        } catch (e) { window._frozenTimerMs = null; }
        if (window.stopTimer) window.stopTimer();
        // immediately update DOM to frozen value
        try { if (window.updateTimerDisplay) window.updateTimerDisplay(); } catch (e) {}
      } catch (e) {}
      // åœæ­¢å¯¾è±¡: ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡ºã¨éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (window.stopMotionDetection) window.stopMotionDetection();
      // éŸ³å£°èªè­˜ã¯åœæ­¢ã—ãªã„ï¼ˆå†é–‹ã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹ãŸã‚ï¼‰
      // if (window.voiceRecognition?.stop) window.voiceRecognition.stop();
      document.getElementById('pausedOverlay').style.display = '';
      const controlButtons = document.getElementById('controlButtons');
      if (controlButtons) controlButtons.style.display = 'none';
      // éŒ²éŸ³ãƒœã‚¿ãƒ³ç­‰ã‚‚å¿…è¦ã«å¿œã˜ã¦ç„¡åŠ¹åŒ–
      const recordBtn = document.getElementById('recordBtn');
      if (recordBtn) recordBtn.disabled = true;
    }
    function resumeRecording() {
      if (!isPaused) return;
      isPaused = false;
      try { window.isPaused = false; } catch (e) {}
      // resume timer: accumulate paused duration and restart
      try {
        if (window.pauseStart) {
          window.pauseAccumulatedMs = (window.pauseAccumulatedMs || 0) + (Date.now() - window.pauseStart);
          window.pauseStart = null;
        }
        if (window.startTimer) window.startTimer();
        // clear frozen display value and force immediate update to avoid short freeze
        try { window._frozenTimerMs = null; } catch (e) {}
        try { if (window.updateTimerDisplay) window.updateTimerDisplay(); } catch (e) {}
      } catch (e) {}
      if (window.startMotionDetection) window.startMotionDetection();
      // éŸ³å£°èªè­˜ã¯æ—¢ã«å‹•ã„ã¦ã„ã‚‹ã‹ã€å¿…è¦ãªã‚‰å†èµ·å‹•
      try { if (window.voiceRecognition?.start) window.voiceRecognition.start(); } catch(e){}
      document.getElementById('pausedOverlay').style.display = 'none';
      const controlButtons = document.getElementById('controlButtons');
      if (controlButtons) controlButtons.style.display = '';
      const recordBtn = document.getElementById('recordBtn');
      if (recordBtn) recordBtn.disabled = false;
      // è‡ªå‹•ä¸€æ™‚åœæ­¢ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      try { window.autoPausedByVisibility = false; } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', function() {
      const pauseBtn = document.getElementById('pauseBtn');
      const resumeBtn = document.getElementById('resumeBtn');
      const endBtn = document.getElementById('end-button');
      if (pauseBtn) pauseBtn.onclick = pauseRecording;
      if (resumeBtn) resumeBtn.onclick = resumeRecording;
      // çµ‚äº†ãƒœã‚¿ãƒ³ã¯æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨
    });
    // éŸ³å£°èªè­˜ã‚³ãƒãƒ³ãƒ‰é€£æº
    window._origVoiceOnResult = window.voiceRecognition?.onresult;
    function voicePauseResumeHandler(event) {
      try {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        if (transcript.includes('åœæ­¢')) pauseRecording();
        if (transcript.includes('å†é–‹')) resumeRecording();
      } catch(e) {}
      if (typeof window._origVoiceOnResult === 'function') window._origVoiceOnResult(event);
    }
    // If voiceRecognition already exists, attach handler; otherwise attach when DOM is ready
    function attachVoiceHandlerIfAvailable() {
      try {
        if (window.voiceRecognition) {
          window._origVoiceOnResult = window.voiceRecognition.onresult;
          window.voiceRecognition.onresult = voicePauseResumeHandler;
          console.log('ğŸ”Š voicePauseResumeHandler attached');
          return true;
        }
      } catch (e) { console.warn(e); }
      return false;
    }
    if (!attachVoiceHandlerIfAvailable()) {
      document.addEventListener('DOMContentLoaded', () => {
        attachVoiceHandlerIfAvailable();
      });
    }

    
  </script>
    
  <script>
  // ãƒœãƒ¼ãƒ«ã®è»Œé“
  (function(){
      const canvas = document.getElementById("gTrailCanvas");
      const ball = document.getElementById("gBall");

      let ctx = null;
      let width = 0;
      let height = 0;

      function resizeCanvas() {
          if (!canvas) return;
          const rect = canvas.parentElement.getBoundingClientRect();
          canvas.width = rect.width;
          canvas.height = rect.height;
          width = rect.width;
          height = rect.height;

          ctx = canvas.getContext("2d");
          ctx.lineWidth = 4;
          ctx.lineCap = "round";
      }

      window.addEventListener("load", resizeCanvas);
      window.addEventListener("resize", resizeCanvas);

      let lastX = null;
      let lastY = null;

      // === è»Œè·¡ãƒœãƒ¼ãƒ« ===
      let trailBalls = [];

      function drawTrail() {
          const cfg = window._gBowlConfig;
          if (!cfg) {
              requestAnimationFrame(drawTrail);
              return;
          }

          const gx = window.smoothBallGX ?? 0;
          const gz = window.smoothBallGZ ?? 0;

          const { CENTER, SCALE, MAX_R } = cfg;

          let px = gx * SCALE;
          let py = gz * SCALE;

          // ğŸŸ¡ è¿½åŠ ï¼šã¾ãšè·é›¢ã‚’ç®—å‡º
          const dist = Math.sqrt(px * px + py * py);

          // ğŸ›‘ ç¯„å›²å¤–ãªã‚‰è»Œé“ã‚’æã‹ãªã„
          if (dist > MAX_R) {
              // ãƒ­ãƒœã®ãƒœãƒ¼ãƒ«ã¯ã‚¯ãƒ©ãƒ³ãƒ—ã•ã‚Œã¦æç”»ã•ã‚Œã‚‹ â†’ ã§ã‚‚è»Œé“ã¯å‡ºã•ãªã„
              requestAnimationFrame(drawTrail);
              return;
          }

          const x = CENTER + px;
          const y = CENTER + py;

          // --- è»Œè·¡ãƒœãƒ¼ãƒ«ã‚’è¿½åŠ  ---
          trailBalls.push({
              x: x,
              y: y,
              alpha: 0.40,
              scale: 1.0
          });

          // --- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ & ç¸®å° ---
          trailBalls = trailBalls
              .map(b => ({
                  ...b,
                  alpha: b.alpha - 0.015,
                  scale: b.scale - 0.015
              }))
              .filter(b => b.alpha > 0 && b.scale > 0);

          // --- Canvas ã‚¯ãƒªã‚¢ ---
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // --- æç”» ---
          const BASE_SIZE = 72;

          for (const b of trailBalls) {
              const size = BASE_SIZE * b.scale;

              ctx.beginPath();
              ctx.fillStyle = `rgba(255,153,51, ${b.alpha})`;
              ctx.arc(b.x, b.y, size / 2, 0, Math.PI * 2);
              ctx.fill();
          }

          requestAnimationFrame(drawTrail);
      }

      requestAnimationFrame(drawTrail);
  })();
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
      storageBucket: "drive-prototype-32ef0.firebasestorage.app",
      messagingSenderId: "500916744769",
      appId: "1:500916744769:web:d5a529ef05d15bb2934cc0",
      measurementId: "G-9CH5CGYCFM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    const NEAR_THRESHOLD_METERS = 40; // âœ… é€šçŸ¥è·é›¢ï¼ˆ40mä»¥å†…ï¼‰

    let priorityPins = [];
    let notifiedPins = new Set(); // æ—¢ã«é€šçŸ¥æ¸ˆã¿ã®ãƒ”ãƒ³ã‚’è¨˜éŒ²
    let audioCtx, voiceBuffer;

    // === â‘  Firestoreã‹ã‚‰ãƒ”ãƒ³ã‚’èª­ã¿è¾¼ã¿ ===
    async function loadPriorityPinsForUser() {
      try {
        const userId = window.FLASK_USER_ID;
        const snapshot = await firebase.firestore()
          .collection("priority_pins")
          .where("user_id", "==", userId)
          .get();

        priorityPins = snapshot.docs.map(doc => ({
          id: doc.id,
          lat: doc.data().lat,
          lng: doc.data().lng
        }));

        console.log("ğŸ“ ãƒ­ãƒ¼ãƒ‰å®Œäº† priority_pins:", priorityPins);
      } catch (err) {
        console.error("âŒ ãƒ”ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—:", err);
      }
    }

    // === â‘¡ éŸ³å£°ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆ1å›ã®ã¿ï¼‰ ===
    async function loadVoice() {
      if (!window.audioContext) {
        window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      audioCtx = window.audioContext;
      const url = "{{ url_for('static', filename='audio/focus_near.wav') }}"; // ã‚ãªãŸãŒç”¨æ„ã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«
      const res = await fetch(url);
      const arrayBuffer = await res.arrayBuffer();
      voiceBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    }

    function playVoice() {
      if (!audioCtx || !voiceBuffer) return;
      const src = audioCtx.createBufferSource();
      src.buffer = voiceBuffer;
      src.connect(audioCtx.destination);
      src.start(0);
    }

    // === â‘¢ è·é›¢ã‚’è¨ˆç®—ï¼ˆHaversineå…¬å¼ï¼‰ ===
    function getDistanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆmï¼‰
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // === â‘£ ç¾åœ¨åœ°ã‚’ç›£è¦–ã—ã¦è·é›¢åˆ¤å®š ===
    function startProximityWatcher() {
      if (!navigator.geolocation) {
        alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
        return;
      }

      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;

        priorityPins.forEach(pin => {
          const dist = getDistanceMeters(latitude, longitude, pin.lat, pin.lng);

          if (dist < NEAR_THRESHOLD_METERS && !notifiedPins.has(pin.id)) {
            console.log(`ğŸ¯ ${dist.toFixed(1)}mä»¥å†…: é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆ ${pin.id}`);
            notifiedPins.add(pin.id);
            playVoice();
          }
        });
      }, err => {
        console.error("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:", err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }

    // === â‘¤ åˆæœŸåŒ– ===
    document.addEventListener("DOMContentLoaded", async () => {
      // ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯é€šçŸ¥ãƒ»éŸ³å£°ã‚’æŠ‘æ­¢
      const isRouteMode = localStorage.getItem('priorityRouteRecordingActive') === 'true';
      if (isRouteMode) {
        console.log('ğŸ”‡ Route mode active on recording_active: suppressing proximity voice alerts');
        return;
      }
      await loadPriorityPinsForUser();
      await loadVoice();
      startProximityWatcher();
      console.log("ğŸš— é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†");
    });
  </script>
  <!--éŒ²éŸ³å†…å®¹-->
  <script>
    // ä¾‹ï¼šFlaskã‹ã‚‰Jinja2çµŒç”±ã§session_idã‚’åŸ‹ã‚è¾¼ã‚€
    window.sessionId = "{{ session_id }}";
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!--<script src="{{ url_for('static', filename='record.js') }}"></script>-->
  <!--<script src="{{ url_for('static', filename='record_voice.js') }}"></script>-->
  <!-- éŸ³å£°èªè­˜æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã®èª¤å‹•ä½œé˜²æ­¢ï¼‰
  <script src="{{ url_for('static', filename='record_voice_unified.js') }}"></script>
  -->
  <!-- iOSå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éŸ³å£°å†ç”Ÿ -->
  <script type="module" src="{{ url_for('static', filename='audio_ios_fallback.js') }}"></script>
  <script>
    // æ‰‹å‹•éŒ²éŸ³ãƒœã‚¿ãƒ³ / æ‰‹å‹•ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã®é…ç·š
    (function(){
      // ğŸ™ æ‰‹å‹•éŒ²éŸ³
      const recordBtn = document.getElementById('recordBtn');
      if (recordBtn) {
        recordBtn.addEventListener('click', async () => {
          try {
            await startRecordingAndUpload();
          } catch(e) {
            console.error('æ‰‹å‹•éŒ²éŸ³ã«å¤±æ•—:', e);
            alert('éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯æ¨©é™ã‚„HTTPSæ¥ç¶šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
          }
        });
      }

      // ğŸ“ æ‰‹å‹•ãƒ”ãƒ³
      const addPinBtn = document.getElementById('addPinBtn');
      if (addPinBtn) {
        addPinBtn.addEventListener('click', async () => {
          try {
            if (!navigator.geolocation) {
              alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“ã€‚');
              return;
            }
            addPinBtn.disabled = true;
            navigator.geolocation.getCurrentPosition((pos) => {
              const { latitude, longitude } = pos.coords;
              const now = new Date();
              const dateString = now.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
              const timeString = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
              const label = `æ‰‹å‹•ãƒ”ãƒ³ ${dateString} ${timeString}`;
              if (window.addVoicePinWithOptions) {
                window.addVoicePinWithOptions(latitude, longitude, label, false, 'manual_pin');
              }
              // çŸ­ã„ãƒ“ãƒ¼ãƒ—ï¼ˆä»»æ„ï¼‰
              try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, ctx.currentTime);
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.10);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + 0.10);
              } catch (_) {}
            }, (err) => {
              console.error('ç¾åœ¨åœ°å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
              alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½ç½®æƒ…å ±ã®æ¨©é™ã‚„è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            }, { enableHighAccuracy: false, timeout: 10000, maximumAge: 30000 });
          } finally {
            addPinBtn.disabled = false;
          }
        });
      }
    })();
  </script>
  <!-- è‡ªå‹•ä¸€æ™‚åœæ­¢ï¼ˆvisibilityï¼‰ã¨ãƒãƒƒãƒ•ã‚¡æ°¸ç¶šåŒ– -->
  <script>
    (function(){
      // ãƒãƒƒãƒ•ã‚¡ä¿å­˜ã‚­ãƒ¼
      const G_BUFFER_KEY = 'drivebuddy_gLogBuffer_v1';
      const AVG_G_BUFFER_KEY = 'drivebuddy_avgGLogBuffer_v1';
      const SAVE_INTERVAL_MS = 5000;
      let saveIntervalId = null;
      let autoPausedByVisibility = false;

      // å®‰å…¨ã«ãƒãƒƒãƒ•ã‚¡ã‚’å–å¾—/åˆæœŸåŒ–
      if (!window.gLogBuffer) window.gLogBuffer = [];
      if (!window.avgGLogBuffer) window.avgGLogBuffer = [];

      // JSONã‚»ãƒ¼ãƒ•åŒ–ï¼ˆå¾ªç’°å‚ç…§å¯¾ç­–ã¯ã“ã“ã§ã¯ä¸è¦ï¼‰
      function safeStringify(obj, maxLen = 200000) {
        try {
          const s = JSON.stringify(obj);
          return s.length > maxLen ? s.slice(s.length - maxLen) : s; // keep tail
        } catch (e) {
          try { return JSON.stringify([]); } catch (_) { return '[]'; }
        }
      }

      function persistBuffers() {
        try {
          // ä¿å­˜ã™ã‚‹é‡ã‚’åˆ¶é™ï¼ˆç›´è¿‘Nä»¶ï¼‰
          const tail = (arr, n) => arr.slice(Math.max(0, arr.length - n));
          localStorage.setItem(G_BUFFER_KEY, safeStringify(tail(window.gLogBuffer || [], 2000)));
          localStorage.setItem(AVG_G_BUFFER_KEY, safeStringify(tail(window.avgGLogBuffer || [], 2000)));
          // console.log('ğŸ” buffers persisted', (window.gLogBuffer||[]).length, (window.avgGLogBuffer||[]).length);
        } catch (e) {
          console.warn('âš ï¸ persistBuffers failed', e);
        }
      }

      function restoreBuffers() {
        try {
          const gJson = localStorage.getItem(G_BUFFER_KEY);
          const avgJson = localStorage.getItem(AVG_G_BUFFER_KEY);
          if (gJson) {
            const parsed = JSON.parse(gJson);
            if (Array.isArray(parsed) && parsed.length) {
              window.gLogBuffer = (window.gLogBuffer || []).concat(parsed);
              console.log('â™»ï¸ restored gLogBuffer items:', parsed.length);
            }
          }
          if (avgJson) {
            const parsed2 = JSON.parse(avgJson);
            if (Array.isArray(parsed2) && parsed2.length) {
              window.avgGLogBuffer = (window.avgGLogBuffer || []).concat(parsed2);
              console.log('â™»ï¸ restored avgGLogBuffer items:', parsed2.length);
            }
          }
        } catch (e) {
          console.warn('âš ï¸ restoreBuffers failed', e);
        }
      }

      // visibilitychange ãƒãƒ³ãƒ‰ãƒ©
      function handleVisibilityChange() {
        if (document.hidden) {
          // è‡ªå‹•ã§ä¸€æ™‚åœæ­¢ã™ã‚‹
          try {
            if (!isPaused) {
              autoPausedByVisibility = true;
              pauseRecording();
              console.log('â¸ auto pause due to visibilityhidden');
            }
          } catch (e) { console.warn(e); }
          // å³åº§ã«ãƒãƒƒãƒ•ã‚¡ã‚’ä¿å­˜
          persistBuffers();
        } else {
          // ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€å¾©å¸°ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«ä»»ã›ã‚‹
          if (autoPausedByVisibility) {
            // UI: resume ãƒœã‚¿ãƒ³ã‚’ç›®ç«‹ãŸã›ã‚‹
            try {
              document.getElementById('resumeBtn').style.display = '';
              document.getElementById('pausedOverlay').style.display = '';
            } catch (e) {}
            console.log('â–¶ï¸ visible again - kept paused (autoPausedByVisibility=true)');
          }
          // å¾©å…ƒã‚’è©¦ã¿ã‚‹
          restoreBuffers();
        }
      }

      // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹/ç§»å‹•ã™ã‚‹å‰ã«ãƒãƒƒãƒ•ã‚¡ä¿å­˜
      function handlePageHide() { persistBuffers(); }

      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('pagehide', handlePageHide);
      window.addEventListener('beforeunload', handlePageHide);

      // å®šæœŸä¿å­˜ã®é–‹å§‹
      saveIntervalId = setInterval(persistBuffers, SAVE_INTERVAL_MS);

      // restore on load
      document.addEventListener('DOMContentLoaded', () => {
        try { restoreBuffers(); } catch (e) {}
      });

      // expose for debugging
      window._drivebuddy_persistBuffers = persistBuffers;
      window._drivebuddy_restoreBuffers = restoreBuffers;
    })();
  </script>
  <script>
    // ğŸ¤ ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã§éŸ³å£°èªè­˜ã‚’ON/OFF - è¨˜éŒ²ä¸­ã¯ç„¡åŠ¹åŒ–
    (function(){
      const btn = document.getElementById('voiceToggleBtn');
      
      /* === éŸ³å£°èªè­˜æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã®èª¤å‹•ä½œé˜²æ­¢ï¼‰ ===
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        btn.style.display = 'none'; // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶
        return;
      }
      const update = () => {
        const active = window.voiceRecognition?.isActive?.() || false;
        btn.textContent = active ? 'ğŸ¤ éŸ³å£°ON' : 'ğŸ¤ éŸ³å£°OFF';
        btn.style.backgroundColor = active ? '#00bcd4' : '#6b7280';
      };
      btn.addEventListener('click', () => {
        const active = window.voiceRecognition?.isActive?.() || false;
        if (active) {
          window.voiceRecognition?.stop?.();
        } else {
          window.voiceRecognition?.start?.();
        }
        setTimeout(update, 300);
      });
      // ãƒšãƒ¼ã‚¸åˆæœŸã‚¿ãƒƒãƒ—ã§ä¸€åº¦ã ã‘ONï¼ˆAndroidå‘ã‘ï¼‰
      const startOnFirstTap = () => {
        try { window.voiceRecognition?.start?.(); } catch (e) {}
        update();
        window.removeEventListener('touchend', startOnFirstTap);
        window.removeEventListener('click', startOnFirstTap);
      };
      window.addEventListener('touchend', startOnFirstTap, { once: true });
      window.addEventListener('click', startOnFirstTap, { once: true });
      // åˆæœŸè¡¨ç¤º
      update();
      === éŸ³å£°èªè­˜æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã®èª¤å‹•ä½œé˜²æ­¢ï¼‰ === */
      
      // éŸ³å£°èªè­˜æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ– - ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹çŠ¶æ…‹ã§è¡¨ç¤º
      if (btn) {
        btn.textContent = 'ğŸš« éŸ³å£°ç„¡åŠ¹';
        btn.style.backgroundColor = '#9ca3af';
        btn.style.cursor = 'not-allowed';
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ğŸš« éŸ³å£°èªè­˜æ©Ÿèƒ½ã¯è¨˜éŒ²ä¸­ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
          alert('éŸ³å£°èªè­˜æ©Ÿèƒ½ã¯è¨˜éŒ²ä¸­ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
        });
      }
    })();
  </script>
  <!-- è¨˜éŒ²ä¸­ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ãŸã ã‘ã§ãƒã‚¤ã‚¯è¨±å¯â†’éŸ³å£°èµ·å‹•ã‚’è©¦ã¿ã‚‹ï¼ˆAndroidå‘ã‘ï¼‰ - ç„¡åŠ¹åŒ– -->
  <script type="module">
    /* === éŸ³å£°èªè­˜è‡ªå‹•é–‹å§‹æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã®èª¤å‹•ä½œé˜²æ­¢ï¼‰ ===
    import { requestMicrophone } from "{{ url_for('static', filename='permissions.js') }}";
    (async () => {
      try {
        if (localStorage.getItem('perm_mic') !== 'granted') {
          const res = await requestMicrophone();
          console.log('ğŸ” requestMicrophone result:', res);
        }
      } catch (e) { console.warn('requestMicrophone failed:', e); }
      try {
        // ã™ãã«éŸ³å£°ã‚³ãƒãƒ³ãƒ‰å¾…å—ã‚’é–‹å§‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å«ã‚€ï¼‰
        window.voiceRecognition?.start?.();
      } catch (e) { console.warn('voiceRecognition.start failed:', e); }
    })();
    === éŸ³å£°èªè­˜è‡ªå‹•é–‹å§‹æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã®èª¤å‹•ä½œé˜²æ­¢ï¼‰ === */
    console.log('ğŸš« éŸ³å£°èªè­˜è‡ªå‹•é–‹å§‹æ©Ÿèƒ½ã¯è¨˜éŒ²ä¸­ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
  </script>
  <!-- ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã™ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // =====================================
    //  Gãƒªãƒ³ã‚°ç”Ÿæˆï¼ˆ0.1G ï½ 0.5Gï¼‰â€»ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    // =====================================
    (function () {
      const area          = document.getElementById("gBowlArea");
      const ringContainer = document.getElementById("gRings");
      const ball          = document.getElementById("gBall");

      function rebuildRings() {
        if (!area || !ringContainer || !ball) return;

        const rect   = area.getBoundingClientRect();
        const AREA   = rect.width;          // æ­£å††ãªã®ã§ width = height
        const CENTER = AREA / 2;
        const BALL_R = ball.getBoundingClientRect().width / 2 || 24;
        const MAX_R  = CENTER - BALL_R;     // ãƒœãƒ¼ãƒ«ã®ç«¯ãŒãµã¡ã«å±Šãä½ç½®ã‚’0.5Gã«
        const SCALE  = MAX_R / 0.5;         // 0.5G â†’ MAX_R

        // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ä¿å­˜
        window._gBowlConfig = { AREA, CENTER, BALL_R, MAX_R, SCALE };

        // æ—¢å­˜ãƒªãƒ³ã‚°ãƒ»ãƒ©ãƒ™ãƒ«ã‚¯ãƒªã‚¢
        ringContainer.innerHTML = "";

        for (let g = 0.1; g <= 0.5 + 0.0001; g += 0.1) {
          const radiusPx = g * SCALE;

          const ring = document.createElement("div");
          ring.className = "gRing";
          ring.style.width  = (radiusPx * 2) + "px";
          ring.style.height = (radiusPx * 2) + "px";
          ring.style.left   = CENTER + "px";
          ring.style.top    = CENTER + "px";

          const label = document.createElement("div");
          label.className   = "gLabel";
          label.textContent = g.toFixed(1) + "G";
          label.style.left  = CENTER + "px";
          label.style.top   = (CENTER - radiusPx) + "px";

          ringContainer.appendChild(ring);
          ringContainer.appendChild(label);
        }
      }

      window.addEventListener("load", rebuildRings);
      window.addEventListener("resize", () => {
        clearTimeout(window._gBowlResizeTimer);
        window._gBowlResizeTimer = setTimeout(rebuildRings, 150);
      });
    })();

    // =====================================
    //  ãƒœãƒ¼ãƒ«ç§»å‹•ï¼ˆlatestGX / latestGZ ã‚’ä½¿ç”¨ï¼‰
    // =====================================
    (function(){
      const ball = document.getElementById("gBall");

      function updateGBall(){
        const cfg = window._gBowlConfig;
        if (!ball || !cfg) {
          requestAnimationFrame(updateGBall);
          return;
        }

        const { CENTER, MAX_R, SCALE } = cfg;

        const gx = window.smoothBallGX ?? 0;
        const gz = window.smoothBallGZ ?? 0;

        let px = gx * SCALE;
        let py = gz * SCALE;

        // 0.5G ã‚’è¶…ãˆãŸã‚‰å¤–å‘¨ã§ã‚¯ãƒ©ãƒ³ãƒ—
        const dist = Math.sqrt(px * px + py * py);
        if (dist > MAX_R){
          const r = MAX_R / dist;
          px *= r;
          py *= r;
        }

        ball.style.left = (CENTER + px) + "px";
        ball.style.top  = (CENTER + py) + "px";

        requestAnimationFrame(updateGBall);
      }

      requestAnimationFrame(updateGBall);
    })();
  </script>
  <script src="{{ url_for('static', filename='state.js') }}"></script>
  <script src="{{ url_for('static', filename='sensors.js') }}"></script>
  <script src="{{ url_for('static', filename='session.js') }}"></script>
  <script src="{{ url_for('static', filename='maps.js') }}"></script>
  <script src="{{ url_for('static', filename='pin_utils.js') }}"></script>
  <script src="{{ url_for('static', filename='route_recorder.js') }}"></script>

  <!-- ã“ã‚ŒãŒä¸€ç•ªæœ€å¾Œ -->
  <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
