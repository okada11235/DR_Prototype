<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - ãƒ›ãƒ¼ãƒ </title>

  <!-- âœ… Bootstrapã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã‚ŒãŒå¿…é ˆï¼‰ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #cdeae0;
      color: #333;
      padding-bottom: 55px; /* ãƒŠãƒ“åˆ†ã®ä½™ç™½ */
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-area img {
      width: 50px;
      height: 50px;
    }

    .title {
      font-size: 1.5em;
      font-weight: bold;
      color: #2090c2;
    }

    .logout {
      color: #e44d8f;
      font-weight: bold;
      font-size: 0.9em;
    }

    .main {
      text-align: center;
      padding: 20px;
    }

    .robot {
      width: 70px;
      height: auto;
      border-radius: 50%;
      object-fit: cover;
      background-color: #fff;
    }

    .message-box {
      background-color: #fff;
      border-radius: 5px;
      padding: 10px;
      width: 85%;
      margin: 10px auto;
      text-align: left;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* â–¼ å¤©æ°—ãƒœãƒƒã‚¯ã‚¹ç”¨ã®èª¿æ•´ã‚¹ã‚¿ã‚¤ãƒ« â–¼ */
    .weather-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
      color: #555;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .weather-icon {
        background-color: #e0f0f5;
        border-radius: 50%;
        display: block; /* imgã‚’ä¸­å¤®æƒãˆå¯èƒ½ã«ã™ã‚‹ */
    }
    .text-xs { font-size: 0.75rem; } /* å°ã•ã„æ–‡å­—ã‚µã‚¤ã‚º */
    .text-sm { font-size: 0.875rem; } /* ã‚„ã‚„å°ã•ã„æ–‡å­—ã‚µã‚¤ã‚º */
    /* â–² èª¿æ•´ã‚¹ã‚¿ã‚¤ãƒ«ã“ã“ã¾ã§ â–² */


    .custom-nav-bar{background:#378da0;border-top:2px solid #5a7d8d;box-shadow:inset 0 0 5px rgba(0,0,0,.2);height:45px}
    .custom-nav-link{color:#fff;font-weight:bold;font-size:1rem;padding:0 1rem;line-height:41px;height:100%;display:block}
    .custom-nav-item:not(:last-child){border-right:1px solid #5a7d8d}
    .active-glow .custom-nav-link.active{color:rgb(0, 0, 0);background:rgba(255,255,255,.05)}
  </style>
</head>
<body>

  <header>
    <div class="logo-area">
      <img src="{{ url_for('static', filename='img/icon.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ãƒ­ã‚´">
      <div class="title">ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</div>
      <p>Ver 25/12/2</p>
    </div>

    <div class="account-info" style="text-align:right;">
      <div style="font-size: 0.9em; color: #555;">
        <span style="color:#007e99;">
          {{ current_user.name or current_user.username or current_user.id }}
        </span>
      </div>
      <a href="{{ url_for('auth.logout') }}" class="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
  </header>

  <main class="main">
    <img src="{{ url_for('static', filename='img/robot.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot">

    <!-- â–¼ å¤©æ°—æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ â–¼ -->
    <div class="message-box" id="weather-box">
      <div class="weather-header">
        <strong>ç¾åœ¨åœ°ã®å¤©æ°—ã¨äºˆæ¸¬</strong>
        <span id="weather-location">ï¼ˆå–å¾—ä¸­...ï¼‰</span>
      </div>
      <!-- æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ç¾åœ¨ã¨3æ™‚é–“å¾Œã‚’ä¸¦åˆ—è¡¨ç¤º -->
      <div class="d-flex justify-content-around align-items-center text-center">
        
        <!-- 1. ç¾åœ¨ã®å¤©æ°— -->
        <div class="flex-fill">
          <div class="text-sm font-weight-bold text-secondary mb-1">ç¾åœ¨</div>
          <img id="weather-icon" src="https://placehold.co/50x50/ffffff/cdeae0?text=..." alt="å¤©æ°—" class="mx-auto weather-icon" style="width: 50px; height: 50px;">
          <div class="mt-1">
              <span id="weather-temp" class="text-lg font-weight-bold" style="color:#2090c2;">--â„ƒ</span>
          </div>
          <span id="weather-desc" class="text-xs">---</span>
        </div>
        
        <!-- åŒºåˆ‡ã‚Šç·š -->
        <div class="vr h-16 mx-2" style="color: #ddd;"></div>

        <!-- 2. 3æ™‚é–“å¾Œã®äºˆæ¸¬ -->
        <div class="flex-fill">
          <div class="text-sm font-weight-bold text-secondary mb-1">
            3æ™‚é–“å¾Œ (<span id="forecast-3h-time">--:--</span>)
          </div>
          <img id="weather-icon-3h" src="https://placehold.co/50x50/ffffff/cdeae0?text=..." alt="3æ™‚é–“å¾Œå¤©æ°—" class="mx-auto weather-icon" style="width: 50px; height: 50px;">
          <div class="mt-1">
              <span id="weather-temp-3h" class="text-lg font-weight-bold" style="color:#e44d8f;">--â„ƒ</span>
          </div>
          <span id="weather-desc-3h" class="text-xs">---</span>
        </div>
      </div>
    </div>
    <!-- â–² å¤©æ°—æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ â–² -->

    <!-- â–¼ å¤©æ°—ã‚¢ãƒ‰ãƒã‚¤ã‚¹ (æœ€åˆã¯éè¡¨ç¤º) â–¼ -->
    <div class="message-box" id="weather-advice-box" style="display: none;">
      <p id="weather-advice-text"></p>
    </div>
    <!-- â–² å¤©æ°—ã‚¢ãƒ‰ãƒã‚¤ã‚¹ â–² -->

    <div class="message-box text-center mt-4" style="background:#fefefe;">
      <p class="mb-2" style="font-size:0.95rem;">
        ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ã‚’ä½¿ã£ã¦ã¿ã¦ã€ã©ã†æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ<br>
        æ”¹å–„ç‚¹ã‚„æ„Ÿæƒ³ã‚’ãœã²æ•™ãˆã¦ãã ã•ã„ï¼<br>
        å†™çœŸãŒã‚ã£ã¦ã‚‚ã„ã„ã§ã™ğŸ“¸
      </p>
      <a href="{{ url_for('views.feedback') }}"
        class="btn btn-outline-primary btn-sm px-3">
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹ ğŸ’¬
      </a>
    </div>

  </main>

  <!-- âœ… result.htmlã¨åŒã˜ä¸‹éƒ¨ãƒŠãƒ“ -->
  <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a class="nav-link custom-nav-link active" href="{{ url_for('views.home') }}">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('views.recording_start') }}" class="nav-link custom-nav-link">é‹è»¢</a>
        </li>
        <!-- âœ… ã“ã“ã« active-glow ã‚’ä»˜ã‘ã‚‹ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ãŒâ€œãƒªã‚¶ãƒ«ãƒˆâ€ãªã‚‰ï¼‰ -->
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('sessions.results_page') }}" class="nav-link custom-nav-link">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item border-end-0">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.explain') }}">èª¬æ˜</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- âœ… Bootstrapã®JSã‚‚å…¥ã‚Œã‚‹ï¼ˆå¿µã®ãŸã‚ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- âœ… å¤©æ°—æƒ…å ±å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1. APIã‚­ãƒ¼ï¼ˆ!!ã”è‡ªèº«ã®ã‚­ãƒ¼ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„!!ï¼‰
      // OpenWeatherMapã®ç„¡æ–™APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™
      // !!! ã“ã“ã«æ–°ã—ãç”Ÿæˆã—ãŸAPIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ !!!
      const OWM_API_KEY = '21e24128ecb01f604c8181f7cece2285'; 

      // **********************************************
      // !!! ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¼·åˆ¶è¡¨ç¤ºãƒ•ãƒ©ã‚° (è§£é™¤æ¸ˆã¿) !!!
      // ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€å¿…ãš false ã«æˆ»ã™ã‹ã€ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
      const TEST_ADVICE_MODE = false; 
      // **********************************************

      // 2. DOMè¦ç´ ã®å–å¾—
      // ç¾åœ¨ã®å¤©æ°—
      const weatherLocationEl = document.getElementById('weather-location');
      const weatherIconEl = document.getElementById('weather-icon');
      const weatherTempEl = document.getElementById('weather-temp');
      const weatherDescEl = document.getElementById('weather-desc');
      // 3æ™‚é–“å¾Œã®å¤©æ°— (æ–°è¦è¿½åŠ )
      const weatherIcon3hEl = document.getElementById('weather-icon-3h');
      const weatherTemp3hEl = document.getElementById('weather-temp-3h');
      const weatherDesc3hEl = document.getElementById('weather-desc-3h');
      const forecast3hTimeEl = document.getElementById('forecast-3h-time');

      const weatherAdviceBoxEl = document.getElementById('weather-advice-box');
      const weatherAdviceTextEl = document.getElementById('weather-advice-text');

      // 3. ä½ç½®æƒ…å ±ã®å–å¾—
      if (navigator.geolocation) {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10ç§’ã«è¨­å®š
        const options = { timeout: 10000 };
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, options);
      } else {
        weatherLocationEl.textContent = 'ï¼ˆä½ç½®æƒ…å ±ãŒåˆ©ç”¨ä¸å¯ï¼‰';
      }

      // 4. ä½ç½®æƒ…å ±å–å¾—æˆåŠŸæ™‚ã®å‡¦ç†
      async function onLocationSuccess(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        let locationName = null; // éƒ½å¸‚åã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
        
        // 4-1. ã€è¿½åŠ ã€‘éƒ½å¸‚åã‚’å–å¾—ã™ã‚‹ãŸã‚ã« Current Weather API (2.5) ã‚’å‘¼ã³å‡ºã™
        const locationApiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&lang=ja`;
        try {
            const locationResponse = await fetch(locationApiUrl);
            if (locationResponse.ok) {
                const locationData = await locationResponse.json();
                locationName = locationData.name || `ç·¯åº¦:${lat.toFixed(2)}, çµŒåº¦:${lon.toFixed(2)}`;
            } else {
                console.warn('éƒ½å¸‚åå–å¾—APIå‘¼ã³å‡ºã—å¤±æ•—:', locationResponse.status);
            }
        } catch (error) {
            console.error('éƒ½å¸‚åå–å¾—ã«å¤±æ•—:', error);
        }
        
        // 5. å¤©æ°—APIã®å‘¼ã³å‡ºã— (One Call API 3.0/3.5)
        // âœ… One Call API (3.0/3.5) ã‚’ä½¿ç”¨
        // exclude=daily,alerts ã«ã‚ˆã‚Šã€ç¾åœ¨(current)ã€åˆ†ã”ã¨(minutely)ã€æ™‚é–“ã”ã¨(hourly)ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—ã—ã¾ã™ã€‚
        const apiUrl = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=ja&exclude=daily,alerts`;
        
        try {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ5ç§’ï¼‰
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          const response = await fetch(apiUrl, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          const errorResponse = response.clone();

          if (!response.ok) {
            let errorMessage = `APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`;
            if (response.status === 401) {
                 try {
                     const errorData = await errorResponse.json();
                     console.error('OpenWeatherMap 401 ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData.message || 'è©³ç´°ä¸æ˜');
                 } catch (e) {
                     console.error('OpenWeatherMap 401 ã‚¨ãƒ©ãƒ¼è©³ç´°: JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼');
                 }
                 weatherLocationEl.textContent = 'ï¼ˆå¤©æ°—å–å¾—å¤±æ•—ï¼‰';
                 weatherDescEl.textContent = `401: APIã‚­ãƒ¼ãŒä¸æ­£ã¾ãŸã¯æœªèªè¨¼ã§ã™`;
                 weatherIconEl.src = 'https://placehold.co/50x50/ffebee/b71c1c?text=401';
                 throw new Error(`API Key Error: 401 Unauthorized`);
            }
            weatherLocationEl.textContent = 'ï¼ˆå¤©æ°—å–å¾—å¤±æ•—ï¼‰';
            weatherDescEl.textContent = errorMessage;
            weatherIconEl.src = 'https://placehold.co/50x50/ffebee/b71c1c?text=Err';
            throw new Error(errorMessage);
          }
          const data = await response.json();
          
          // 6. UIã®æ›´æ–°
          // âœ… locationName ã‚’æ¸¡ã™
          updateWeatherUI(data, locationName);

        } catch (error) {
          console.error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
          if (!error.message || !error.message.includes('API Key Error')) {
            weatherLocationEl.textContent = 'ï¼ˆå¤©æ°—å–å¾—å¤±æ•—ï¼‰';
            weatherDescEl.textContent = `---`;
            if (error.name === 'AbortError') {
              weatherLocationEl.textContent = 'ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰';
              weatherDescEl.textContent = `ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãŒé…å»¶ã—ã¾ã—ãŸ`;
            }
          }
        }
      }

      // 7. ä½ç½®æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®å‡¦ç†
      function onLocationError(error) {
        let message = 'ï¼ˆä½ç½®æƒ…å ±å–å¾—å¤±æ•—ï¼‰';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = "ï¼ˆä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "ï¼ˆä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼‰";
            break;
          case error.TIMEOUT:
            message = "ï¼ˆä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼‰";
            break;
        }
        weatherLocationEl.textContent = message;
      }

      // 8. UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      // âœ… locationName ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
      function updateWeatherUI(data, locationName) {
        if (!data.current || !data.current.weather || data.current.weather.length === 0) {
            weatherLocationEl.textContent = 'ï¼ˆãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼‰';
            return;
        }

        // âœ… éƒ½å¸‚åãŒã‚ã‚Œã°è¡¨ç¤ºã—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€åã‚’è¡¨ç¤º
        weatherLocationEl.textContent = locationName || 'ï¼ˆç¾åœ¨åœ°ï¼‰';

        // 8-1. ç¾åœ¨ã®å¤©æ°—ã‚’è¡¨ç¤º
        weatherTempEl.textContent = `${Math.round(data.current.temp)}â„ƒ`;
        weatherDescEl.textContent = data.current.weather[0].description;
        weatherIconEl.src = `https://openweathermap.org/img/wn/${data.current.weather[0].icon}@2x.png`;
        weatherIconEl.alt = data.current.weather[0].description;

        // 8-2. 3æ™‚é–“å¾Œã®äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (hourly[3]ã¯3æ™‚é–“å¾Œ)
        if (data.hourly && data.hourly.length >= 4) {
            const forecast3h = data.hourly[3];
            const date3h = new Date((forecast3h.dt) * 1000);

            // 3æ™‚é–“å¾Œã®UIã‚’æ›´æ–°
            forecast3hTimeEl.textContent = `${date3h.getHours()}:00`;
            weatherTemp3hEl.textContent = `${Math.round(forecast3h.temp)}â„ƒ`;
            weatherDesc3hEl.textContent = forecast3h.weather[0].description;
            weatherIcon3hEl.src = `https://openweathermap.org/img/wn/${forecast3h.weather[0].icon}@2x.png`;
            weatherIcon3hEl.alt = forecast3h.weather[0].description;
        } else {
            // 3æ™‚é–“å¾Œã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å‡¦ç†
            forecast3hTimeEl.textContent = '--:--';
            weatherTemp3hEl.textContent = '--â„ƒ';
            weatherDesc3hEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            weatherIcon3hEl.src = 'https://placehold.co/50x50/ffffff/cdeae0?text=--';
        }


        // 9. å¤©æ°—ã«å¿œã˜ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®è¡¨ç¤º (Hourlyäºˆæ¸¬ã¨Currentå¤©æ°—ã®ä¸¡æ–¹ã‚’ä½¿ç”¨)
        const currentWeatherMain = data.current.weather[0].main; 
        
        // äºˆæ¸¬çš„ãªè¦ç´  (hourlyãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨)
        const predictedAdvice = getPredictedAdvice(data);
        
        // äºˆæ¸¬ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ç¾åœ¨ã®å¤©æ°—ã«åŸºã¥ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
        const advice = predictedAdvice || getWeatherAdvice(currentWeatherMain);
        
        if (advice) {
          weatherAdviceTextEl.textContent = `ãƒ‰ãƒ©ã‚¤ãƒœã‚ˆã‚Š: ${advice}`;
          weatherAdviceBoxEl.style.display = 'block';
        }
      }

      // 7. ä½ç½®æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®å‡¦ç† (é–¢æ•°å†…å®¹ã¯å¤‰æ›´ãªã—)
      function onLocationError(error) {
        let message = 'ï¼ˆä½ç½®æƒ…å ±å–å¾—å¤±æ•—ï¼‰';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = "ï¼ˆä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "ï¼ˆä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼‰";
            break;
          case error.TIMEOUT:
            message = "ï¼ˆä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼‰";
            break;
        }
        weatherLocationEl.textContent = message;
        // 3æ™‚é–“å¾Œäºˆæ¸¬ã®åˆæœŸå€¤ã‚‚æ›´æ–° (è¿½åŠ )
        weatherTemp3hEl.textContent = '--â„ƒ';
        weatherDesc3hEl.textContent = '---';
        forecast3hTimeEl.textContent = '--:--';
        weatherIcon3hEl.src = 'https://placehold.co/50x50/ffffff/cdeae0?text=--';
      }

      // 10. äºˆæ¸¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
      function getPredictedAdvice(data) {
        // **********************************************
        // !!! ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘å¼·åˆ¶çš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ (è§£é™¤æ¸ˆã¿) !!!
        if (TEST_ADVICE_MODE) {
            // ãƒ†ã‚¹ãƒˆå¾Œã¯ã€å¿…ãšã“ã® if ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€TEST_ADVICE_MODEã‚’falseã«æˆ»ã—ã¦ãã ã•ã„ã€‚
            return 'ã€ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€‘ã¾ã‚‚ãªãé›¨ãŒé™ã‚Šãã†ã§ã™ã€‚ãƒ¯ã‚¤ãƒ‘ãƒ¼ã®æº–å‚™ã¨æ…é‡ãªé‹è»¢ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚';
        }
        // !!! ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘ã“ã“ã¾ã§ !!!
        // **********************************************

        const hourly = data.hourly;
        if (!hourly || hourly.length < 6) {
            // ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®å ´åˆ
            return null; 
        }

        let rainStartHour = -1;
        let snowStartHour = -1;

        // å‘ã“ã†6æ™‚é–“ (hourly[0]ã¯ç¾åœ¨ã®æ™‚é–“ã‚’å«ã‚€) ã‚’ãƒã‚§ãƒƒã‚¯
        for (let i = 0; i < 6; i++) {
            const hourData = hourly[i];
            const mainWeather = hourData.weather[0].main;

            // é™æ°´ç¢ºç‡ (pop) ãŒ50%ã‚’è¶…ãˆã€ã‹ã¤é›¨/éœ§/æ›‡ã‚Šãªã©ã®å ´åˆã‚’ãƒã‚§ãƒƒã‚¯
            const isRainingCondition = (mainWeather === 'Rain' || mainWeather === 'Drizzle' || (hourData.pop > 0.5 && (mainWeather === 'Clouds' || mainWeather === 'Mist')));
            const isSnowingCondition = (mainWeather === 'Snow');
            
            // é›¨ã®äºˆæ¸¬ãŒè¦‹ã¤ã‹ã‚Šã€ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
            if (isRainingCondition && rainStartHour === -1) {
                rainStartHour = i;
            } 
            
            // é›ªã®äºˆæ¸¬ãŒè¦‹ã¤ã‹ã‚Šã€ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
            if (isSnowingCondition && snowStartHour === -1) {
                snowStartHour = i;
            }
            
            // ä¸¡æ–¹è¦‹ã¤ã‹ã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯çµ‚äº†
            if (rainStartHour !== -1 && snowStartHour !== -1) break;
        }

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ„ã¿ç«‹ã¦ã‚‹ (é›ªã‚’å„ªå…ˆ)
        if (snowStartHour !== -1) {
            const hour = new Date((hourly[snowStartHour].dt) * 1000).getHours();
            if (snowStartHour <= 1) { // 1æ™‚é–“ä»¥å†… (ã¾ã‚‚ãªã)
                return 'ã€äºˆæ¸¬ã€‘ã¾ã‚‚ãªãé›ªãŒé™ã‚‹äºˆå ±ã§ã™ã€‚\nè·¯é¢ãŒæ€¥æ¿€ã«æ»‘ã‚Šã‚„ã™ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ—©ã‚ã®æ¸›é€Ÿã¨ã€æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ã€æ€¥ãƒãƒ³ãƒ‰ãƒ«ã‚’é¿ã‘ãŸéå¸¸ã«æ…é‡ãªé‹è»¢ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚\nç‰¹ã«æ©‹ã®ä¸Šã‚„ãƒˆãƒ³ãƒãƒ«ã®å‡ºå…¥ã‚Šå£ã¯å‡çµã—ã‚„ã™ã„ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚';
            } else { // 2ï½5æ™‚é–“å¾Œ
                return `ã€äºˆæ¸¬ã€‘ç´„${snowStartHour}æ™‚é–“å¾Œï¼ˆ${hour}æ™‚é ƒï¼‰ã‹ã‚‰é›ªãŒé™ã‚‹äºˆå ±ã§ã™ã€‚\nå‡ºç™ºå‰ã«ã‚¿ã‚¤ãƒ¤ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã§ã‚ã‚Œã°ã‚¹ã‚¿ãƒƒãƒ‰ãƒ¬ã‚¹ã‚¿ã‚¤ãƒ¤ã‚„ãƒã‚§ãƒ¼ãƒ³ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ã€‚\næ°—æ¸©ã‚‚ä¸‹ãŒã‚‹è¦‹è¾¼ã¿ã§ã™ã®ã§ã€å®‰å…¨ç¬¬ä¸€ã§ç„¡ç†ã®ãªã„é‹è»¢è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚`;
            }
        }

        if (rainStartHour !== -1) {
            const hour = new Date((hourly[rainStartHour].dt) * 1000).getHours();
            if (rainStartHour <= 1) { // 1æ™‚é–“ä»¥å†… (ã¾ã‚‚ãªã)
                return 'ã€äºˆæ¸¬ã€‘ã¾ã‚‚ãªãå¼·ã„é›¨ãŒé™ã‚Šå§‹ã‚ã‚‹äºˆå ±ã§ã™ã€‚\né›¨ãŒé™ã‚Šå§‹ã‚ã‚‹ã¨ã€è·¯é¢ã®æ²¹è†œã§ç‰¹ã«æ»‘ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚ãƒ¯ã‚¤ãƒ‘ãƒ¼ã‚’ã™ãã«æº–å‚™ã—ã€è¦–ç•Œã®ç¢ºä¿ã‚’æœ€å„ªå…ˆã«ã—ã¦ãã ã•ã„ã€‚\nè»Šé–“è·é›¢ã‚’ååˆ†ã«ç©ºã‘ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è½ã¨ã—ã¦èµ°è¡Œã—ã¾ã—ã‚‡ã†ã€‚';
            } else { // 2ï½5æ™‚é–“å¾Œ
                return `ã€äºˆæ¸¬ã€‘ç´„${rainStartHour}æ™‚é–“å¾Œï¼ˆ${hour}æ™‚é ƒï¼‰ã«é›¨ãŒé™ã‚Šå§‹ã‚ã‚‹äºˆå ±ã§ã™ã€‚\nå‡ºç™ºæ™‚ã¯æ™´ã‚Œã¦ã„ã¦ã‚‚ã€å¿µã®ãŸã‚å‚˜ã¨ã€è¦–ç•Œå¯¾ç­–ã®ãŸã‚ã®æ’¥æ°´ã‚¹ãƒ—ãƒ¬ãƒ¼ç­‰ã‚’ãŠå¿˜ã‚Œãªãã€‚\né›¨è„šãŒå¼·ã¾ã‚‹å‰ã«ç›®çš„åœ°ã«åˆ°ç€ã§ãã‚‹ã‚ˆã†ã€æ™‚é–“ã«ä½™è£•ã‚’æŒã£ãŸé‹è»¢ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚`;
            }
        }

        return null; // äºˆæ¸¬çš„ãªæ³¨æ„ãŒå¿…è¦ãªå¤©å€™å¤‰åŒ–ãŒãªã„å ´åˆ
      }

      // 11. ç¾åœ¨ã®å¤©æ°—ã«åŸºã¥ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
      function getWeatherAdvice(weatherMain) {
        // OpenWeatherMapã®ä¸»ãªå¤©æ°—ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã„ã¾ã™
        switch (weatherMain) {
          case 'Rain':
          case 'Drizzle':
          case 'Thunderstorm':
            return 'ç¾åœ¨é›¨ãŒé™ã£ã¦ãŠã‚Šã€è¦–ç•ŒãŒæ‚ªãè·¯é¢ãŒæ»‘ã‚Šã‚„ã™ã„çŠ¶æ…‹ã§ã™ã€‚\næ°´ãŸã¾ã‚Šã‚’é«˜é€Ÿã§é€šéã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒ¤ãŒæ°´ã«æµ®ãã€ãƒãƒ³ãƒ‰ãƒ«ã‚„ãƒ–ãƒ¬ãƒ¼ã‚­ãŒå…¨ãåŠ¹ã‹ãªããªã‚‹å±é™ºãŒã‚ã‚Šã¾ã™ã€‚è»Šé–“è·é›¢ã‚’æ™®æ®µã®2å€ç¨‹åº¦ã«ç©ºã‘ã€é€Ÿåº¦ã‚’è½ã¨ã—ã¦æ…é‡ã«é‹è»¢ã—ã¦ãã ã•ã„ã€‚';
          case 'Snow':
            return 'ç¾åœ¨é›ªãŒé™ã£ã¦ã„ã¾ã™ã€‚ã‚¹ãƒªãƒƒãƒ—ã®å±é™ºæ€§ãŒéå¸¸ã«é«˜ã¾ã£ã¦ã„ã¾ã™ã€‚\næ€¥ç™ºé€²ã€æ€¥åŠ é€Ÿã€æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ãªã©ã€Œæ€¥ã€ã®ã¤ãæ“ä½œã¯çµ¶å¯¾ã«é¿ã‘ã€ã‚†ã£ãã‚Šã¨ã€ã„ã¤ã‚‚ä»¥ä¸Šã«æ…é‡ã«é‹è»¢ã—ã¦ãã ã•ã„ã€‚\né›ªé“ã§ã¯è¦–ç•Œã‚‚æ‚ªããªã‚‹ãŸã‚ã€ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆã‚’ç‚¹ç¯ã—ã¾ã—ã‚‡ã†ã€‚';
          case 'Clear':
            return 'å¿«æ™´ã§æœ€é«˜ã®ãƒ‰ãƒ©ã‚¤ãƒ–æ—¥å’Œã§ã™ã­ï¼æ°—æŒã¡ã®è‰¯ã„ãƒ‰ãƒ©ã‚¤ãƒ–ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚\nãŸã ã—ã€æ—¥å·®ã—ãŒå¼·ã„å ´åˆã¯ã€ã‚µãƒ³ã‚°ãƒ©ã‚¹ã‚„æ—¥ã‚ˆã‘ã‚’æ´»ç”¨ã—ã¦è¦–ç•Œã‚’ç¢ºä¿ã—ã¾ã—ã‚‡ã†ã€‚\nå¿«æ™´ã§ã‚‚æ²¹æ–­ã›ãšã€å®‰å…¨é‹è»¢ã§ã„ãã¾ã—ã‚‡ã†ï¼';
          case 'Clouds':
            return 'æ›‡ã‚Šç©ºã§ã™ã€‚é‹è»¢ã—ã‚„ã™ã„å¤©æ°—ã§ã™ãŒã€æ²¹æ–­ã›ãšå®‰å…¨é‹è»¢ã§ã„ãã¾ã—ã‚‡ã†ï¼\né•·è·é›¢é‹è»¢ã®å ´åˆã¯ã€é©åº¦ã«ä¼‘æ†©ã‚’å–ã‚Šã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãšã«ã€‚\nç‰¹ã«å¤œé–“ã¯å¯¾å‘è»Šã®ãƒ©ã‚¤ãƒˆã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚';
          case 'Mist':
          case 'Fog':
          case 'Haze':
          case 'Smoke':
          case 'Dust':
          case 'Sand':
          case 'Ash':
            return 'éœ§ã‚„éœã§è¦–ç•ŒãŒéå¸¸ã«æ‚ªããªã£ã¦ã„ã¾ã™ã€‚ãƒ•ã‚©ã‚°ãƒ©ãƒ³ãƒ—ã‚’ç‚¹ç¯ã—ã€å‰ã®è»Šã¨ã®è·é›¢ã‚’ååˆ†ã«ã¨ã£ã¦ãã ã•ã„ã€‚\nç„¡ç†ãªè¿½ã„è¶Šã—ã¯å±é™ºã§ã™ã€‚ä½é€Ÿã§èµ°è¡Œã—ã€å¾Œç¶šè»Šã«ã‚‚æ³¨æ„ã‚’ä¿ƒã™ãŸã‚ã«ãƒã‚¶ãƒ¼ãƒ‰ãƒ©ãƒ³ãƒ—ã®åˆ©ç”¨ã‚‚æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚\nè¦–ç•Œä¸è‰¯ã®éš›ã¯ã€è·¯è‚©ã«åœè»Šã—ã¦å¤©å€™å›å¾©ã‚’å¾…ã¤ã®ã‚‚ä¸€ã¤ã®æ‰‹ã§ã™ã€‚';
          case 'Squall':
          case 'Tornado':
             return 'ç¾åœ¨ã€çªé¢¨ã‚„è’ã‚ŒãŸå¤©å€™ãŒäºˆæƒ³ã•ã‚Œã¾ã™ï¼\nãƒãƒ³ãƒ‰ãƒ«ã‚’ã—ã£ã‹ã‚Šæ¡ã‚Šã€é€Ÿåº¦ã‚’è½ã¨ã—ã¦å®‰å…¨ãªå ´æ‰€ã«é¿é›£ã™ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«è€ƒãˆã¦ãã ã•ã„ã€‚\nç‰¹ã«é«˜æ¶ä¸‹ã‚„å»ºç‰©ã®è¿‘ããªã©ã€é¢¨ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„å ´æ‰€ã§ã®é‹è»¢ã«ã¯ç´°å¿ƒã®æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚';
          default:
            return 'ä»Šæ—¥ã‚‚ä¸€æ—¥ã€å®‰å…¨é‹è»¢ã§ã„ãã¾ã—ã‚‡ã†ï¼\nç‰¹ã«å¤‰ã‚ã‚Šã‚„ã™ã„å¤©æ°—ã®æ—¥ã«ã¯ã€å¸¸ã«æœ€æ–°ã®äºˆå ±ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚\nç´ æ•µãªãƒ‰ãƒ©ã‚¤ãƒ–ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼';
        }
      }
    });
  </script>

  
  <!-- âœ… Firebase & ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¶™ç¶šï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // recording_start ã§ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‹ã‚‰å¾©å…ƒï¼ˆç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
    try {
      const cfg = localStorage.getItem('FIREBASE_CONFIG_JSON');
      if (cfg && (!window.firebase || (window.firebase && window.firebase.apps && window.firebase.apps.length === 0))) {
        firebase.initializeApp(JSON.parse(cfg));
      }
    } catch(e) { console.warn('Firebase init skipped on home:', e); }
  </script>
  <script src="{{ url_for('static', filename='route_recorder.js') }}"></script>
  <script>
    // user id ã‚’å¯èƒ½ãªã‚‰åŒæœŸ
    try {
      const uid = "{{ current_user.id if current_user.is_authenticated else '' }}";
      if (uid) {
        window.FLASK_USER_ID = uid;
        localStorage.setItem('CURRENT_USER_ID', uid);
      }
    } catch(e) {}
  </script>
</body>
</html>
