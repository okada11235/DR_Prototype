<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ”ãƒ³ç®¡ç† - ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #d8f5e3;
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* === åœ°å›³ã‚¨ãƒªã‚¢ === */
    #map {
      width: 100%;
      height: calc(100vh - 45px); /* âœ… ãƒŠãƒ“åˆ†ã®é«˜ã•ã‚‚åˆã‚ã›ã‚‹ */
      border-top: 2px solid #999;
    }

    /* === ä¸‹éƒ¨ãƒŠãƒ“ï¼ˆhome.htmlã¨åŒã˜ã‚µã‚¤ã‚ºã«èª¿æ•´ï¼‰ === */
    .custom-nav-bar {
      background: #378da0;
      border-top: 2px solid #5a7d8d;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, .2);
      height: 45px; /* âœ… home.htmlã¨åŒã˜ */
    }

    .custom-nav-link {
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      padding: 0 1rem;
      line-height: 41px; /* âœ… home.htmlã¨åŒã˜ */
      height: 100%;
      display: block;
    }

    .custom-nav-item:not(:last-child) {
      border-right: 1px solid #5a7d8d;
    }

    .active-glow .custom-nav-link.active {
      color: rgb(0, 0, 0);
      background: rgba(255, 255, 255, .05);
    }

    /* === ã‚¹ãƒãƒ›ç”¨è£œæ­£ === */
    @media (max-width: 768px) {
      .custom-nav-link {
        font-size: 0.95rem;
        line-height: 53px;
      }
    }

    @supports (-webkit-touch-callout: none) {
      #map {
        height: calc(100svh - 45px); /* âœ… Safariå¯¾ç­–: svhã‚’ä½¿ã† */
      }
    }
  </style>
  <style>
    /* èª­ã¿ä¸Šã’è¨­å®šãƒœã‚¿ãƒ³: hoverã§æ–‡å­—è‰²ãŒåè»¢ã—ã¦æ¶ˆãˆã‚‹ã®ã‚’é˜²æ­¢ */
    #openSpeechSettings.speech-settings-btn {
      color:#222;
    }
    #openSpeechSettings.speech-settings-btn:hover,
    #openSpeechSettings.speech-settings-btn:focus,
    #openSpeechSettings.speech-settings-btn:active {
      background:#fff !important; /* ç™½èƒŒæ™¯ç¶­æŒ */
      color:#222 !important;      /* æ–‡å­—è‰²ç¶­æŒ */
      border-color:#444 !important;
      box-shadow:none;
    }
  </style>
</head>

<body>
  <!-- âœ… åœ°å›³ã‚¨ãƒªã‚¢ã®ã¿ -->
  <div id="map"></div>
  <!-- âœ… å³ä¸Šï¼šãƒ”ãƒ³å‡¡ä¾‹ + èª­ã¿ä¸Šã’è¨­å®šãƒœã‚¿ãƒ³ -->
  <div id="topRightControls" style="position:absolute; top:10px; right:10px; z-index:6; display:flex; gap:8px; align-items:flex-start;">
    <!-- å‡¡ä¾‹ -->
    <div id="pinLegend" style="background:#fff; border:1px solid #ccc; padding:6px 10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.15); font-size:12px; line-height:1.4;">
      <div style="font-weight:bold; margin-bottom:4px;">ãƒ”ãƒ³ä¸€è¦§</div>
      <div class="legend-item" style="display:flex; align-items:center; gap:6px; margin-bottom:2px;">
        <span class="legend-dot" style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#ff9800; border:2px solid #fff; box-shadow:0 0 0 1px #ff9800;"></span>
        <span>ãƒ¬ãƒ™ãƒ«1: è»½ã„è­¦æˆ’</span>
      </div>
      <div class="legend-item" style="display:flex; align-items:center; gap:6px; margin-bottom:2px;">
        <span class="legend-dot" style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#7e57c2; border:2px solid #fff; box-shadow:0 0 0 1px #7e57c2;"></span>
        <span>ãƒ¬ãƒ™ãƒ«2: è­¦æˆ’</span>
      </div>
      <div class="legend-item" style="display:flex; align-items:center; gap:6px;">
        <span class="legend-dot" style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#e53935; border:2px solid #fff; box-shadow:0 0 0 1px #e53935;"></span>
        <span>ãƒ¬ãƒ™ãƒ«3: å¼·ã„è­¦æˆ’</span>
      </div>
    </div>
    <!-- èª­ã¿ä¸Šã’è¨­å®šãƒœã‚¿ãƒ³ -->
    <div id="speechSettingBtnWrapper">
      <button id="openSpeechSettings" class="btn btn-sm btn-outline-dark speech-settings-btn" style="background:#fff; font-weight:bold;">èª­ã¿ä¸Šã’è¨­å®š âš™</button>
    </div>
  </div>

  <!-- âœ… ã‚¯ãƒªãƒƒã‚¯æŒ™å‹•åˆ¶å¾¡ï¼†ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ -->
  <div id="mapControls" style="position:absolute; left:10px; bottom:60px; z-index:5; display:flex; flex-direction:column; gap:6px;">
    <button id="gotoCurrentBtn" class="btn btn-sm btn-secondary">
      ç¾åœ¨åœ°ã¸ ğŸ“
    </button>
  </div>

  <!-- âœ… ä¸‹éƒ¨ãƒŠãƒ“ï¼ˆhome.htmlã¨åŒã˜ï¼‰ -->
  <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.home') }}">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('views.recording_start') }}" class="nav-link custom-nav-link">é‹è»¢</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('sessions.results_page') }}" class="nav-link custom-nav-link">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a class="nav-link custom-nav-link active" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item border-end-0">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.explain') }}">èª¬æ˜</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- âœ… Scripts -->
  <script>
    const CURRENT_USER_ID = "{{ current_user.id }}";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ç¾åœ¨åœ°ã¸ç§»å‹•ã™ã‚‹å…±é€šé–¢æ•°
    window.recenterToCurrent = function(showMarker=false) {
      if (!navigator.geolocation) return alert('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        if (window.map) {
          window.map.panTo(loc);
          if (showMarker) {
            new google.maps.Marker({
              position: loc,
              map: window.map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#00aaff',
                fillOpacity: 0.9,
                strokeColor: '#fff',
                strokeWeight: 2,
              }
            });
          }
        }
      }, err => console.warn('geolocation error', err));
    };

    // ãƒœã‚¿ãƒ³åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const gotoBtn = document.getElementById('gotoCurrentBtn');
      const openSettingsBtn = document.getElementById('openSpeechSettings');
      if (!gotoBtn) return;

      gotoBtn.addEventListener('click', () => {
        recenterToCurrent(false);
        // ãƒ‘ãƒ³ã ã‘ã§ã¯åˆ†ã‹ã‚Šã¥ã‚‰ã„å ´åˆãŒã‚ã‚‹ã®ã§ã‚ºãƒ¼ãƒ ã‚’é©åº¦ã«èª¿æ•´
        if (window.map) {
          const currentZoom = window.map.getZoom();
          if (!currentZoom || currentZoom < 16) {
            window.map.setZoom(17);
          }
        }
      });
      // === èª­ã¿ä¸Šã’è¨­å®šUIç”Ÿæˆ ===
      if (openSettingsBtn) {
        openSettingsBtn.addEventListener('click', () => {
          let panel = document.getElementById('speechSettingsPanel');
          if (!panel) {
            panel = document.createElement('div');
            panel.id = 'speechSettingsPanel';
            panel.style.position = 'absolute';
            panel.style.top = '50px';
            panel.style.right = '10px';
            panel.style.zIndex = '7';
            panel.style.background = '#ffffff';
            panel.style.border = '1px solid #ccc';
            panel.style.padding = '10px 14px';
            panel.style.borderRadius = '8px';
            panel.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
            panel.style.width = '200px';
            panel.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong style="font-size:14px;">èª­ã¿ä¸Šã’è¨­å®š</strong>
                <button id="closeSpeechSettings" class="btn btn-sm btn-light" style="padding:2px 6px;">Ã—</button>
              </div>
              <div style="font-size:12px; color:#555; margin-top:4px;">ãƒ¬ãƒ™ãƒ«æ¯ã«èª­ã¿ä¸Šã’ON/OFFã‚’è¨­å®š</div>
              <div style="margin-top:8px;">
                <label style="display:block; font-size:13px;">
                  <input type="checkbox" data-speak-level="1" checked> ãƒ¬ãƒ™ãƒ«1 (æ©™)
                </label>
                <label style="display:block; font-size:13px;">
                  <input type="checkbox" data-speak-level="2" checked> ãƒ¬ãƒ™ãƒ«2 (ç´«)
                </label>
                <label style="display:block; font-size:13px;">
                  <input type="checkbox" data-speak-level="3" checked> ãƒ¬ãƒ™ãƒ«3 (èµ¤)
                </label>
              </div>
              <button id="saveSpeechSettings" class="btn btn-sm btn-primary" style="margin-top:10px; width:100%;">ä¿å­˜</button>
              <div id="speechSettingStatus" style="margin-top:6px; font-size:11px; color:#007bff;"></div>
            `;
            document.body.appendChild(panel);

            // é–‰ã˜ã‚‹
            panel.querySelector('#closeSpeechSettings').addEventListener('click', () => {
              panel.remove();
            });

            // åˆæœŸå€¤ãƒ­ãƒ¼ãƒ‰
            fetch('/api/user_speak_settings')
              .then(r => r.json())
              .then(data => {
                if (data.status === 'success') {
                  const lvls = data.settings?.speak_levels || {}; 
                  panel.querySelectorAll('input[data-speak-level]').forEach(cb => {
                    const lvl = cb.getAttribute('data-speak-level');
                    cb.checked = lvls[lvl] !== false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
                  });
                } else {
                  panel.querySelector('#speechSettingStatus').textContent = 'è¨­å®šå–å¾—å¤±æ•—';
                }
              })
              .catch(() => {
                panel.querySelector('#speechSettingStatus').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
              });

            // ä¿å­˜
            panel.querySelector('#saveSpeechSettings').addEventListener('click', () => {
              const speakLevels = {};
              panel.querySelectorAll('input[data-speak-level]').forEach(cb => {
                speakLevels[cb.getAttribute('data-speak-level')] = cb.checked;
              });
              fetch('/api/user_speak_settings/update', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ speak_levels: speakLevels })
              })
                .then(r => r.json())
                .then(res => {
                  if (res.status === 'success') {
                    panel.querySelector('#speechSettingStatus').textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
                    window.userSpeakSettings = { speak_levels: speakLevels }; // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”»é¢å´å‚ç…§ç”¨
                  } else {
                    panel.querySelector('#speechSettingStatus').textContent = 'âŒ ä¿å­˜å¤±æ•—';
                  }
                })
                .catch(() => {
                  panel.querySelector('#speechSettingStatus').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
                });
            });
          } else {
            panel.remove(); // 2åº¦æŠ¼ã—ã§é–‰ã˜ã‚‹ãƒˆã‚°ãƒ«å‹•ä½œ
          }
        });
      }
    });
  </script>
  <script src="{{ url_for('static', filename='maps_pins.js') }}"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDU9txYivjPCIe66l6bPYsPifQKcQxjnrA&callback=initMap" async defer></script>
</body>
</html>
