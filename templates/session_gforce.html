<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>セッション {{ session_id }} の前後G加速度グラフ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h1 { margin-bottom: 20px; }
  #chart-container { width: 100%; max-width: 900px; height: 420px; } /* ← 高さを明示 */
</style>
</head>
<body>

<h1>セッション {{ session_id }} の前後G加速度グラフ</h1>

<div id="chart-container">
  <canvas id="gforceChart"></canvas>
</div>

<script>
const rawLogs = {{ gps_logs | tojson }};

// ----- 型ゆれを吸収してミリ秒に正規化 -----
const toMillis = (ts) => {
  if (ts == null) return null;
  // Firestore Timestamp {seconds, nanoseconds}
  if (typeof ts === 'object' && typeof ts.seconds === 'number') {
    return ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6);
  }
  // Date文字列
  if (typeof ts === 'string') {
    const t = Date.parse(ts);
    return Number.isNaN(t) ? null : t;
  }
  // Unixミリ秒/秒（数値）
  if (typeof ts === 'number') {
    // 桁で秒/ミリ秒をだいたい判定（10桁前後なら秒）
    return ts < 1e12 ? ts * 1000 : ts;
  }
  // Dateオブジェクト
  if (ts instanceof Date) return ts.getTime();
  return null;
};

// ----- 前処理：nullや欠損の除外、時刻順ソート -----
const gpsLogs = (rawLogs || [])
  .map(l => {
    const ms = toMillis(l.timestamp);
    return (ms == null) ? null : { ...l, _ms: ms };
  })
  .filter(Boolean)
  .sort((a,b) => a._ms - b._ms);

// データが無い場合のフェイルセーフ
if (gpsLogs.length === 0) {
  const div = document.getElementById('chart-container');
  div.innerHTML = '<p>このセッションにはグラフ化できるデータがありません。</p>';
} else {
  const t0 = gpsLogs[0]._ms;
  const labels = gpsLogs.map(log => ((log._ms - t0) / 1000).toFixed(1));

  // gYのキー名がブレても拾えるように保険
  const gYData = gpsLogs.map(log => {
    const gy = (log.g_y ?? log.gY ?? log.gy ?? 0);
    // 数字以外は0にフォールバック
    return (typeof gy === 'number' && Number.isFinite(gy)) ? gy : 0;
  });

  // イベント別の点装飾
  const pointColors = gpsLogs.map(log => {
    switch (log.event) {
      case 'sudden_brake':    return 'red';
      case 'sudden_accel':    return 'green';
      case 'sharp_turn':      return 'orange';
      case 'speed_violation': return 'purple';
      default:                return 'rgba(75, 192, 192, 1)';
    }
  });
  const pointSizes = gpsLogs.map(log => (log.event && log.event !== 'normal') ? 6 : 0);

  // y軸の範囲をデータから少し余裕を持って設定
  const minY = Math.min(...gYData);
  const maxY = Math.max(...gYData);
  const pad = 0.05; // 余白
  const yMin = Math.min(-0.5, Math.floor((minY - pad) * 10) / 10);
  const yMax = Math.max( 0.5, Math.ceil( (maxY + pad) * 10) / 10);

  const ctx = document.getElementById('gforceChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '前後G加速度 (gY)',
        data: gYData,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        fill: true,
        tension: 0.2,
        pointRadius: pointSizes,
        pointBackgroundColor: pointColors,
        spanGaps: true
      }]
    },
    options: {
      scales: {
        x: {
          title: { display: true, text: '経過時間 (秒)' },
          ticks: { maxRotation: 45, minRotation: 45 }
        },
        y: {
          title: { display: true, text: '前後G加速度 (g)' },
          suggestedMin: yMin,
          suggestedMax: yMax
        }
      },
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            // ツールチップでイベントも表示
            afterLabel: (ctx) => {
              const idx = ctx.dataIndex;
              const e = gpsLogs[idx]?.event;
              return e && e !== 'normal' ? `  イベント: ${e}` : '';
            }
          }
        }
      },
      responsive: true,
      maintainAspectRatio: false
    }
  });
}
</script>

</body>
</html>
