<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    background-color: #cdeae0; /* â† ãƒ›ãƒ¼ãƒ ã¨åŒã˜è‰²ã«çµ±ä¸€ */
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.fade {
  opacity: 0;
  animation: fadeIn 0.6s forwards;
}

@keyframes fadeIn {
  to { opacity: 1; }
}
</style>

</head>

<body class="flex flex-col items-center justify-center min-h-screen">

  <!-- ãƒ­ãƒœãƒƒãƒˆç”»åƒ -->
  <div class="mb-6">
    <img id="loadingRobot" src="/static/img/robot_new.png" 
         class="w-28 h-28 animate-pulse"
         alt="loading robot">
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ -->
  <div class="text-center text-xl font-bold text-gray-700 mb-2 fade" id="statusText">
    ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™â€¦
  </div>

  <!-- ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ -->
  <div class="text-center text-sm text-gray-500 fade" id="subText">
    å°‘ã€…ãŠå¾…ã¡ãã ã•ã„
  </div>

<script>
const sessionId = "{{ session_id }}";

async function runEndTasks() {
    if (!sessionId) {
        console.error("No session_id");
        return;
    }

    console.log("ğŸ“¡ ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–‹å§‹", sessionId);

    // â‘  ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
    updateUI("èµ°è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™â€¦", "ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­", 20, true);
    await fetch("/sessions/end", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sessionId })
    });

    // â‘¡ AI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
    updateUI("AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦", "èµ°è¡Œå†…å®¹ã‚’åˆ†æä¸­", 70, false);
    await fetch(`/api/focus_feedback/${sessionId}`, { method: "POST" });

    // â‘¢ å®Œäº†
    updateUI("å®Œäº†ã—ã¾ã—ãŸï¼", "çµæœç”»é¢ã¸ç§»å‹•ã—ã¾ã™", 100, false);

    setTimeout(() => {
        window.location.href = `/recording/completed?session_id=${sessionId}`;
    }, 700);
}

function updateUI(mainText, subText, progress, spin) {
    document.getElementById("statusText").textContent = mainText;
    document.getElementById("subText").textContent = subText;

    const bar = document.getElementById("progressBar");
    bar.style.width = progress + "%";

    const robot = document.getElementById("loadingRobot");
    robot.style.animation = spin ? "spin 1.2s linear infinite" : "";
}

runEndTasks();
</script>

</body>
</html>
