<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è©³ç´° - ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f5f7fa; padding:20px; }
    .detail-card { background:#fff; border-radius:10px; padding:25px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .section-title { color:#2090c2; font-weight:bold; margin-bottom:15px; padding-bottom:8px; border-bottom:2px solid #e9ecef; }
    .info-row { display:flex; margin-bottom:10px; }
    .info-label { font-weight:bold; min-width:150px; color:#666; }
    .info-value { color:#333; }
    .eval-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-top:10px; }
    .eval-item { background:#f8f9fa; padding:10px; border-radius:6px; border-left:3px solid #2090c2; }
    .eval-label { font-size:0.85rem; color:#666; margin-bottom:4px; }
    .eval-value { font-weight:bold; color:#2090c2; }
    .comment-box { background:#f8f9fa; padding:15px; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .image-preview { max-width:100%; border-radius:8px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0">ğŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è©³ç´°</h3>
      <a href="{{ url_for('views.feedback_log') }}" class="btn btn-outline-secondary btn-sm">ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'warning' if category=='warning' else 'danger' }} py-2 mb-3">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- åŸºæœ¬æƒ…å ± -->
    <div class="detail-card">
      <h5 class="section-title">åŸºæœ¬æƒ…å ±</h5>
      <div class="info-row">
        <div class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</div>
        <div class="info-value">{{ feedback.get('username', 'N/A') }}</div>
      </div>
      <div class="info-row">
        <div class="info-label">ãŠåå‰:</div>
        <div class="info-value">{{ feedback.get('real_name', 'N/A') }}</div>
      </div>
      <div class="info-row">
        <div class="info-label">ä½¿ç”¨æ©Ÿç¨®:</div>
        <div class="info-value">{{ feedback.get('device_type', 'N/A') }}</div>
      </div>
      <div class="info-row">
        <div class="info-label">ä½¿ç”¨ãƒ–ãƒ©ã‚¦ã‚¶:</div>
        <div class="info-value">
          {{ feedback.get('browser', 'N/A') }}
          {% if feedback.get('browser') == 'ãã®ä»–' and feedback.get('browser_other') %}
            <span class="badge bg-info text-white ms-2">{{ feedback.get('browser_other') }}</span>
          {% endif %}
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">é‹è»¢è¨˜éŒ²æ—¥æ™‚:</div>
        <div class="info-value">
          {% if feedback.get('drive_times') %}
            {% for dt in feedback.get('drive_times', []) %}
              <div class="mb-1">
                <span class="badge bg-secondary">{{ loop.index }}</span>
                {{ dt.get('start_datetime', 'N/A') }} ã€œ {{ dt.get('end_datetime', 'N/A') }}
              </div>
            {% endfor %}
          {% else %}
            <!-- æ—§å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ -->
            {{ feedback.get('drive_start_datetime', 'N/A') }} ã€œ {{ feedback.get('drive_end_datetime', 'N/A') }}
          {% endif %}
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">æº€è¶³åº¦:</div>
        <div class="info-value">
          {% if feedback.get('satisfaction') %}
            <span class="badge bg-primary">â˜… {{ feedback.get('satisfaction') }}</span>
          {% else %}
            æœªå›ç­”
          {% endif %}
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">é€ä¿¡æ—¥æ™‚:</div>
        <div class="info-value">
          {{ feedback.get('created_at').strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') if feedback.get('created_at') else 'N/A' }}
        </div>
      </div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹åˆ¤å®šè©•ä¾¡ -->
    <div class="detail-card">
      <h5 class="section-title">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹åˆ¤å®šè©•ä¾¡</h5>
      {% set eval_labels = {
        'hard_brake': 'æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­',
        'hard_curve': 'æ€¥ã‚«ãƒ¼ãƒ–',
        'hard_accel': 'æ€¥åŠ é€Ÿ',
        'good_decel': 'è‰¯æ¸›é€Ÿ',
        'good_curve': 'è‰¯ã‚«ãƒ¼ãƒ–',
        'good_accel': 'è‰¯åŠ é€Ÿ'
      } %}
      <div class="eval-grid">
        {% for key, label in eval_labels.items() %}
          <div class="eval-item">
            <div class="eval-label">{{ label }}</div>
            <div class="eval-value">{{ feedback.get('evaluations', {}).get(key, 'æœªå›ç­”') }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- èª²é¡Œè§£æ±ºè©•ä¾¡ -->
    <div class="detail-card">
      <h5 class="section-title">èª²é¡Œè§£æ±ºè©•ä¾¡</h5>
      {% set solution_labels = {
        'focus_awareness': 'é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆFBã§è‡ªåˆ†ã®èª²é¡Œã‚’æŠŠæ¡ã§ããŸã‹',
        'realtime_improvement': 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§å¿«é©ã«è‡ªåˆ†ã®é‹è»¢ã‚’æ”¹å–„ã§ããŸã‹',
        'pin_reference': 'ä»–ã®äººãŒåˆºã—ãŸãƒ”ãƒ³ãŒé‹è»¢ã®å‚è€ƒã«ãªã£ã¦ã„ã‚‹ã‹'
      } %}
      <div class="eval-grid">
        {% for key, label in solution_labels.items() %}
          <div class="eval-item">
            <div class="eval-label">{{ label }}</div>
            <div class="eval-value">{{ feedback.get('solution_evaluation', {}).get(key, 'æœªå›ç­”') }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æ„Ÿæƒ³ -->
    <div class="detail-card">
      <h5 class="section-title">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æ„Ÿæƒ³</h5>
      
      {% if feedback.get('advice_comment') %}
        <div class="comment-box">{{ feedback.get('advice_comment') }}</div>
      {% else %}
        <p class="text-muted">æ„Ÿæƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- é‹è»¢çµ‚äº†å¾Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®æ„Ÿæƒ³ -->
    <div class="detail-card">
      <h5 class="section-title">é‹è»¢çµ‚äº†å¾Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®æ„Ÿæƒ³</h5>
      
      {% if feedback.get('post_feedback_comment') %}
        <div class="comment-box">{{ feedback.get('post_feedback_comment') }}</div>
      {% else %}
        <p class="text-muted">æ„Ÿæƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã®æ„Ÿæƒ³ -->
    <div class="detail-card">
      <h5 class="section-title">é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã®æ„Ÿæƒ³</h5>
      
      {% if feedback.get('focus_point_comment') %}
        <div class="comment-box">{{ feedback.get('focus_point_comment') }}</div>
      {% else %}
        <p class="text-muted">æ„Ÿæƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- ãƒãƒƒãƒ—ãƒ”ãƒ³æ©Ÿèƒ½ã®æ„Ÿæƒ³ -->
    <div class="detail-card">
      <h5 class="section-title">ãƒãƒƒãƒ—ãƒ”ãƒ³æ©Ÿèƒ½ã®æ„Ÿæƒ³</h5>
      
      {% if feedback.get('map_pin_comment') %}
        <div class="comment-box">{{ feedback.get('map_pin_comment') }}</div>
      {% else %}
        <p class="text-muted">æ„Ÿæƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- ãã®ä»–ã®è‡ªç”±è¨˜è¿° -->
    <div class="detail-card">
      <h5 class="section-title">ãã®ä»–ã®è‡ªç”±è¨˜è¿°</h5>
      
      {% if feedback.get('desired_features') %}
        <h6 class="mt-3">ä»Šå¾Œè¿½åŠ ã—ã¦ã»ã—ã„æ©Ÿèƒ½</h6>
        <div class="comment-box">{{ feedback.get('desired_features') }}</div>
      {% endif %}

      {% if feedback.get('unclear_features') %}
        <h6 class="mt-3">ä½¿ã„æ–¹ãŒã‚ã‹ã‚‰ãªã‹ã£ãŸæ©Ÿèƒ½</h6>
        <div class="comment-box">{{ feedback.get('unclear_features') }}</div>
      {% endif %}

      {% if feedback.get('difficult_operation') %}
        <h6 class="mt-3">æ“ä½œã—ã¥ã‚‰ã‹ã£ãŸã¨ã“ã‚</h6>
        <div class="comment-box">{{ feedback.get('difficult_operation') }}</div>
      {% endif %}

      {% if feedback.get('overall_impression') %}
        <h6 class="mt-3">ã‚¢ãƒ—ãƒªå…¨ä½“ã®æ„Ÿæƒ³</h6>
        <div class="comment-box">{{ feedback.get('overall_impression') }}</div>
      {% endif %}

      {% if feedback.get('other_comments') %}
        <h6 class="mt-3">ãã®ä»–</h6>
        <div class="comment-box">{{ feedback.get('other_comments') }}</div>
      {% endif %}

      {% if not (feedback.get('desired_features') or feedback.get('unclear_features') or feedback.get('difficult_operation') or feedback.get('overall_impression') or feedback.get('other_comments')) %}
        <p class="text-muted">è‡ªç”±è¨˜è¿°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- æ·»ä»˜ç”»åƒ -->
    {% if feedback.get('image_base64_list') %}
    <div class="detail-card">
      <h5 class="section-title">æ·»ä»˜ç”»åƒ</h5>
      <div class="row">
        {% for image_base64 in feedback.get('image_base64_list') %}
        <div class="col-md-6 mb-3">
          <img src="data:image/png;base64,{{ image_base64 }}" class="image-preview" alt="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”»åƒ {{ loop.index }}" />
        </div>
        {% endfor %}
      </div>
    </div>
    {% elif feedback.get('image_base64') %}
    <!-- æ—§å½¢å¼ã®å˜ä¸€ç”»åƒå¯¾å¿œ -->
    <div class="detail-card">
      <h5 class="section-title">æ·»ä»˜ç”»åƒ</h5>
      <img src="data:image/png;base64,{{ feedback.get('image_base64') }}" class="image-preview" alt="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”»åƒ" />
    </div>
    {% endif %}

    <!-- æ·»ä»˜å‹•ç”» -->
    {% if feedback.get('video_base64_list') %}
    <div class="detail-card">
      <h5 class="section-title">æ·»ä»˜å‹•ç”»</h5>
      <div class="row">
        {% for video_base64 in feedback.get('video_base64_list') %}
        <div class="col-md-6 mb-3">
          <video controls class="image-preview" style="max-width:100%;">
            <source src="data:video/mp4;base64,{{ video_base64 }}" type="video/mp4">
            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã®å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
          </video>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- é‹è»¢è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ -->
    {% if sessions %}
    <div class="detail-card">
      <h5 class="section-title">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡å‰ã®é‹è»¢è¨˜éŒ²ï¼ˆæœ€æ–°10ä»¶ï¼‰</h5>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>é‹è»¢æ—¥æ™‚</th>
              <th>æ‰€è¦æ™‚é–“</th>
              <th>æ€¥ãƒ–ãƒ¬ãƒ¼ã‚­</th>
              <th>æ€¥ã‚«ãƒ¼ãƒ–</th>
              <th>æ€¥åŠ é€Ÿ</th>
              <th>è‰¯æ¸›é€Ÿ</th>
              <th>è‰¯ã‚«ãƒ¼ãƒ–</th>
              <th>è‰¯åŠ é€Ÿ</th>
              <th>è©³ç´°</th>
            </tr>
          </thead>
          <tbody>
            {% for session in sessions %}
            <tr>
              <td>
                {% if session.get('start_time') %}
                  {{ session.get('start_time').strftime('%Y/%m/%d %H:%M') }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if session.get('duration') %}
                  {{ (session.get('duration') // 60)|int }}åˆ†
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td><span class="badge bg-danger">{{ session.get('hard_brake_count', 0) }}</span></td>
              <td><span class="badge bg-warning text-dark">{{ session.get('hard_turn_count', 0) }}</span></td>
              <td><span class="badge bg-info">{{ session.get('hard_accel_count', 0) }}</span></td>
              <td><span class="badge bg-success">{{ session.get('good_brake_count', 0) }}</span></td>
              <td><span class="badge bg-success">{{ session.get('good_turn_count', 0) }}</span></td>
              <td><span class="badge bg-success">{{ session.get('good_accel_count', 0) }}</span></td>
              <td>
                <a href="{{ url_for('sessions.detail_result_page', session_id=session.get('id')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                  è©³ç´°ã‚’è¦‹ã‚‹
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="text-muted small mt-2">â€» ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡æ—¥æ™‚ï¼ˆ{{ feedback.get('created_at').strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') if feedback.get('created_at') else 'N/A' }}ï¼‰ä»¥å‰ã®è¨˜éŒ²ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
    </div>
    {% endif %}

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
