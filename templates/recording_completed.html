<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²å®Œäº†</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      background-color: #cdeae0;
      color: #333;
      margin: 0;
      padding-bottom: 55px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px;
    }

    .logo-area { display: flex; align-items: center; gap: 10px; }
    .logo-area img { width: 50px; height: 50px; }
    .title { font-size: 1.5em; font-weight: bold; color: #2090c2; }

    .main { text-align: center; padding: 20px; }

    .robot { width: 80px; height: 80px; border-radius: 50%; background-color: #fff; border: 2px solid #2b8ca6; margin-bottom: 5px; }

    .main-title { color: #4db6ac; font-size: 1.8em; font-weight: bold; margin-bottom: 10px; }

    .drive-info {
      display: flex; justify-content: center; gap: 40px;
      font-weight: bold; margin-bottom: 20px;
    }

    .section {
      background-color: #fff;
      border-radius: 8px;
      margin: 15px auto;
      padding: 15px 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      width: 90%;
      text-align: left;
    }

    .pin-feedback {
      background: #f5fbfd;
      border-left: 6px solid #4db6ac;
      padding: 10px 12px;
      margin: 10px 0;
      border-radius: 5px;
      transition: transform 0.2s;
    }

    .pin-feedback:hover { transform: scale(1.01); }

    .pin-label {
      font-weight: bold;
      color: #007c91;
      font-size: 1.05em;
    }

    .pin-comment { margin-top: 6px; color: #333; }

    .rating-badge {
      display: inline-block;
      font-weight: bold;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.9em;
      margin-left: 8px;
    }

    .rating-good { background: #b3e5fc; color: #0277bd; }
    .rating-verygood { background: #c8e6c9; color: #2e7d32; }
    .rating-normal { background: #fff9c4; color: #795548; }
    .rating-bad { background: #ffcdd2; color: #c62828; }
    .rating-none { background: #e0e0e0; color: #555; }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .custom-nav-bar {
      background: #378da0;
      border-top: 2px solid #5a7d8d;
      height: 45px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-area">
      <img src="{{ url_for('static', filename='img/icon.png') }}" alt="ãƒ­ã‚´">
      <div class="title">ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</div>
    </div>
  </header>

  <main class="main">
    <img src="{{ url_for('static', filename='img/robot.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot">
    <div class="main-title">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</div>

    <div class="drive-info">
      <div>èµ°è¡Œæ™‚é–“<br><span id="total-time">--:--</span></div>
      <div>èµ°è¡Œè·é›¢<br><span id="total-distance">-- km</span></div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-section" class="section">
      <h2>ğŸ¤– ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—ä¸­...</h2>
      <p style="text-align:center;">
        <div style="display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #2090c2;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
        é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
      </p>
    </div>

    <!-- é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
    <div id="focus-feedback-section" class="section" style="display:none;">
      <h2>é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®è©•ä¾¡</h2>
      <div id="focus-feedback-list"></div>
    </div>

    {% if session %}
      <div style="margin-top: 20px;">
        <a href="{{ url_for('sessions.detail_result_page', session_id=session.id) }}" class="btn btn-primary">
          ğŸš— è¨˜éŒ²ã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹
        </a>
      </div>
    {% endif %}
  </main>

  <!-- âœ… Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
      storageBucket: "drive-prototype-32ef0.firebasestorage.app",
      messagingSenderId: "500916744769",
      appId: "1:500916744769:web:d5a529ef05d15bb2934cc0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getRatingBadge(rating) {
      switch (rating) {
        case "ã¨ã¦ã‚‚ã„ã„": return `<span class="rating-badge rating-verygood">ğŸ˜ ã¨ã¦ã‚‚ã„ã„</span>`;
        case "ã„ã„": return `<span class="rating-badge rating-good">ğŸ˜Š ã„ã„</span>`;
        case "ãµã¤ã†": return `<span class="rating-badge rating-normal">ğŸ˜ ãµã¤ã†</span>`;
        case "ã‚ã‚‹ã„": return `<span class="rating-badge rating-bad">ğŸ˜¢ ã‚ã‚‹ã„</span>`;
        default: return `<span class="rating-badge rating-none">æœªè©•ä¾¡</span>`;
      }
    }

    async function loadFocusFeedbacks(sessionId) {
      const listDiv = document.getElementById("focus-feedback-list");
      const section = document.getElementById("focus-feedback-section");
      const loading = document.getElementById("loading-section");

      try {
        const snapshot = await db.collection("sessions").doc(sessionId)
          .collection("focus_feedbacks")
          .orderBy("created_at", "desc")
          .get();

        loading.style.display = "none";
        section.style.display = "block";
        listDiv.innerHTML = "";

        snapshot.forEach(doc => {
          const d = doc.data();
          d.id = doc.id;  // âœ… â† Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’è¿½åŠ ï¼

          const badge = getRatingBadge(d.rating);
          const div = document.createElement("div");
          div.className = "pin-feedback";

          div.innerHTML = `
            <div class="pin-label">ğŸ“ ${d.pin_label || "(ãƒ©ãƒ™ãƒ«ãªã—)"} ${badge}</div>
            <div style="margin-left:1.2em;color:#00796b;font-size:0.95em;">
              ğŸ¯ ${d.focus_label || "æ„è­˜ãƒã‚¤ãƒ³ãƒˆæœªè¨­å®š"}
            </div>
            <div class="pin-comment">
              ğŸ’¬ ${(d.short_comment || "ã‚³ãƒ¡ãƒ³ãƒˆãªã—").replace(/\n/g, "<br>")}
              <div style="text-align:right;margin-top:4px;">
                <a href="/feedback_detail_completed/${sessionId}/${d.id}"
                  style="color:#007bff;font-size:0.9em;text-decoration:none;">
                  â¡ è©³ç´°ã‚’è¦‹ã‚‹
                </a>
              </div>
            </div>
          `;
          listDiv.appendChild(div);

          // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆç¢ºèªç”¨ï¼‰
          console.log("ğŸ¯ session:", sessionId, "pin_id:", d.id);
        });

      } catch (err) {
        console.error("âŒ focus_feedbacks èª­ã¿è¾¼ã¿å¤±æ•—:", err);
        listDiv.innerHTML = `<div style="text-align:center;color:#d00;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sessionData = localStorage.getItem("lastSessionData");
      if (!sessionData) return;
      const parsed = JSON.parse(sessionData);

      document.getElementById("total-time").textContent = parsed.totalTime || "--:--";
      document.getElementById("total-distance").textContent = (parsed.distance || 0).toFixed(2) + " km";

      if (parsed.session_id) loadFocusFeedbacks(parsed.session_id);
    });
  </script>
</body>
</html>
