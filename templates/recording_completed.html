<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²å®Œäº†</title>

  <!-- âœ… Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #cdeae0;
      color: #333;
      padding-bottom: 55px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-area img { width: 50px; height: 50px; }

    .title { font-size: 1.5em; font-weight: bold; color: #2090c2; }

    .main {
      text-align: center;
      padding: 20px;
    }

    .robot {
      width: 80px; height: 80px;
      border-radius: 50%; background-color: #fff;
      border: 2px solid #2b8ca6; margin-bottom: 5px;
    }

    .main-title {
      color: #4db6ac; font-size: 1.8em; font-weight: bold; margin-bottom: 10px;
    }

    .drive-info {
      display: flex; justify-content: center; gap: 40px;
      font-weight: bold; margin-bottom: 20px;
    }

    .section {
      background-color: #fff;
      border-radius: 8px;
      margin: 15px auto;
      padding: 15px 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      width: 90%;
      text-align: left;
    }

    .section h2 {
      font-size: 1.3em;
      color: #2090c2;
      margin-bottom: 8px;
      border-bottom: 2px solid #a5dbe0;
      padding-bottom: 4px;
    }

    .pin-feedback {
      background: #f5fbfd;
      border-left: 5px solid #4db6ac;
      padding: 10px 12px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .pin-label {
      font-weight: bold;
      color: #007c91;
      font-size: 1.05em;
    }

    .pin-comment {
      margin-top: 4px;
      color: #333;
    }

    .custom-nav-bar {
      background: #378da0;
      border-top: 2px solid #5a7d8d;
      box-shadow: inset 0 0 5px rgba(0,0,0,.2);
      height: 45px;
    }
    .custom-nav-link {
      color: #fff; font-weight: bold;
      font-size: 1rem; padding: 0 1rem;
      line-height: 41px; height: 100%; display: block;
    }
    .custom-nav-item:not(:last-child) {
      border-right: 1px solid #5a7d8d;
    }
    .active-glow .custom-nav-link.active {
      color: black;
      background: rgba(255,255,255,.05);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-area">
      <img src="{{ url_for('static', filename='img/icon.png') }}" alt="ãƒ­ã‚´">
      <div class="title">ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</div>
    </div>
  </header>

  <main class="main">
    <img src="{{ url_for('static', filename='img/robot.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot">
    <div class="main-title">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</div>

    <div class="drive-info">
      <div>èµ°è¡Œæ™‚é–“<br><span id="total-time">--:--</span></div>
      <div>èµ°è¡Œè·é›¢<br><span id="total-distance">-- km</span></div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-section" class="section">
      <h2>ğŸ¤– ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—ä¸­...</h2>
      <p style="text-align:center;">
        <div style="display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #2090c2;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
        é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
      </p>
    </div>

    <!-- é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
    <div id="focus-feedback-section" class="section" style="display:none;">
      <h2>é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
      <div id="focus-feedback-list"></div>
    </div>

    <!-- è©³ç´°ãƒªã‚¶ãƒ«ãƒˆãƒšãƒ¼ã‚¸ã¸ã®é·ç§» -->
    {% if session %}
      <div style="margin-top: 20px;">
        <a href="{{ url_for('sessions.detail_result_page', session_id=session.id) }}" class="btn btn-primary">
          ğŸš— è¨˜éŒ²ã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹
        </a>
      </div>
    {% else %}
      <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
    {% endif %}
  </main>

  <!-- âœ… ãƒŠãƒ“ãƒãƒ¼ -->
  <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('views.home') }}" class="nav-link custom-nav-link">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a class="nav-link custom-nav-link active" href="{{ url_for('views.recording_start') }}">é‹è»¢</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('sessions.results_page') }}" class="nav-link custom-nav-link">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- âœ… Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
      authDomain: "drive-prototype-32ef0.firebaseapp.com",
      projectId: "drive-prototype-32ef0",
      storageBucket: "drive-prototype-32ef0.firebasestorage.app",
      messagingSenderId: "500916744769",
      appId: "1:500916744769:web:d5a529ef05d15bb2934cc0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadFocusFeedbacks(sessionId) {
      const listDiv = document.getElementById("focus-feedback-list");
      const section = document.getElementById("focus-feedback-section");
      const loading = document.getElementById("loading-section");
      let firstLoaded = false;
      let timeoutTriggered = false;

      try {
        // --- â±ï¸ 5ç§’çµŒéã—ãŸã‚‰å¼·åˆ¶çš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º ---
        const timeout = setTimeout(() => {
          if (!firstLoaded && !timeoutTriggered) {
            timeoutTriggered = true;
            loading.style.display = "none";
            section.style.display = "block";
            listDiv.innerHTML = `
              <div style="text-align:center; color:#777; padding:10px;">
                ğŸš§ é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ãªã„ã‚ˆï¼
              </div>
            `;
          }
        }, 5000); // 5ç§’

        // --- ğŸ” Firestore ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– ---
        db.collection("sessions")
          .doc(sessionId)
          .collection("focus_feedbacks")
          .orderBy("created_at", "desc")
          .onSnapshot(snapshot => {
            if (!snapshot.empty) {
              // âœ… åˆå›ãƒ‡ãƒ¼ã‚¿åˆ°ç€
              firstLoaded = true;
              clearTimeout(timeout);

              loading.style.display = "none";
              section.style.display = "block";
              listDiv.innerHTML = "";

              snapshot.forEach(doc => {
                const d = doc.data();
                const div = document.createElement("div");
                div.className = "pin-feedback";
                div.innerHTML = `
                  <div class="pin-label">ğŸ“ ${d.pin_label || "(ãƒ©ãƒ™ãƒ«ãªã—)"}</div>
                  <div class="pin-comment">${d.ai_comment || "ã‚³ãƒ¡ãƒ³ãƒˆãªã—"}</div>
                  <div style="font-size:0.9em;color:#555;margin-top:4px;">
                    å¹³å‡é€Ÿåº¦: ${d.stats?.avg_speed ?? "--"} km/hã€€
                    å‰å¾ŒG: ${d.stats?.mean_gz ?? "--"}ã€€
                    æ¨ªG: ${d.stats?.mean_gx ?? "--"}
                  </div>
                `;
                listDiv.appendChild(div);
              });
            }
          }, error => {
            console.error("âŒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
            clearTimeout(timeout);
            loading.style.display = "none";
            section.style.display = "block";
            listDiv.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>";
          });

      } catch (e) {
        console.error("âŒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
        loading.style.display = "none";
        section.style.display = "block";
        listDiv.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sessionData = localStorage.getItem("lastSessionData");
      if (!sessionData) {
        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      try {
        const parsed = JSON.parse(sessionData);
        document.getElementById("total-time").textContent = parsed.totalTime || "--:--";
        document.getElementById("total-distance").textContent = (parsed.distance || 0).toFixed(2) + " km";

        if (parsed.session_id) {
          loadFocusFeedbacks(parsed.session_id);
        }
      } catch (e) {
        console.error("âŒ JSON parse error:", e);
        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });
  </script>
</body>
</html>
