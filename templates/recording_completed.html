<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²å®Œäº†</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #cdeae0;
            color: #333;
            margin: 0;
            padding-bottom: 55px;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px;
        }

        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-area img { width: 50px; height: 50px; }
        .title { font-size: 1.5em; font-weight: bold; color: #2090c2; }

        .main { text-align: center; padding: 20px; }

        .robot { width: 80px; height: 80px; border-radius: 50%; background-color: #fff; border: 2px solid #2b8ca6; margin-bottom: 5px; }

        .main-title { color: #4db6ac; font-size: 1.8em; font-weight: bold; margin-bottom: 10px; }

        .drive-info {
            display: flex; justify-content: center; gap: 40px;
            font-weight: bold; margin-bottom: 20px;
        }

        /* --- ç·åˆã‚¹ã‚³ã‚¢è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .score-card {
            margin: 20px auto 30px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            max-width: 300px;
            text-align: center;
            border: 1px solid #e1f5fe;
        }

        .score-label {
            color: #2090c2;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .score-circle {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
            border-radius: 50%;
            background: #f0f8ff; /* Light blue background */
            border: 8px solid #e0f7fa; /* Very light border */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            transition: all 0.5s;
        }

        .score-number {
            font-size: 3.5em;
            font-weight: 900;
            color: #ccc; /* Initial loading color */
            position: relative;
            z-index: 10;
        }
        
        .score-number-subtext {
            font-size: 1.2em;
            font-weight: bold;
            color: #2090c2;
            margin-top: 5px;
        }
        /* --------------------------------- */

        .section {
            background-color: #fff;
            border-radius: 8px;
            margin: 15px auto;
            padding: 15px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            width: 90%;
            text-align: left;
        }

        .pin-feedback {
            background: #f5fbfd;
            border-left: 6px solid #4db6ac;
            padding: 10px 12px;
            margin: 10px 0;
            border-radius: 5px;
            transition: transform 0.2s;
        }

        .pin-feedback:hover { transform: scale(1.01); }

        .pin-label {
            font-weight: bold;
            color: #007c91;
            font-size: 1.05em;
        }

        .pin-comment { margin-top: 6px; color: #333; }

        .rating-badge {
            display: inline-block;
            font-weight: bold;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .rating-good { background: #b3e5fc; color: #0277bd; }
        .rating-verygood { background: #c8e6c9; color: #2e7d32; }
        .rating-normal { background: #fff9c4; color: #795548; }
        .rating-bad { background: #ffcdd2; color: #c62828; }
        .rating-none { background: #e0e0e0; color: #555; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-nav-bar {
            background: #378da0;
            border-top: 2px solid #5a7d8d;
            height: 45px;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo-area">
            <!-- å®Ÿéš›ã®ç’°å¢ƒã«åˆã‚ã›ã¦imgã‚¿ã‚°ã®URLã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ -->
            <img src="https://placehold.co/50x50/2090c2/ffffff?text=DB" alt="ãƒ­ã‚´">
            <div class="title">ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</div>
        </div>
    </header>

    <main class="main">
        <!-- å®Ÿéš›ã®ç’°å¢ƒã«åˆã‚ã›ã¦imgã‚¿ã‚°ã®URLã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ -->
        <img src="/static/img/robot_active.png" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot">
        <div class="main-title">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</div>

        <!-- èµ°è¡Œæ™‚é–“ã¨èµ°è¡Œè·é›¢ -->
        <div class="drive-info">
            <div>èµ°è¡Œæ™‚é–“<br>
                <span id="total-time">
                    {% if session and session.start_time and session.end_time %}
                        {{ ((session.end_time - session.start_time).total_seconds() // 60)|int }}:
                        {{ ((session.end_time - session.start_time).total_seconds() % 60)|int }}
                    {% else %}
                        --:--
                    {% endif %}
                </span>
            </div>

            <div>èµ°è¡Œè·é›¢<br>
                <span id="total-distance">
                    {% if session and session.distance %}
                        {{ '%.2f'|format(session.distance) }} km
                    {% else %}
                        -- km
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- --- ç·åˆã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ (NEW) --- -->
        <div id="overall-score-section" class="score-card">
            <div class="score-label">ç·åˆé‹è»¢ã‚¹ã‚³ã‚¢ (Overall Score)</div>
            <div class="score-circle">
                <div id="overall-score-display" class="score-number">--</div>
            </div>
            <div class="score-number-subtext">/ 100</div>
            <div id="overall-score-comment" style="margin-top:10px;color:#00796b;font-size:1em;"></div>
        </div>
        <!-- --------------------------------------- -->

        <div id="completed-route-name" 
            style="font-size:1.3em; font-weight:bold; margin: 10px 0; color:#007c91;">
            ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼šèª­ã¿è¾¼ã¿ä¸­...
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div id="loading-section" class="section">
            <h2>ğŸ¤– ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆä¸­...</h2>
            <p style="text-align:center;">
                <div style="display:inline-block;width:22px;height:22px;border:3px solid #f3f3f3;border-top:3px solid #2090c2;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
                AIãŒèµ°è¡Œãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...
            </p>
            <p id="loading-hint" style="text-align:center;color:#007c91;font-size:0.9em;margin-top:5px;">
                ï¼ˆèµ°è¡Œè·é›¢ãŒé•·ã„å ´åˆç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ï¼‰
            </p>
        </div>

        <!-- é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        <div id="focus-feedback-section" class="section" style="display:none;">
            <h2>é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®è©•ä¾¡</h2>
            <div id="focus-feedback-list"></div>
        </div>

        {% if session %}
            <div style="margin-top: 20px;">
                <!-- `url_for` ã¯Flaskãªã©ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³æ©Ÿèƒ½ã§ã™ã€‚ç’°å¢ƒã«åˆã‚ã›ã¦é©åˆ‡ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ -->
                <a href="{{ url_for('sessions.detail_result_page', session_id=session.id) }}" class="btn btn-primary">
                    ğŸš— è¨˜éŒ²ã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹
                </a>
            </div>
        {% endif %}
    </main>

    <!-- âœ… Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        // Firestoreã®è¨­å®š (ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„)
        const firebaseConfig = {
            apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
            authDomain: "drive-prototype-32ef0.firebaseapp.com",
            projectId: "drive-prototype-32ef0",
            storageBucket: "drive-prototype-32ef0.firebasestorage.app",
            messagingSenderId: "500916744769",
            appId: "1:500916744769:web:d5a529ef05d15bb2934cc0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // è©•ä¾¡ãƒãƒƒã‚¸ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getRatingBadge(rating) {
            switch (rating) {
                case "ã¨ã¦ã‚‚ã„ã„": return `<span class="rating-badge rating-verygood">ğŸ˜ ã¨ã¦ã‚‚ã„ã„</span>`;
                case "ã„ã„": return `<span class="rating-badge rating-good">ğŸ˜Š ã„ã„</span>`;
                case "ãµã¤ã†": return `<span class="rating-badge rating-normal">ğŸ˜ ãµã¤ã†</span>`;
                case "ã‚ã‚‹ã„": return `<span class="rating-badge rating-bad">ğŸ˜¢ ã‚ã‚‹ã„</span>`;
                default: return `<span class="rating-badge rating-none">æœªè©•ä¾¡</span>`;
            }
        }

        // èµ°è¡Œã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç·åˆã‚¹ã‚³ã‚¢ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadOverallScore(sessionId) {
            const scoreDisplayEl = document.getElementById("overall-score-display");
            const scoreCircleEl = document.getElementById("overall-score-section").querySelector('.score-circle');
            const scoreCommentEl = document.getElementById("overall-score-comment");
            
            // ã‚¹ã‚³ã‚¢ãŒè¨ˆç®—ã•ã‚Œã‚‹ã¾ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            scoreDisplayEl.textContent = "00";
            scoreDisplayEl.style.color = "#ccc";
            scoreCircleEl.style.borderColor = "#e0f7fa";
            scoreCommentEl.textContent = "";

            const docRef = db.collection("sessions").doc(sessionId);

            // onSnapshotã‚’ä½¿ã£ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚¹ã‚³ã‚¢ã®æ›´æ–°ã‚’å¾…ã¡ã¾ã™
            const unsubscribe = docRef.onSnapshot(doc => {
                if (!doc.exists) {
                    scoreDisplayEl.textContent = "N/A";
                    scoreDisplayEl.style.color = "#ff0000";
                    scoreCommentEl.textContent = "ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                    unsubscribe(); 
                    return;
                }

                const data = doc.data();
                const score = data.overall_score; // Pythonå´ã§è¨­å®šã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
                const scoreComment = data.score_comment || "";

                if (score !== undefined && score !== null) {
                    const roundedScore = Math.round(score);
                    scoreDisplayEl.textContent = roundedScore;
                    scoreCommentEl.textContent = scoreComment;
                    // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è‰²ã‚’èª¿æ•´
                    let colorCode = "#2090c2";
                    let borderColorCode = "#2b8ca6";

                    if (roundedScore >= 85) {
                        colorCode = "#2e7d32"; // Very Good (Green)
                        borderColorCode = "#a5d6a7";
                    } else if (roundedScore >= 60) {
                        colorCode = "#ffa000"; // Normal (Amber)
                        borderColorCode = "#fff176";
                    } else {
                        colorCode = "#c62828"; // Bad (Red)
                        borderColorCode = "#ef9a9a";
                    }

                    scoreDisplayEl.style.color = colorCode;
                    scoreCircleEl.style.borderColor = borderColorCode;

                    unsubscribe(); // ã‚¹ã‚³ã‚¢ãŒå–å¾—ã§ããŸã‚‰ç›£è¦–ã‚’åœæ­¢
                } else {
                    // ã‚¹ã‚³ã‚¢ãŒã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç¶­æŒ
                    scoreDisplayEl.textContent = "00";
                    scoreDisplayEl.style.color = "#ccc"; 
                    scoreCircleEl.style.borderColor = "#e0f7fa";
                    scoreCommentEl.textContent = "";
                }

            }, error => {
                console.error("ç·åˆã‚¹ã‚³ã‚¢èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                scoreDisplayEl.textContent = "ERR";
                scoreDisplayEl.style.color = "#ff0000";
                scoreCircleEl.style.borderColor = "#ffcdd2";
                unsubscribe();
            });
        }


        // é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadFocusFeedbacks(sessionId) {
            const listDiv = document.getElementById("focus-feedback-list");
            const section = document.getElementById("focus-feedback-section");
            const loading = document.getElementById("loading-section");
            const hint = document.getElementById("loading-hint");

            loading.style.display = "block";
            section.style.display = "none";
            listDiv.innerHTML = "";

            const ref = db.collection("sessions")
                .doc(sessionId)
                .collection("focus_feedbacks")
                .orderBy("created_at", "desc");

            ref.onSnapshot(snapshot => {
                if (snapshot.empty && loading.style.display !== "none") {
                    hint.textContent = "åˆ†æä¸­ã§ã™ã€‚é †æ¬¡ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...";
                    return;
                }

                if (!snapshot.empty) {
                    loading.style.display = "none";
                    section.style.display = "block";
                }

                const existingIds = Array.from(
                    document.querySelectorAll(".pin-feedback")
                ).map(div => div.dataset.id);

                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const d = change.doc.data();
                        d.id = change.doc.id;

                        if (existingIds.includes(d.id)) return;

                        const badge = getRatingBadge(d.rating);
                        const div = document.createElement("div");
                        div.className = "pin-feedback";
                        div.dataset.id = d.id;

                        div.innerHTML = `
                            <div class="pin-label">ğŸ“ ${d.pin_label || "(ãƒ©ãƒ™ãƒ«ãªã—)"} ${badge}</div>
                            <div style="margin-left:1.2em;color:#00796b;font-size:0.95em;">
                                ğŸ¯ ${d.focus_label || "æ„è­˜ãƒã‚¤ãƒ³ãƒˆæœªè¨­å®š"}
                                <span style="margin-left:10px;color:#2090c2;font-weight:bold;">
                                    ${d.score !== undefined ? `ğŸŸ¢ ${d.score}ç‚¹` : ""}
                                </span>
                            </div>
                            <div class="pin-comment">
                                ğŸ’¬ ${(d.short_comment || "ã‚³ãƒ¡ãƒ³ãƒˆãªã—").replace(/\n/g, "<br>")}
                                <div style="text-align:right;margin-top:4px;">
                                    <a href="/feedback_detail_completed/${sessionId}/${d.id}"
                                        style="color:#007bff;font-size:0.9em;text-decoration:none;">
                                        â¡ è©³ç´°ã‚’è¦‹ã‚‹
                                    </a>
                                </div>
                            </div>
                        `;

                        listDiv.insertBefore(div, listDiv.firstChild);
                    }
                });
            });
        }
        
        // èµ°è¡Œãƒ«ãƒ¼ãƒˆåã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadCompletedRouteName() {
            const routeNameEl = document.getElementById("completed-route-name");
            // `recording_start.html` ã§ä¿å­˜ã—ãŸã‚­ãƒ¼ã‚’ä½¿ç”¨
            const routeId = localStorage.getItem("CURRENT_ROUTE_ID"); 

            if (!routeId) {
                routeNameEl.textContent = "ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼šå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
                return;
            }

            routeNameEl.textContent = "ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼šèª­ã¿è¾¼ã¿ä¸­...";

            try {
                const doc = await db.collection("priority_routes").doc(routeId).get();
                if (!doc.exists) {
                    routeNameEl.textContent = "ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼šä¸æ˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰";
                    return;
                }

                const data = doc.data();
                const routeName = data.name || "åç§°æœªè¨­å®š"; Â  

                routeNameEl.textContent = `ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼š${routeName}`;
            } catch (err) {
                console.error("ãƒ«ãƒ¼ãƒˆåèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
                routeNameEl.textContent = "ä»Šå›èµ°ã£ãŸãƒ«ãƒ¼ãƒˆï¼šå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼";
            }
        }

        // å…¨ã¦ã®å‡¦ç†ã‚’é–‹å§‹
        document.addEventListener("DOMContentLoaded", () => {
            const sessionId = "{{ session.id }}"; 
            
            // ãƒ«ãƒ¼ãƒˆåã¨ã‚¹ã‚³ã‚¢ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹
            if (sessionId) {
                loadCompletedRouteName();
                loadOverallScore(sessionId); 
                loadFocusFeedbacks(sessionId);
            }
        });
    </script>
</body>
</html>