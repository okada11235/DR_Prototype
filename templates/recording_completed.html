<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ - è¨˜éŒ²å®Œäº†</title>

  <!-- âœ… Bootstrapã‚’è¿½åŠ  -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #cdeae0;
      color: #333;
      padding-bottom: 55px; /* ãƒŠãƒ“åˆ†ã®ä½™ç™½ */
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-area img {
      width: 50px;
      height: 50px;
    }

    .title {
      font-size: 1.5em;
      font-weight: bold;
      color: #2090c2;
    }

    .main {
      text-align: center;
      padding: 20px;
    }

    .robot {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #fff;
      border: 2px solid #2b8ca6;
      margin-bottom: 5px;
    }

    .main-title {
      color: #4db6ac;
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .drive-info {
      display: flex;
      justify-content: center;
      gap: 40px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .section {
      background-color: #fff;
      border-radius: 6px;
      margin: 15px auto;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      width: 90%;
      text-align: left;
    }

    .section h2 {
      font-size: 1.3em;
      color: #2090c2;
      margin-bottom: 8px;
      border-bottom: 2px solid #a5dbe0;
      padding-bottom: 4px;
    }

    .score {
      font-size: 1.6em;
      font-weight: bold;
      color: #d32f2f;
      margin-left: 5px;
    }

    .comment {
      font-size: 0.95em;
      color: #444;
      margin-top: 5px;
    }

    .highlight {
      color: #e44d8f;
      font-weight: bold;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === ãƒŠãƒ“ãƒãƒ¼çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆresult.htmlã¨å®Œå…¨ä¸€è‡´ï¼‰ === */
    .custom-nav-bar {
      background: #378da0;
      border-top: 2px solid #5a7d8d;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
      height: 45px;
    }

    /* å„é …ç›® */
    .custom-nav-item {
      flex: 1;
    }

    .custom-nav-bar{background:#378da0;border-top:2px solid #5a7d8d;box-shadow:inset 0 0 5px rgba(0,0,0,.2);height:45px}
    .custom-nav-link{color:#fff;font-weight:bold;font-size:1rem;padding:0 1rem;line-height:41px;height:100%;display:block}
    .custom-nav-item:not(:last-child){border-right:1px solid #5a7d8d}
    .active-glow .custom-nav-link.active{color:rgb(0, 0, 0);background:rgba(255,255,255,.05)}

  </style>
</head>
<body>

  <header>
    <div class="logo-area">
      <img src="{{ url_for('static', filename='img/icon.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£ãƒ­ã‚´">
      <div class="title">ãƒ‰ãƒ©ã‚¤ãƒ–ãƒãƒ‡ã‚£</div>
    </div>
  </header>

  <main class="main">
    <img src="{{ url_for('static', filename='img/robot.png') }}" alt="ãƒ‰ãƒ©ã‚¤ãƒœ" class="robot">
    <div class="main-title">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</div>

    <div class="drive-info">
      <div>èµ°è¡Œæ™‚é–“<br><span id="total-time">--:--</span></div>
      <div>èµ°è¡Œè·é›¢<br><span id="total-distance">-- km</span></div>
    </div>

    <!-- AIè©•ä¾¡ç”Ÿæˆä¸­ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-section" class="section">
      <h2>ğŸ¤– AIè©•ä¾¡ç”Ÿæˆä¸­...</h2>
      <p style="text-align: center;">
        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #2090c2; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
        é‹è»¢ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...
      </p>
    </div>

    <!-- æ¸›é€Ÿ -->
    <div class="section evaluation-section" style="display: none;">
      <h2>æ¸›é€Ÿ</h2>
      <p>çµæœï¼šåˆ†æä¸­...</p>
      <p>è©³ç´°ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
    </div>

    <!-- åŠ é€Ÿ -->
    <div class="section evaluation-section" style="display: none;">
      <h2>åŠ é€Ÿ</h2>
      <p>çµæœï¼šåˆ†æä¸­...</p>
      <p>è©³ç´°ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
    </div>

    <!-- æ—‹å› -->
    <div class="section evaluation-section" style="display: none;">
      <h2>æ—‹å›</h2>
      <p>çµæœï¼šåˆ†æä¸­...</p>
      <p>è©³ç´°ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
    </div>

    <!-- ç›´é€² -->
    <div class="section evaluation-section" style="display: none;">
      <h2>ç›´é€²</h2>
      <p>çµæœï¼šåˆ†æä¸­...</p>
      <p>è©³ç´°ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
    </div>

    <!-- ç·è©• -->
    <div class="section evaluation-section" style="display: none;">
      <h2>ç·è©•</h2>
      <p>AIè©•ä¾¡ã‚’ç”Ÿæˆä¸­ã§ã™...</p>
    </div>
  </main>

  <!-- âœ… å…±é€šãƒŠãƒ“ãƒãƒ¼ -->
  <nav class="navbar navbar-expand custom-nav-bar fixed-bottom">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav w-100 text-center">
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('views.home') }}" class="nav-link custom-nav-link">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="nav-item flex-fill custom-nav-item active-glow">
          <a class="nav-link custom-nav-link active" href="{{ url_for('views.recording_start') }}">é‹è»¢</a>
        </li>

        <!-- âœ… ã“ã“ã« active-glow ã‚’ä»˜ã‘ã‚‹ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ãŒâ€œãƒªã‚¶ãƒ«ãƒˆâ€ãªã‚‰ï¼‰ -->
        <li class="nav-item flex-fill custom-nav-item">
          <a href="{{ url_for('sessions.results_page') }}" class="nav-link custom-nav-link">ãƒªã‚¶ãƒ«ãƒˆ</a>
        </li>

        <li class="nav-item flex-fill custom-nav-item">
          <a class="nav-link custom-nav-link" href="{{ url_for('views.map_editor') }}">ãƒãƒƒãƒ—</a>
        </li>
        <li class="nav-item flex-fill custom-nav-item border-end-0">
          <a class="nav-link custom-nav-link" href="#">èª¬æ˜</a>
        </li>
      </ul>
    </div>
  </nav>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEuouICKd32x3-4y5QzA_2ovq8pydvez4",
            authDomain: "drive-prototype-32ef0.firebaseapp.com",
            projectId: "drive-prototype-32ef0",
            storageBucket: "drive-prototype-32ef0.firebasestorage.app",
            messagingSenderId: "500916744769",
            appId: "1:500916744769:web:d5a529ef05d15bb2934cc0",
            measurementId: "G-9CH5CGYCFM"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentSessionId = null;
        let selectedFocusPoint = null;

        function displaySessionResults(sessionData) {
            document.getElementById('total-time').textContent = sessionData.totalTime || '--:--';
            document.getElementById('total-distance').textContent = (sessionData.distance || 0).toFixed(2) + ' km';
            currentSessionId = sessionData.session_id;
            selectedFocusPoint = sessionData.focus_point;
        }

        async function generateAndDisplayAIEvaluation(sessionId, focusPoint) {
            try {
                console.log('Generating AI evaluation for session:', sessionId, 'focus:', focusPoint);
                
                // ã¾ãšæ—¢å­˜ã®è©•ä¾¡ã‚’ç¢ºèª
                const getResponse = await fetch(`/get_ai_evaluation/${sessionId}`);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãªã„å ´åˆï¼ˆä¾‹ï¼šèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰ã®ãƒã‚§ãƒƒã‚¯
                const getContentType = getResponse.headers.get('content-type');
                if (!getContentType || !getContentType.includes('application/json')) {
                    console.error('Non-JSON response received:', getResponse.status, getResponse.statusText);
                    if (getResponse.status === 401 || getResponse.status === 302) {
                        showErrorMessage('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                        window.location.href = '/login';
                        return;
                    }
                    // 404ã®å ´åˆã¯è©•ä¾¡ãŒå­˜åœ¨ã—ãªã„ã¨ã„ã†ã“ã¨ãªã®ã§ã€æ–°è¦ç”Ÿæˆã«é€²ã‚€
                    if (getResponse.status === 404) {
                        console.log('AI evaluation not found, generating new one...');
                    } else {
                        showErrorMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${getResponse.status})`);
                        return;
                    }
                } else {
                    const getResult = await getResponse.json();
                    
                    if (getResult.status === 'ok') {
                        // æ—¢ã«è©•ä¾¡ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯è¡¨ç¤º
                        displayAIEvaluation(getResult.evaluation);
                        return;
                    }
                }
                
                // è©•ä¾¡ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç”Ÿæˆ
                const response = await fetch(`/generate_ai_evaluation/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        focus_point: focusPoint || ''
                    })
                });
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãªã„å ´åˆï¼ˆä¾‹ï¼šèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰ã®å‡¦ç†
                const postContentType = response.headers.get('content-type');
                if (!postContentType || !postContentType.includes('application/json')) {
                    console.error('Non-JSON response received:', response.status, response.statusText);
                    if (response.status === 401 || response.status === 302) {
                        showErrorMessage('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                        window.location.href = '/login';
                        return;
                    }
                    showErrorMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${response.status})`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    displayAIEvaluation(result.evaluation);
                } else {
                    console.error('Failed to generate AI evaluation:', result.message);
                    showErrorMessage('è©•ä¾¡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || ''));
                }
                
            } catch (error) {
                console.error('Error generating AI evaluation:', error);
                showErrorMessage('è©•ä¾¡ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function displayAIEvaluation(evaluation) {
          try {
            const aiEval = evaluation.ai_evaluation || evaluation;
            const comments = aiEval.comments || {};

            // ğŸ”¹ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            const loadingSection = document.getElementById("loading-section");
            if (loadingSection) loadingSection.style.display = "none";

            // ğŸ”¹ è©•ä¾¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
            const evaluationSections = document.querySelectorAll(".evaluation-section");
            evaluationSections.forEach(section => (section.style.display = "block"));

            // ğŸ”¹ å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆã‚¹ã‚³ã‚¢ãªã—ï¼‰
            updateSection("brake", comments.brake);
            updateSection("accel", comments.accel);
            updateSection("turn", comments.turn);
            updateSection("straight", comments.straight);

            // ğŸ”¹ ç·è©•ã‚’æ›´æ–°
            updateOverallSection(null, aiEval.overall_comment || "å…¨ä½“ã‚³ãƒ¡ãƒ³ãƒˆãªã—");

          } catch (err) {
            console.error("âŒ Error displaying AI evaluation:", err);
            showErrorMessage("AIè©•ä¾¡ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          }
        }

        function updateSection(sectionType, commentData) {
          const sections = document.querySelectorAll(".section h2");
          for (let section of sections) {
            const sectionName = section.textContent;
            let matches = false;

            if (sectionType === "brake" && sectionName.includes("æ¸›é€Ÿ")) matches = true;
            else if (sectionType === "accel" && sectionName.includes("åŠ é€Ÿ")) matches = true;
            else if (sectionType === "turn" && sectionName.includes("æ—‹å›")) matches = true;
            else if (sectionType === "straight" && sectionName.includes("ç›´é€²")) matches = true;

            if (matches) {
              const parentDiv = section.closest(".section");
              const paragraphs = parentDiv.querySelectorAll("p");

              // ğŸ”¹ commentData ãŒ null ã®å ´åˆã‚’å®‰å…¨ã«å‡¦ç†
              const detail = commentData?.detail || "è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—";
              const comment = commentData?.comment || "ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãªã—";

              // ğŸ”¹ è¡¨ç¤ºæ›´æ–°
              if (paragraphs[0]) paragraphs[0].textContent = `è©³ç´°ï¼š${detail}`;
              if (paragraphs[1]) {
                paragraphs[1].className = "comment";
                paragraphs[1].textContent = `ã‚³ãƒ¡ãƒ³ãƒˆï¼š${comment}`;
              }
              break;
            }
          }
        }

        function updateOverallSection(overallScore, overallComment) {
            const sections = document.querySelectorAll('.section h2');
            for (let section of sections) {
                if (section.textContent.includes('ç·è©•')) {
                    const parentDiv = section.closest('.section');
                    
                    const paragraph = parentDiv.querySelector('p');
                    if (paragraph) {
                        paragraph.textContent = overallComment;
                    }
                    break;
                }
            }
        }

        function updateFocusPointSection(focusPoint, evaluation) {
            const sections = document.querySelectorAll('.section h2');
            for (let section of sections) {
                if (section.textContent.includes('é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆ')) {
                    const parentDiv = section.closest('.section');
                    const paragraph = parentDiv.querySelector('p');
                    
                    if (paragraph && focusPoint) {
                        // OpenAIè©•ä¾¡ã«é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆè©•ä¾¡ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                        if (evaluation.focus_point_comment) {
                            paragraph.innerHTML = evaluation.focus_point_comment;
                        } else {
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                            paragraph.innerHTML = `ä»Šå›ã®é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã¯ <b>${focusPoint}</b> ã§ã—ãŸï¼<br>
                            ç¶™ç¶šã—ã¦æ„è­˜ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šå®‰å…¨ã§å¿«é©ãªé‹è»¢ãŒèº«ã«ã¤ãã¾ã™ğŸš—ï¿½`;
                        }
                    } else {
                        paragraph.innerHTML = 'æ¬¡å›ã¯é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼ğŸš—';
                    }
                    break;
                }
            }
        }

        function showErrorMessage(message) {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            const loadingSection = document.getElementById('loading-section');
            if (loadingSection) {
                loadingSection.style.display = 'none';
            }
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ç°¡å˜ãªæ–¹æ³•
            const mainElement = document.querySelector('.main');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'background-color: #ffebee; color: #c62828; padding: 10px; margin: 20px; border-radius: 5px; text-align: center;';
            errorDiv.textContent = message;
            mainElement.appendChild(errorDiv);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const savedSessionData = localStorage.getItem('lastSessionData');
            if (savedSessionData) {
                try {
                    const sessionData = JSON.parse(savedSessionData);
                    displaySessionResults(sessionData);
                    
                    // AIè©•ä¾¡ã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
                    if (currentSessionId) {
                        await generateAndDisplayAIEvaluation(currentSessionId, selectedFocusPoint);
                    }
                    
                    localStorage.removeItem('lastSessionData');
                } catch (e) {
                    console.error('Failed to parse saved session data:', e);
                    showErrorMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } else {
                console.warn('No session data found in localStorage');
                showErrorMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>
